<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¨æœŸå¾‹åˆ†æ | Cosmic Neural Network v6.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@300;500;700&family=Shippori+Mincho:wght@400;600&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* --- TOKENS --- */
        :root {
            --c-bg: #020205;
            --c-accent: #00f0ff;
            --c-accent-dim: rgba(0, 240, 255, 0.1);
            --c-card-bg: rgba(12, 18, 30, 0.85);
            --c-border: rgba(0, 240, 255, 0.25);
            --font-main: 'Noto Sans JP', sans-serif;
            --font-serif: 'Shippori Mincho', serif;
            --font-tech: 'Rajdhani', sans-serif;
        }

        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background-color: var(--c-bg); font-family: var(--font-main); color: #fff; }

        /* --- LAYOUT --- */
        #canvas-wrapper { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; pointer-events: none; }
        #app-layer { position: absolute; z-index: 10; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */
        header { padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); pointer-events: auto; }
        .brand h1 { font-family: var(--font-serif); font-size: 1.5rem; margin: 0; letter-spacing: 0.15em; background: linear-gradient(to right, #fff, #88ccee); -webkit-background-clip: text; color: transparent; }
        .nav-btn { background: rgba(0,0,0,0.5); border: 1px solid #334; color: #889; padding: 5px 15px; font-family: var(--font-tech); cursor: pointer; transition: 0.3s; }
        .nav-btn:hover { border-color: var(--c-accent); color: var(--c-accent); }

        /* --- INPUT PANEL --- */
        #input-container {
            position: absolute; top: 50%; right: 5%; transform: translateY(-50%);
            width: 340px; background: rgba(10, 15, 25, 0.9); backdrop-filter: blur(20px);
            border: 1px solid var(--c-accent-dim); border-left: 2px solid var(--c-accent);
            padding: 40px 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            transition: opacity 0.5s; pointer-events: auto;
        }
        .form-label { display: block; font-family: var(--font-tech); font-size: 0.7rem; color: #889; margin-bottom: 5px; letter-spacing: 0.15em; }
        .form-input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #334; color: #fff; padding: 10px; font-family: var(--font-tech); font-size: 1.1rem; outline: none; margin-bottom: 20px; transition: 0.3s; }
        .form-input:focus { border-color: var(--c-accent); background: rgba(0, 20, 30, 0.8); }
        .submit-btn { width: 100%; padding: 15px; background: linear-gradient(90deg, transparent, var(--c-accent-dim), transparent); border: 1px solid var(--c-accent); color: var(--c-accent); font-family: 'Cinzel'; font-weight: 700; cursor: pointer; transition: 0.3s; letter-spacing: 0.2em; }
        .submit-btn:hover { background: var(--c-accent); color: #000; box-shadow: 0 0 30px var(--c-accent); }

        /* --- SYNCHRO OVERLAY (Loading) --- */
        #synchro-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }
        .synchro-text { font-family: var(--font-tech); font-size: 2rem; color: var(--c-accent); letter-spacing: 0.5em; text-shadow: 0 0 20px var(--c-accent); }
        .synchro-sub { font-family: var(--font-serif); font-size: 0.9rem; color: #fff; margin-top: 10px; letter-spacing: 0.2em; opacity: 0.8; }

        /* --- RESULT PANEL --- */
        #result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 3, 5, 0.9); z-index: 20;
            display: flex; flex-direction: column; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.8s;
            backdrop-filter: blur(10px);
        }
        #result-overlay.active { opacity: 1; pointer-events: auto; }

        .result-scroll { width: 100%; max-width: 1200px; height: 100%; overflow-y: auto; padding: 40px 20px 120px 20px; }
        .result-scroll::-webkit-scrollbar { width: 6px; }
        .result-scroll::-webkit-scrollbar-thumb { background: #334; border-radius: 3px; }

        /* DASHBOARD (Top) */
        .dashboard-box {
            border: 1px solid #334455; background: rgba(5, 10, 20, 0.6);
            border-radius: 8px; padding: 30px; margin-bottom: 40px;
        }
        .dash-title { font-size: 0.9rem; color: #8899aa; border-bottom: 1px solid #334; padding-bottom: 10px; margin-bottom: 20px; }
        .param-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; }
        .param-item { margin-bottom: 5px; }
        .param-head { display: flex; justify-content: space-between; font-size: 0.85rem; color: #fff; margin-bottom: 5px; }
        .param-bar-bg { width: 100%; height: 4px; background: #223; border-radius: 2px; overflow: hidden; }
        .param-bar-fill { height: 100%; background: var(--c-accent); width: 0%; transition: width 1.5s ease-out; box-shadow: 0 0 8px var(--c-accent); }
        .param-meta { font-family: var(--font-tech); font-size: 0.7rem; color: #667; margin-top: 3px; display: flex; justify-content: space-between; }

        /* 13 GRID (Bottom) */
        .grid-header { font-family: 'Cinzel'; text-align: center; color: #667; letter-spacing: 0.3em; margin: 40px 0 20px 0; border-top: 1px dashed #334; padding-top: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .info-card {
            background: var(--c-card-bg); border: 1px solid var(--c-border);
            border-radius: 4px; padding: 20px; display: flex; flex-direction: column; gap: 10px;
            transition: transform 0.3s;
        }
        .info-card:hover { border-color: #fff; transform: translateY(-3px); }
        .card-head { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
        .card-name { font-family: var(--font-serif); font-size: 1.1rem; color: #fff; }
        .card-tag { font-size: 0.7rem; background: #112; color: var(--c-accent); border: 1px solid var(--c-accent); padding: 2px 8px; border-radius: 10px; }
        .card-val { font-family: var(--font-tech); font-size: 1rem; color: #ccc; }
        .card-desc { font-size: 0.85rem; line-height: 1.6; color: #ddd; text-align: justify; }
        .card-adv { font-size: 0.8rem; color: #9ab; margin-top: auto; padding-top: 10px; border-top: 1px dashed #334; }

        /* FOOTER */
        .action-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #05080c; border-top: 1px solid #334;
            padding: 15px; display: flex; justify-content: center; gap: 15px; z-index: 30;
        }
        .action-btn { background: transparent; border: 1px solid #556; color: #889; padding: 10px 30px; font-family: var(--font-tech); cursor: pointer; transition: 0.2s; }
        .action-btn:hover { border-color: var(--c-accent); color: var(--c-accent); }

        /* START SCREEN */
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: rgba(2,2,5,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-family:'Shippori Mincho'; font-size:2.5rem; color:#fff;">å‘¨æœŸå¾‹åˆ†æ</h1>
        <p style="font-family:'Rajdhani'; letter-spacing:0.3em; color:var(--c-accent); margin-bottom:40px;">COSMIC NEURAL NETWORK v6.0</p>
        <button class="submit-btn" style="width:auto; padding:15px 50px;" onclick="app.init()">INITIALIZE SYSTEM</button>
    </div>

    <div id="canvas-wrapper"></div>

    <div id="app-layer">
        <header>
            <div class="brand"><h1>å‘¨æœŸå¾‹åˆ†æ</h1></div>
            <button class="nav-btn" onclick="app.audio.toggle()" id="btn-audio">AUDIO: ON</button>
        </header>

        <div id="input-container">
            <label class="form-label">Birth Date</label>
            <input type="date" id="inp-date" class="form-input" value="1995-08-08">
            <label class="form-label">Birth Time</label>
            <input type="time" id="inp-time" class="form-input" value="12:00">
            <label class="form-label">Location</label>
            <select id="inp-city" class="form-input"></select>
            <button class="submit-btn" onclick="app.startSequence()">START ANALYSIS</button>
        </div>

        <div id="synchro-overlay">
            <div class="synchro-text">TUNING...</div>
            <div class="synchro-sub">Aligning Vectors with Cosmic Cycles</div>
        </div>

        <div id="result-overlay">
            <div class="result-scroll" id="capture-target">
                <div class="dashboard-box">
                    <div class="dash-title">ã‚ãªãŸã®ç¾åœ¨ä½ç½® (ã‚µã‚¤ã‚¯ãƒ«é€²è¡Œåº¦ã‚¤ãƒ¡ãƒ¼ã‚¸)</div>
                    <div class="param-grid" id="param-grid"></div>
                </div>

                <div class="grid-header">SOURCE CODE: 13 DIMENSIONS</div>
                <div class="grid-container" id="grid-container"></div>
            </div>

            <div class="action-bar">
                <button class="action-btn" onclick="app.export()">ğŸ“· SAVE IMAGE</button>
                <button class="action-btn" onclick="app.reset()">â†º RESET</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        /* --- DATA & LOGIC --- */
        const DICT = {
            kyusei: {
                "ä¸€ç™½æ°´æ˜Ÿ": { tag: "æ€è€ƒ", desc: "æ°´ã®ã‚ˆã†ã«æŸ”è»Ÿã§ç§˜å¯†ä¸»ç¾©çš„ãªçŸ¥æ€§æ´¾ã€‚", advice: "è£æ–¹ã‚„å‚è¬€ã¨ã—ã¦æˆ¦ç•¥ã‚’ç·´ã‚‹ã®ãŒå‰ã€‚" },
                "äºŒé»’åœŸæ˜Ÿ": { tag: "åŸºç›¤", desc: "å¤§åœ°ã®ã‚ˆã†ãªåŒ…å®¹åŠ›ã¨ç€å®Ÿãªè‚²æˆèƒ½åŠ›ã€‚", advice: "æ€¥ãŒãšã€Œç¶™ç¶šã€ã‚’æ­¦å™¨ã«ã—ã¦ãã ã•ã„ã€‚" },
                "ä¸‰ç¢§æœ¨æ˜Ÿ": { tag: "åˆå‹•", desc: "é›·ã®ã‚ˆã†ãªç¬ç™ºåŠ›ã¨ãƒ‘ã‚¤ã‚ªãƒ‹ã‚¢ç²¾ç¥ã€‚", advice: "ã‚¹ã‚¿ãƒ¼ãƒˆãƒ€ãƒƒã‚·ãƒ¥ã¯æœ€å¼·ã€‚è©°ã‚ã¯ä»–è€…ã«ä»»ã›ã¦ã€‚" },
                "å››ç·‘æœ¨æ˜Ÿ": { tag: "èª¿æ•´", desc: "é¢¨ã®ã‚ˆã†ã«ç¸ã‚’é‹ã¶ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚¿ãƒ¼ã€‚", advice: "å…«æ–¹ç¾äººã«ãªã‚‰ãšã€ä»˜ãåˆã†äººã‚’çµã‚‹ã“ã¨ã€‚" },
                "äº”é»„åœŸæ˜Ÿ": { tag: "å¸ç‹", desc: "ç ´å£Šã¨å†ç”Ÿã‚’å¸ã‚‹å¼·çƒˆãªã‚«ãƒªã‚¹ãƒã€‚", advice: "ç‹¬å–„çš„ã«ãªã‚‰ã¬ã‚ˆã†ã€å‚è¬€ã‚’ç½®ãã“ã¨ã€‚" },
                "å…­ç™½é‡‘æ˜Ÿ": { tag: "æ±ºæ–­", desc: "å¤©ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’å®¿ã™é«˜æ½”ãªãƒªãƒ¼ãƒ€ãƒ¼ã€‚", advice: "æ­£è«–ã¯äººã‚’å‚·ã¤ã‘ã¾ã™ã€‚å¯›å®¹ã•ã‚’æŒã¤ã“ã¨ã€‚" },
                "ä¸ƒèµ¤é‡‘æ˜Ÿ": { tag: "çµŒæ¸ˆ", desc: "å–œã³ã¨åç©«ã®æ˜Ÿã€‚ãŠé‡‘ã‚’å›ã™ã‚»ãƒ³ã‚¹ã€‚", advice: "æ¥½ã—ã•ã‚’åç›ŠåŒ–ã™ã‚‹ä»•çµ„ã¿ã‚’ä½œã£ã¦ãã ã•ã„ã€‚" },
                "å…«ç™½åœŸæ˜Ÿ": { tag: "æ”¹é©", desc: "å±±ã®ã‚ˆã†ã«å‹•ã˜ãšã€ç¶™æ‰¿ã¨é©æ–°ã‚’è¡Œã†ã€‚", advice: "ä¸€åº¦æ±ºã‚ãŸã‚‰æ­¢ã¾ã‚‰ãªã„çªç ´åŠ›ãŒã‚ã‚Šã¾ã™ã€‚" },
                "ä¹ç´«ç«æ˜Ÿ": { tag: "å…ˆè¦‹", desc: "å¤ªé™½ã®ã‚ˆã†ã«å…¨ã¦ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹æƒ…ç†±å®¶ã€‚", advice: "ç†±ã—ã‚„ã™ãå†·ã‚ã‚„ã™ã„ç‚¹ã«æ³¨æ„ã—ã¦ç¶™ç¶šã‚’ã€‚" }
            },
            jukkan: {
                "ç”²(æœ¨)": { tag: "æœ¬è³ª", desc: "å¤§æ¨¹ã€‚ä¸€æœ¬æ°—ã§å‘ä¸Šå¿ƒãŒå¼·ã„ãƒªãƒ¼ãƒ€ãƒ¼ã€‚", advice: "æŒ«æŠ˜ã«è„†ã„ã®ã§ã€æŸ”è»Ÿæ€§ã‚’æŒã¤ã“ã¨ã€‚" },
                "ä¹™(æœ¨)": { tag: "æœ¬è³ª", desc: "è‰èŠ±ã€‚ç’°å¢ƒé©å¿œåŠ›ãŒé«˜ãç²˜ã‚Šå¼·ã„ã€‚", advice: "å˜ç‹¬ã‚ˆã‚Šçµ„ç¹”ã®åŠ›ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚" },
                "ä¸™(ç«)": { tag: "æœ¬è³ª", desc: "å¤ªé™½ã€‚è£è¡¨ãŒãªãä¸­å¿ƒã«ãªã‚‹å­˜åœ¨ã€‚", advice: "æ°—åˆ†ã®ãƒ ãƒ©ã‚’ä»•äº‹ã«å‡ºã•ãªã„ã“ã¨ã€‚" },
                "ä¸(ç«)": { tag: "æœ¬è³ª", desc: "ç¯ç«ã€‚é‹­ã„æ´å¯ŸåŠ›ã¨å†…ãªã‚‹æƒ…ç†±ã€‚", advice: "çˆ†ç™ºã™ã‚‹å‰ã«å°å‡ºã—ã«ã‚¬ã‚¹æŠœãã‚’ã€‚" },
                "æˆŠ(åœŸ)": { tag: "æœ¬è³ª", desc: "å±±å²³ã€‚å‹•ã˜ãªã„ä¿¡é ¼ã¨ä¿¡ç”¨ã®å¡Šã€‚", advice: "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’è»½ãã™ã‚‹å·¥å¤«ã‚’ã€‚" },
                "å·±(åœŸ)": { tag: "æœ¬è³ª", desc: "ç”°ç•‘ã€‚äººã‚’è‚²ã¦å®Ÿã‚Šã‚’ã‚‚ãŸã‚‰ã™ã€‚", advice: "å™¨ç”¨è²§ä¹ã«ãªã‚‰ã¬ã‚ˆã†å°‚é–€æ€§ã‚’ã€‚" },
                "åºš(é‡‘)": { tag: "æœ¬è³ª", desc: "é‹¼é‰„ã€‚æ”»æ’ƒåŠ›ã¨æ”¹é©åŠ›ã«å„ªã‚Œã‚‹ã€‚", advice: "å©ã‹ã‚Œã¦å¼·ããªã‚‹ã€‚è©¦ç·´ã‚’æ­“è¿ã›ã‚ˆã€‚" },
                "è¾›(é‡‘)": { tag: "æœ¬è³ª", desc: "å®çŸ³ã€‚ç¹Šç´°ã§ç¾æ„è­˜ãŒé«˜ã„ã€‚", advice: "ç£¨ã‹ã‚Œãªã„ã¨è¼ã‹ãªã„ã€‚è‹¦åŠ´ã¯ç ”ç£¨å‰¤ã€‚" },
                "å£¬(æ°´)": { tag: "æœ¬è³ª", desc: "å¤§æµ·ã€‚ã‚¹ã‚±ãƒ¼ãƒ«ãŒå¤§ããè‡ªç”±ã€‚", advice: "ç›®æ¨™ãŒãªã„ã¨æ°¾æ¿«ã™ã‚‹ã€‚å ¤é˜²ã‚’ã€‚" },
                "ç™¸(æ°´)": { tag: "æœ¬è³ª", desc: "é›¨éœ²ã€‚éš…ã€…ã¾ã§è¡Œãæ¸¡ã‚‹çŸ¥æ€§ã€‚", advice: "å¿è€å¼·ã„ãŒã€ç©ã‚‚ã‚Šç©ã‚‚ã£ã¦æ±ºå£Šã›ã¬ã‚ˆã†ã€‚" }
            }
        };

        const CITIES = [
            {name:"Tokyo", tz:9}, {name:"New York", tz:-5}, {name:"London", tz:0}, {name:"Paris", tz:1}
        ];

        const CYCLES = [
            { name: "æœ¨æ˜Ÿ (Jupiter)", days: 4333, color: "#D4AF37" },
            { name: "åœŸæ˜Ÿ (Saturn)", days: 10759, color: "#A9A9A9" },
            { name: "ç«æ˜Ÿ (Mars)", days: 780, color: "#FF4500" },
            { name: "é‡‘æ˜Ÿ (Venus)", days: 584, color: "#FF69B4" },
            { name: "æœˆç›¸ (Moon)", days: 29.53, color: "#F0F8FF" },
            { name: "æ­³å·® (Precession)", days: 9414075, color: "#8A2BE2" }
        ];

        /* --- VISUAL ENGINE (Restored Buckyball & Stars) --- */
        class VisualEngine {
            constructor() {
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.FogExp2(0x020205, 0.0015); // Deep fog
                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 3000);
                this.camera.position.set(0, 30, 50);
                this.camera.lookAt(0, 0, 0);
                
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                document.getElementById('canvas-wrapper').appendChild(this.renderer.domElement);

                this.initScene();
                this.animate();
            }

            initScene() {
                // 1. Core: Buckyball (Icosahedron Wireframe) - Restored!
                const geo = new THREE.IcosahedronGeometry(2.5, 1);
                const mat = new THREE.MeshBasicMaterial({ color: 0x00f0ff, wireframe: true, transparent:true, opacity:0.6 });
                this.core = new THREE.Mesh(geo, mat);
                this.scene.add(this.core);

                // 2. Stars: Galaxy Field - Restored!
                const sGeo = new THREE.BufferGeometry();
                const sCount = 6000;
                const sPos = new Float32Array(sCount * 3);
                for(let i=0; i<sCount*3; i++) sPos[i] = (Math.random()-0.5) * 1500;
                sGeo.setAttribute('position', new THREE.BufferAttribute(sPos, 3));
                const sMat = new THREE.PointsMaterial({color:0xaaccff, size:0.8, transparent:true, opacity:0.8, sizeAttenuation:true});
                this.stars = new THREE.Points(sGeo, sMat);
                this.scene.add(this.stars);

                // 3. Planets (Solar System)
                this.planets = [];
                const pData = [
                    {r:8, s:0.5, c:0xffcc33, sp:0.008}, {r:12, s:0.6, c:0x3366ff, sp:0.006, m:true},
                    {r:16, s:0.4, c:0xff3300, sp:0.005}, {r:24, s:1.8, c:0xcc9966, sp:0.002},
                    {r:32, s:1.5, c:0xddbb88, sp:0.0015, ring:true}
                ];
                pData.forEach(p => {
                    // Ring
                    const ring = new THREE.Mesh(new THREE.RingGeometry(p.r, p.r+0.05, 128), new THREE.MeshBasicMaterial({color:0x445566, side:THREE.DoubleSide, opacity:0.2, transparent:true}));
                    ring.rotation.x = Math.PI/2;
                    this.scene.add(ring);
                    
                    // Pivot & Mesh
                    const pivot = new THREE.Group();
                    const mesh = new THREE.Mesh(new THREE.SphereGeometry(p.s, 32, 32), new THREE.MeshBasicMaterial({color:p.c}));
                    mesh.position.x = p.r;
                    pivot.add(mesh);
                    
                    if(p.m) { // Moon
                        const m = new THREE.Mesh(new THREE.SphereGeometry(0.15,8,8), new THREE.MeshBasicMaterial({color:0xffffff}));
                        m.position.x = 1.2; mesh.add(m);
                    }
                    if(p.ring) { // Saturn Ring
                        const sr = new THREE.Mesh(new THREE.RingGeometry(p.s*1.4, p.s*2.2, 64), new THREE.MeshBasicMaterial({color:0xccaaff, side:THREE.DoubleSide, opacity:0.5, transparent:true}));
                        sr.rotation.x = Math.PI/2.5; mesh.add(sr);
                    }
                    
                    pivot.rotation.y = Math.random() * Math.PI * 2; // Random initial pos
                    this.scene.add(pivot);
                    this.planets.push({pivot, mesh, speed:p.sp});
                });
            }

            animate() {
                requestAnimationFrame(this.animate.bind(this));
                
                // Normal Rotation
                if(!app.isTuning) {
                    this.core.rotation.y += 0.002;
                    this.core.rotation.x += 0.001;
                    this.stars.rotation.y += 0.0003;
                } else {
                    // Tuning Effect: Fast Spin
                    this.core.rotation.y += 0.1;
                    this.core.rotation.x += 0.05;
                    this.stars.rotation.y += 0.002;
                }

                this.planets.forEach(p => p.pivot.rotation.y += p.speed);
                this.renderer.render(this.scene, this.camera);
            }
        }

        /* --- LOGIC --- */
        const Astro = {
            getKyusei: y => {
                let s = 0; String(y).split('').forEach(n=>s+=parseInt(n));
                while(s>9) s=String(s).split('').reduce((a,b)=>parseInt(a)+parseInt(b),0);
                let st = 11-s; if(st>9) st-=9; if(st===0) st=9;
                return ["ä¸€ç™½æ°´æ˜Ÿ","äºŒé»’åœŸæ˜Ÿ","ä¸‰ç¢§æœ¨æ˜Ÿ","å››ç·‘æœ¨æ˜Ÿ","äº”é»„åœŸæ˜Ÿ","å…­ç™½é‡‘æ˜Ÿ","ä¸ƒèµ¤é‡‘æ˜Ÿ","å…«ç™½åœŸæ˜Ÿ","ä¹ç´«ç«æ˜Ÿ"][st-1];
            },
            getJukkan: y => ["åºš(é‡‘)","è¾›(é‡‘)","å£¬(æ°´)","ç™¸(æ°´)","ç”²(æœ¨)","ä¹™(æœ¨)","ä¸™(ç«)","ä¸(ç«)","æˆŠ(åœŸ)","å·±(åœŸ)"][y%10],
            getStats: (bd, days) => {
                const diff = (new Date() - bd)/(1000*60*60*24);
                return { prog: Math.floor((diff%days)/days*100), cycle: Math.floor(diff/days)+1 };
            }
        };

        /* --- APP --- */
        const app = {
            visual: null, isTuning: false,
            init: function() {
                document.getElementById('start-screen').style.opacity = 0;
                setTimeout(()=>document.getElementById('start-screen').style.display='none', 800);
                this.visual = new VisualEngine();
                app.audio.init();
                
                // Init Cities
                const sel = document.getElementById('inp-city');
                CITIES.forEach(c => {
                    let o = document.createElement('option');
                    o.text = c.name; o.value = JSON.stringify(c); sel.add(o);
                });
            },
            
            audio: {
                ctx: null, mute: false,
                init: function() {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AC();
                    this.osc = this.ctx.createOscillator(); this.g = this.ctx.createGain();
                    this.osc.connect(this.g); this.g.connect(this.ctx.destination);
                    this.osc.frequency.value = 55; this.g.gain.value = 0.05; this.osc.start();
                },
                toggle: function() {
                    this.mute = !this.mute;
                    if(this.ctx) this.g.gain.setTargetAtTime(this.mute?0:0.05, this.ctx.currentTime, 0.1);
                    document.getElementById('btn-audio').innerText = this.mute?"AUDIO: OFF":"AUDIO: ON";
                },
                ramp: function() {
                    if(!this.ctx || this.mute) return;
                    this.osc.frequency.linearRampToValueAtTime(110, this.ctx.currentTime + 3); // Frequency up
                },
                reset: function() {
                    if(!this.ctx || this.mute) return;
                    this.osc.frequency.linearRampToValueAtTime(55, this.ctx.currentTime + 1);
                }
            },

            startSequence: function() {
                const date = document.getElementById('inp-date').value;
                if(!date) return;
                
                // 1. Hide Input
                document.getElementById('input-container').style.opacity = 0;
                document.getElementById('input-container').style.pointerEvents = 'none';
                
                // 2. Start Synchro Effect
                this.isTuning = true;
                this.audio.ramp();
                document.getElementById('synchro-overlay').style.opacity = 1;
                
                // 3. Wait & Analyze
                setTimeout(() => {
                    this.analyze(date);
                }, 3000); // 3 seconds tuning
            },

            analyze: function(dateStr) {
                const bd = new Date(dateStr);
                const kyusei = Astro.getKyusei(bd.getFullYear());
                const jukkan = Astro.getJukkan(bd.getFullYear());
                const kData = DICT.kyusei[kyusei];
                const jData = DICT.jukkan[jukkan];

                // Render Dashboard
                const pGrid = document.getElementById('param-grid');
                pGrid.innerHTML = "";
                CYCLES.forEach(c => {
                    const s = Astro.getStats(bd, c.days);
                    pGrid.innerHTML += `
                        <div class="param-item">
                            <div class="param-head">
                                <span style="color:${c.color}">â— ${c.name}</span>
                                <span>${s.prog}%</span>
                            </div>
                            <div class="param-bar-bg"><div class="param-bar-fill" style="width:${s.prog}%; background:${c.color}"></div></div>
                            <div class="param-meta"><span>Cycle #${s.cycle}</span><span>${Math.floor(c.days)} days</span></div>
                        </div>`;
                });

                // Render 13 Grid (Hybrid Logic)
                const grid = document.getElementById('grid-container');
                grid.innerHTML = "";
                const items = [
                    {t:"ä¹æ˜Ÿæ°—å­¦", v:kyusei, ...kData},
                    {t:"åå¹²åäºŒæ”¯", v:jukkan, ...jData},
                    {t:"æœ¨æ˜Ÿä½ç½®", v:"åŒå­åº§", tag:"æ‹¡å¤§", desc:"æƒ…å ±ã¨ç§»å‹•ã®é ˜åŸŸã§ã®ç™ºå±•ã€‚", advice:"ãƒãƒ«ãƒã‚¿ã‚¹ã‚¯æ¨å¥¨ã€‚"},
                    {t:"åœŸæ˜Ÿä½ç½®", v:"é­šåº§", tag:"è©¦ç·´", desc:"ç²¾ç¥çš„åŸºç›¤ã®å†æ§‹ç¯‰ã€‚", advice:"å†…çœã®æ™‚é–“ã‚’ã€‚"},
                    {t:"ç«æ˜Ÿ", v:"Active", tag:"æƒ…ç†±", desc:"è‡ªå·±è¡¨ç¾ã®æ¬²æ±‚ã€‚", advice:"è¡å‹•ã‚’ä½œå“ã¸ã€‚"},
                    {t:"é‡‘æ˜Ÿ", v:"8å¹´å‘¨æœŸ", tag:"ä¾¡å€¤", desc:"é‡‘èãƒ»ç¾æ„è­˜ã®å†è©•ä¾¡ã€‚", advice:"éå»ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ·æ–°ã€‚"},
                    {t:"æœˆç›¸", v:"29.5æ—¥", tag:"æ„Ÿæƒ…", desc:"å†…é¢ãƒã‚¤ã‚ªãƒªã‚ºãƒ ã€‚", advice:"ç›´æ„Ÿã«å¾“ã†ã“ã¨ã€‚"},
                    {t:"ãƒ©ã‚¤ã‚ªãƒ³ã‚ºã‚²ãƒ¼ãƒˆ", v:"Open", tag:"å®‡å®™ç·š", desc:"é«˜æ¬¡ã‚¨ãƒãƒ«ã‚®ãƒ¼æµå…¥ã€‚", advice:"å¤‰åŒ–ã‚’æã‚Œãªã„ã§ã€‚"},
                    {t:"æ­³å·®é‹å‹•", v:"æ°´ç“¶åº§", tag:"æ–‡æ˜", desc:"è‡ªå¾‹åˆ†æ•£å‹ç¤¾ä¼šã¸ã€‚", advice:"å€‹ã®ç¢ºç«‹ã€‚"},
                    {t:"åº§æ¨™", v:dateStr, tag:"åŸç‚¹", desc:"ã‚ãªãŸã®æ™‚é–“IDã€‚", advice:"é‹å‘½ã®èµ·ç‚¹ã€‚"},
                    {t:"ä¸‰å…ƒä¹é‹", v:"ç¬¬ä¹é‹", tag:"æ™‚ä»£", desc:"ç«ã®æ™‚ä»£ã€‚", advice:"å¯è¦–åŒ–ãŒéµã€‚"},
                    {t:"å…«å¦", v:"éœ‡", tag:"è¡Œå‹•", desc:"é›·ã®ã‚ˆã†ãªç¬ç™ºåŠ›ã€‚", advice:"å³æ–­å³æ±ºã€‚"},
                    {t:"Gã‚³ãƒ³ã‚¸ãƒ£ãƒ³ã‚¯ã‚·ãƒ§ãƒ³", v:"é¢¨", tag:"å¤‰é©", desc:"ç‰©è³ªã‹ã‚‰æƒ…å ±ã¸ã€‚", advice:"æ‰€æœ‰ã‚ˆã‚Šå…±æœ‰ã€‚"}
                ];
                
                items.forEach(i => {
                    grid.innerHTML += `
                        <div class="info-card">
                            <div class="card-head">
                                <span class="card-name">${i.t}</span>
                                <span class="card-tag" style="border-color:var(--c-accent); color:var(--c-accent)">${i.tag}</span>
                            </div>
                            <div class="card-val">${i.v}</div>
                            <div class="card-desc">${i.desc}</div>
                            <div class="card-adv">ğŸ’¡ ${i.advice}</div>
                        </div>`;
                });

                // Transition
                this.isTuning = false;
                this.audio.reset();
                document.getElementById('synchro-overlay').style.opacity = 0;
                document.getElementById('result-overlay').classList.add('active');
            },

            reset: function() {
                document.getElementById('result-overlay').classList.remove('active');
                document.getElementById('input-container').style.opacity = 1;
                document.getElementById('input-container').style.pointerEvents = 'auto';
            },
            export: function() {
                html2canvas(document.getElementById('capture-target'), {backgroundColor:'#020305'}).then(c => {
                    const a = document.createElement('a'); a.href=c.toDataURL(); a.download='chart.png'; a.click();
                });
            }
        };
    </script>
</body>
</html>
