<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¨æœŸå¾‹åˆ†æ | Cosmic Neural Network</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@300;500;700&family=Shippori+Mincho:wght@400;600&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- DESIGN TOKENS --- */
        :root {
            --c-bg: #020205;
            --c-accent: #00f0ff;
            --c-accent-dim: rgba(0, 240, 255, 0.1);
            --c-text-main: #ffffff;
            --c-text-sub: #8899aa;
            --c-card-bg: rgba(15, 20, 35, 0.85);
            --c-border: rgba(0, 240, 255, 0.3);
            --font-main: 'Noto Sans JP', sans-serif;
            --font-serif: 'Shippori Mincho', serif;
            --font-tech: 'Rajdhani', sans-serif;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background-color: var(--c-bg); font-family: var(--font-main); color: var(--c-text-main); -webkit-font-smoothing: antialiased; }

        /* --- LAYOUT --- */
        #canvas-wrapper { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; pointer-events: none; }
        #app-layer { position: absolute; z-index: 10; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */
        header { padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); pointer-events: auto; }
        .brand h1 { font-family: var(--font-serif); font-size: 1.5rem; margin: 0; letter-spacing: 0.15em; background: linear-gradient(to right, #fff, #88ccee); -webkit-background-clip: text; color: transparent; }
        .brand span { font-family: 'Cinzel'; font-size: 0.6rem; letter-spacing: 0.3em; color: var(--c-accent); }
        .nav-menu { display: flex; gap: 15px; }
        .nav-btn { background: rgba(0,0,0,0.5); border: 1px solid #334; color: var(--c-text-sub); padding: 6px 12px; font-family: var(--font-tech); font-size: 0.75rem; cursor: pointer; transition: 0.3s; letter-spacing: 0.1em; }
        .nav-btn:hover { border-color: var(--c-accent); color: var(--c-accent); }

        /* --- START OVERLAY --- */
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: rgba(2,2,5,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(15px); transition: opacity 0.8s ease-out; }
        .start-btn { padding: 15px 60px; border: 1px solid var(--c-accent); background: transparent; color: var(--c-accent); font-family: 'Cinzel'; font-size: 1.2rem; letter-spacing: 0.2em; cursor: pointer; transition: 0.4s; position: relative; overflow: hidden; }
        .start-btn:hover { background: var(--c-accent); color: #000; box-shadow: 0 0 40px var(--c-accent); }

        /* --- INPUT PANEL --- */
        #input-container {
            position: absolute; top: 50%; right: 5%; transform: translateY(-50%);
            width: 360px; max-width: 90%;
            background: rgba(10, 15, 25, 0.85); backdrop-filter: blur(20px);
            border: 1px solid var(--c-accent-dim); border-left: 2px solid var(--c-accent);
            padding: 40px 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: auto;
        }
        .form-row { margin-bottom: 25px; }
        .form-label { display: block; font-family: var(--font-tech); font-size: 0.7rem; color: var(--c-text-sub); margin-bottom: 8px; letter-spacing: 0.15em; text-transform: uppercase; }
        .form-input { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #334; color: #fff; padding: 12px; font-family: var(--font-tech); font-size: 1.1rem; outline: none; transition: 0.3s; }
        .form-input:focus { border-color: var(--c-accent); background: rgba(0, 20, 30, 0.6); }
        .submit-btn { width: 100%; padding: 16px; background: linear-gradient(90deg, transparent, var(--c-accent-dim), transparent); border: 1px solid var(--c-accent); color: var(--c-accent); font-family: 'Cinzel'; font-weight: 700; cursor: pointer; transition: 0.3s; letter-spacing: 0.2em; margin-top: 10px; }
        .submit-btn:hover { background: var(--c-accent); color: #000; box-shadow: 0 0 30px var(--c-accent); }

        /* --- RESULT PANEL --- */
        #result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 3, 5, 0.92); z-index: 20;
            display: flex; flex-direction: column; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.6s;
            backdrop-filter: blur(5px);
        }
        #result-overlay.active { opacity: 1; pointer-events: auto; }

        .result-scroll {
            width: 100%; max-width: 1200px; height: 100%; overflow-y: auto;
            padding: 40px 20px 100px 20px;
        }
        .result-scroll::-webkit-scrollbar { width: 6px; }
        .result-scroll::-webkit-scrollbar-thumb { background: #334; border-radius: 3px; }

        /* Summary Header */
        .summary-header { text-align: center; margin-bottom: 50px; border-bottom: 1px solid #334; padding-bottom: 30px; }
        .main-title { font-family: var(--font-serif); font-size: 2.5rem; margin-bottom: 10px; text-shadow: 0 0 20px rgba(255,255,255,0.3); }
        .sub-tag { display: inline-block; padding: 4px 16px; border: 1px solid var(--c-accent); color: var(--c-accent); font-family: var(--font-tech); letter-spacing: 0.2em; font-size: 0.9rem; margin-bottom: 20px; }
        .strategy-box { 
            max-width: 800px; margin: 0 auto; text-align: left; 
            background: linear-gradient(90deg, rgba(0,240,255,0.05), transparent);
            border-left: 4px solid var(--c-accent); padding: 25px;
            font-size: 1.05rem; line-height: 1.8; color: #eef;
        }

        /* 13 GRID LAYOUT */
        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;
            margin-top: 30px;
        }
        .info-card {
            background: var(--c-card-bg); 
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; padding: 25px;
            display: flex; flex-direction: column; gap: 15px;
            transition: transform 0.3s, border-color 0.3s;
            position: relative; overflow: hidden;
        }
        .info-card:hover { border-color: var(--c-accent); transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .card-title { font-family: var(--font-serif); font-size: 1.2rem; font-weight: 600; color: #fff; }
        .card-badge { font-size: 0.7rem; background: rgba(0,240,255,0.1); color: var(--c-accent); padding: 3px 10px; border-radius: 12px; border: 1px solid var(--c-accent); white-space: nowrap; }
        
        .card-value { font-family: var(--font-main); font-size: 0.95rem; color: #ccc; margin-bottom: 5px; opacity: 0.8; }
        .card-text { font-size: 0.9rem; color: #ddd; line-height: 1.7; text-align: justify; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        .card-advice { font-size: 0.9rem; color: #99aab5; margin-top: auto; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 4px; border-left: 2px solid #556677; }
        
        /* Sticky Footer */
        .action-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #05080c; border-top: 1px solid #334;
            padding: 15px; display: flex; justify-content: center; gap: 15px; z-index: 30;
        }
        .action-btn {
            background: transparent; border: 1px solid #556; color: #889; padding: 10px 20px;
            font-family: var(--font-tech); cursor: pointer; transition: 0.2s; min-width: 120px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .action-btn:hover { border-color: var(--c-accent); color: var(--c-accent); background: rgba(0,240,255,0.05); }

        /* MODALS */
        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center; }
        .modal-box { width: 90%; max-width: 600px; max-height: 80vh; background: #111; border: 1px solid #334; padding: 40px; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 1.5rem; color: #555; }
        .history-item { padding: 15px 0; border-bottom: 1px solid #223; display: flex; justify-content: space-between; font-size: 0.9rem; }

        @media (max-width: 768px) {
            #input-container { position: absolute; bottom: 0; right: 0; top: auto; transform: none; width: 100%; border-radius: 20px 20px 0 0; border-left: 1px solid var(--c-accent-dim); }
            .grid-container { grid-template-columns: 1fr; }
            .action-bar { flex-wrap: wrap; }
            .action-btn { flex: 1; }
            .main-title { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-family:'Shippori Mincho'; font-size:2.5rem; margin-bottom:10px; color:#fff;">å‘¨æœŸå¾‹åˆ†æ</h1>
        <p style="font-family:'Rajdhani'; letter-spacing:0.4em; color:var(--c-accent); margin-bottom:50px;">COSMIC NEURAL NETWORK v4.4</p>
        <button class="start-btn" onclick="app.start()">INITIALIZE</button>
    </div>

    <div id="canvas-wrapper"></div>

    <div id="app-layer">
        <header>
            <div class="brand">
                <h1>å‘¨æœŸå¾‹åˆ†æ</h1>
                <span>CNN-ANALYSIS SYSTEM</span>
            </div>
            <div class="nav-menu">
                <button class="nav-btn" onclick="app.ui.toggleHistory()">HISTORY</button>
                <button class="nav-btn" onclick="app.ui.toggleLogic()">LOGIC</button>
                <button class="nav-btn" id="btn-audio" onclick="app.audio.toggle()">MUTE</button>
            </div>
        </header>

        <div id="input-container">
            <div class="form-row">
                <label class="form-label">Birth Date (Coordinate)</label>
                <input type="date" id="inp-date" class="form-input" value="1995-08-08">
            </div>
            <div class="form-row">
                <label class="form-label">Birth Time (Optional)</label>
                <input type="time" id="inp-time" class="form-input" value="12:00">
            </div>
            <div class="form-row">
                <label class="form-label">Location</label>
                <select id="inp-city" class="form-input"></select>
            </div>
            <button class="submit-btn" onclick="app.analyze()">START ANALYSIS</button>
            <div id="status-bar" style="margin-top:15px; text-align:right; font-size:0.7rem; color:var(--c-accent); opacity:0.6;">SYSTEM STANDBY</div>
        </div>

        <div id="result-overlay">
            <div class="result-scroll" id="capture-target">
                <div class="summary-header">
                    <div class="result-type" style="font-family:'Cinzel'; color:#667; font-size:0.8rem; letter-spacing:0.2em; margin-bottom:10px;">DIAGNOSIS RESULT</div>
                    <div class="main-title" id="out-title">ANALYZING...</div>
                    <div class="sub-tag" id="out-type">WAIT</div>
                    <div class="strategy-box" id="out-strategy"></div>
                </div>

                <div class="grid-container" id="out-grid"></div>
            </div>
            
            <div class="action-bar">
                <button class="action-btn" onclick="app.export.image()">ğŸ“· SAVE IMAGE</button>
                <button class="action-btn" onclick="app.export.calendar()">ğŸ“… CALENDAR</button>
                <button class="action-btn" onclick="app.export.sns()">ğŸ¦ X (SHARE)</button>
                <button class="action-btn" onclick="app.ui.reset()">â†º NEW ANALYSIS</button>
            </div>
        </div>
    </div>

    <div id="modal-history" class="modal-wrap">
        <div class="modal-box">
            <span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">Ã—</span>
            <h2 style="color:var(--c-accent); border-bottom:1px solid #334; padding-bottom:10px;">ANALYSIS HISTORY</h2>
            <div id="history-list"></div>
        </div>
    </div>

    <div id="modal-logic" class="modal-wrap">
        <div class="modal-box">
            <span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">Ã—</span>
            <h2 style="color:var(--c-accent);">è§£æãƒ­ã‚¸ãƒƒã‚¯ (v4.4)</h2>
            <p style="color:#ccc; line-height:1.8; margin-top:20px; font-size:0.9rem;">
                æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã€Œ13æ¬¡å…ƒã€ã®ãƒãƒˆãƒªã‚¯ã‚¹ã‚’ç”¨ã„ã¦ã€å˜ç´”ãªå‰å‡¶ã§ã¯ãªãã€Œã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ãƒ™ã‚¯ãƒˆãƒ«ã€ã‚’è¨ˆç®—ã—ã¾ã™ã€‚<br><br>
                æ€§åˆ¥å…¥åŠ›ã¯è¡Œã„ã¾ã›ã‚“ã€‚ä¹æ˜Ÿã‚„æƒ‘æ˜Ÿé…ç½®ã¨ã„ã£ãŸã€Œé­‚ã®è¨­è¨ˆå›³ã€ã«ç”·å¥³å·®ã¯ãªã„ã¨ã„ã†æ€æƒ³ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚<br><br>
                1. <strong>å€‹ã®è³‡è³ª:</strong> ç”Ÿå¹´æœˆæ—¥ã‹ã‚‰ä¹æ˜Ÿãƒ»åå¹²ã‚’ç®—å‡ºã—ã€OSã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç‰¹å®šã€‚<br>
                2. <strong>æ™‚ã®é‹æ°—:</strong> æœ¨æ˜Ÿãƒ»åœŸæ˜Ÿãƒ»ä¸‰å…ƒä¹é‹ã‹ã‚‰ã€ç¾åœ¨å¹ã„ã¦ã„ã‚‹é¢¨å‘ãã‚’è¨ˆç®—ã€‚<br>
                3. <strong>çŸ›ç›¾ã®èª¿åœ:</strong> ã€Œã‚¢ã‚¯ã‚»ãƒ«ã€ã¨ã€Œãƒ–ãƒ¬ãƒ¼ã‚­ã€ãŒåŒæ™‚ã«ç™ºç”Ÿã—ãŸå ´åˆã€ãã‚Œã‚’ã€Œãƒ‰ãƒªãƒ•ãƒˆèµ°è¡Œï¼ˆé«˜åº¦ãªåˆ¶å¾¡ï¼‰ã€ã¨å®šç¾©ã—ã€å…·ä½“çš„æˆ¦ç•¥ã‚’æç¤ºã—ã¾ã™ã€‚
            </p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        /* [DICTIONARY & CITY DATA - Same as v4.2] */
        const DICT = {
            kyusei: {
                "ä¸€ç™½æ°´æ˜Ÿ": { tag: "åŸºç¤æ°—è³ª", desc: "æ°´ã®ã‚ˆã†ã«æŸ”è»Ÿã§ã€ã©ã‚“ãªå™¨ã«ã‚‚åˆã‚ã›ã‚‰ã‚Œã‚‹çŸ¥æ€§æ´¾ã€‚è¡¨é¢ã¯ç©ã‚„ã‹ã§ã™ãŒã€å†…é¢ã«ã¯å¼·ã„èŠ¯ã¨ç§˜å¯†ä¸»ç¾©çš„ãªä¸€é¢ã‚’æŒã¡ã¾ã™ã€‚", advice: "äººè„ˆãŒè³‡ç”£ã§ã™ã€‚è£æ–¹ã‚„å‚è¬€ã¨ã—ã¦ã®ãƒã‚¸ã‚·ãƒ§ãƒ³ã§ã€é™ã‹ã«å…¨ä½“ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã™ã‚‹æˆ¦ç•¥ãŒæœ€ã‚‚æ©Ÿèƒ½ã—ã¾ã™ã€‚" },
                "äºŒé»’åœŸæ˜Ÿ": { tag: "åŸºç¤æ°—è³ª", desc: "å¤§åœ°ã®ã‚ˆã†ãªåŒ…å®¹åŠ›ã¨ã€ç€å®Ÿãªè‚²æˆèƒ½åŠ›ã‚’æŒã¡ã¾ã™ã€‚æ´¾æ‰‹ã•ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€è£ä»˜ã‘ã®ã‚ã‚‹å®Ÿå‹™èƒ½åŠ›ã§å‘¨å›²ã‹ã‚‰çµ¶å¤§ãªä¿¡é ¼ã‚’å¾—ã¾ã™ã€‚", advice: "æ€¥æ¿€ãªå¤‰åŒ–ã‚ˆã‚Šã‚‚ã€Œç¶™ç¶šã€ãŒæ­¦å™¨ã«ãªã‚Šã¾ã™ã€‚æ—¢å­˜äº‹æ¥­ã®æ”¹å–„ã‚„ã€ãƒãƒ¼ãƒ ã®ãƒ¡ãƒ³ã‚¿ãƒ¼å½¹ã‚’è²·ã£ã¦å‡ºã¦ãã ã•ã„ã€‚" },
                "ä¸‰ç¢§æœ¨æ˜Ÿ": { tag: "åŸºç¤æ°—è³ª", desc: "é›·ã®ã‚ˆã†ãªç¬ç™ºåŠ›ã¨ã€æ–°ã—ã„ã‚‚ã®å¥½ãã®ãƒ‘ã‚¤ã‚ªãƒ‹ã‚¢ç²¾ç¥ã‚’æŒã¡ã¾ã™ã€‚å£°ãŒå¤§ããã€ç™ºä¿¡åŠ›ãŒã‚ã‚Šã€ãƒ ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚«ãƒ¼ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚", advice: "ã‚¹ã‚¿ãƒ¼ãƒˆãƒ€ãƒƒã‚·ãƒ¥ã¯æœ€å¼·ã§ã™ãŒã€è©°ã‚ã®ç”˜ã•ã«æ³¨æ„ã€‚ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‡ºã—ãŸã‚‰ã€å®Ÿå‹™ã¯å¾—æ„ãªäººã«ä»»ã›ã‚‹åˆ†æ¥­ä½“åˆ¶ã‚’ã€‚" },
                "å››ç·‘æœ¨æ˜Ÿ": { tag: "åŸºç¤æ°—è³ª", desc: "é¢¨ã®ã‚ˆã†ã«è»½ã‚„ã‹ã§ã€äººã®ç¸ã‚’é‹ã¶ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚¿ãƒ¼ã€‚ä¿¡ç”¨ã¨èª¿å’Œã‚’é‡ã‚“ã˜ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ“ã‚¸ãƒã‚¹ã‚„ä»²ä»‹æ¥­ã§æ‰èƒ½ãŒé–‹èŠ±ã—ã¾ã™ã€‚", advice: "ã€Œæ–­ã‚Œãªã„ã€ãŒå¼±ç‚¹ã«ãªã‚ŠãŒã¡ã€‚å…«æ–¹ç¾äººã«ãªã‚‰ãšã€é‡è¦ãªãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼ˆå–å¼•å…ˆï¼‰ã‚’çµã‚Šè¾¼ã‚€å‹‡æ°—ã‚’æŒã£ã¦ãã ã•ã„ã€‚" },
                "äº”é»„åœŸæ˜Ÿ": { tag: "åŸºç¤æ°—è³ª", desc: "è…æ•—ã¨å†ç”Ÿã‚’å¸ã‚‹ã€å¼·çƒˆãªã‚«ãƒªã‚¹ãƒæ€§ã€‚ã‚¼ãƒ­ã‹ã‚‰ã‚¤ãƒã‚’ç”Ÿã¿å‡ºã™åŠ›ã€ã‚ã‚‹ã„ã¯ã©ã‚“åº•ã‹ã‚‰é€™ã„ä¸ŠãŒã‚‹åŠ›ãŒãšã°æŠœã‘ã¦ã„ã¾ã™ã€‚", advice: "ãƒˆãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§å‘¨å›²ã‚’å¼•ã£å¼µã‚‹ã¹ãã§ã™ã€‚ã‚ãªãŸã®è¿·ã„ã¯çµ„ç¹”ã®è¿·ã„ã«ãªã‚Šã¾ã™ã€‚ç‹¬å–„çš„ã«ãªã‚‰ã¬ã‚ˆã†ã€å‚è¬€ã‚’ä¸€äººç½®ã„ã¦ãã ã•ã„ã€‚" },
                "å…­ç™½é‡‘æ˜Ÿ": { tag: "åŸºç¤æ°—è³ª", desc: "å¤©ï¼ˆå®‡å®™ï¼‰ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’å®¿ã™ã€é«˜æ½”ãªãƒªãƒ¼ãƒ€ãƒ¼ã€‚å®Œç’§ä¸»ç¾©ã§è²¬ä»»æ„ŸãŒå¼·ãã€å¦¥å”ã‚’è¨±ã•ãªã„ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã™ã€‚", advice: "æ­£è«–ã¯äººã‚’å‚·ã¤ã‘ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚éƒ¨ä¸‹ã‚„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«ã¯ã€ã‚ãªãŸã®7å‰²ã®å®Œæˆåº¦ã§OKã‚’å‡ºã™å¯›å®¹ã•ã‚’æŒã¤ã¨çµ„ç¹”ãŒå›ã‚Šã¾ã™ã€‚" },
                "ä¸ƒèµ¤é‡‘æ˜Ÿ": { tag: "åŸºç¤æ°—è³ª", desc: "å–œã³ã¨åç©«ã®æ˜Ÿã€‚è©±è¡“ã«å„ªã‚Œã€äººã‚’æ¥½ã—ã¾ã›ãªãŒã‚‰ãŠé‡‘ã‚’å›ã™å¤©æ‰çš„ãªã‚»ãƒ³ã‚¹ã‚’æŒã¡ã¾ã™ã€‚é£²é£Ÿã‚„ã‚¨ãƒ³ã‚¿ãƒ¡ã«å¼·ã„é©æ€§ã€‚", advice: "ã€Œæ¥½ã—ã•ã€ã‚’åç›ŠåŒ–ã™ã‚‹ä»•çµ„ã¿ã‚’ä½œã£ã¦ãã ã•ã„ã€‚ãŸã ã—ã€å£ãŒç½ã„ã™ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ãŸã‚ã€å¥‘ç´„æ›¸å‘¨ã‚Šã¯æ…é‡ã«ã€‚" },
                "å…«ç™½åœŸæ˜Ÿ": { tag: "åŸºç¤æ°—è³ª", desc: "é«˜ã„å±±ã®ã‚ˆã†ã«ã©ã£ã—ã‚Šæ§‹ãˆã€å‹•ãã¹ãæ™‚ã«å‹•ãæ”¹é©è€…ã€‚ç¾çŠ¶ç¶­æŒã‚’è‰¯ã—ã¨ã›ãšã€ç¶™æ‰¿ã¨é©æ–°ã‚’åŒæ™‚ã«è¡Œã†å½¹å‰²ãŒã‚ã‚Šã¾ã™ã€‚", advice: "å‹•ãã¾ã§ã®è…°ã¯é‡ã„ã§ã™ãŒã€ä¸€åº¦æ±ºã‚ãŸã‚‰æ­¢ã¾ã‚Šã¾ã›ã‚“ã€‚äº‹æ¥­æ‰¿ç¶™ã‚„ã€çµ„ç¹”ã®å†ç·¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æœ¬é ˜ã‚’ç™ºæ®ã—ã¾ã™ã€‚" },
                "ä¹ç´«ç«æ˜Ÿ": { tag: "åŸºç¤æ°—è³ª", desc: "å¤ªé™½ã®ã‚ˆã†ã«æ˜ã‚‹ãã€å…¨ã¦ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹æƒ…ç†±å®¶ã€‚ç›´æ„ŸåŠ›ã¨ç¾çš„ã‚»ãƒ³ã‚¹ã«å„ªã‚Œã€æ™‚ä»£ã®å…ˆã‚’èª­ã‚€èƒ½åŠ›ãŒã‚ã‚Šã¾ã™ã€‚", advice: "ç†±ã—ã‚„ã™ãå†·ã‚ã‚„ã™ã„ç‚¹ãŒãƒªã‚¹ã‚¯ã€‚çŸ­æœŸæ±ºæˆ¦å‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚„ã€ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«é‡è¦–ã®ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°æˆ¦ç•¥ã«æ³¨åŠ›ã—ã¦ãã ã•ã„ã€‚" }
            },
            jukkan: {
                "ç”²(æœ¨)": { tag: "æœ¬è³ªID", desc: "å¤§æ¨¹ã€‚ä¸€æœ¬æ°—ã§å‘ä¸Šå¿ƒãŒå¼·ã„ã€‚æ›²ãŒã£ãŸã“ã¨ãŒå«Œã„ãªãƒªãƒ¼ãƒ€ãƒ¼æ°—è³ªã€‚", advice: "æŒ«æŠ˜ã«è„†ã„ã®ã§ã€æŸ”è»Ÿæ€§ã‚’æŒã¤ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨çµ„ã‚€ã“ã¨ã€‚" },
                "ä¹™(æœ¨)": { tag: "æœ¬è³ªID", desc: "è‰èŠ±ã€‚ç’°å¢ƒé©å¿œåŠ›ãŒé«˜ãã€ç²˜ã‚Šå¼·ã„äº¤æ¸‰äººã€‚ã©ã“ã§ã‚‚æ ¹ã‚’å¼µã‚Œã‚‹ã€‚", advice: "å˜ç‹¬ã‚ˆã‚Šçµ„ç¹”ã®åŠ›ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚" },
                "ä¸™(ç«)": { tag: "æœ¬è³ªID", desc: "å¤ªé™½ã€‚è£è¡¨ãŒãªãã€ãã“ã«ã„ã‚‹ã ã‘ã§ä¸­å¿ƒã«ãªã‚‹ã‚«ãƒªã‚¹ãƒã€‚", advice: "æ°—åˆ†ã®ãƒ ãƒ©ã‚’ä»•äº‹ã«å‡ºã•ãªã„ã“ã¨ãŒä¿¡é ¼ã®éµã€‚" },
                "ä¸(ç«)": { tag: "æœ¬è³ªID", desc: "ç¯ç«ã€‚æ´å¯ŸåŠ›ãŒé‹­ãã€å†…é¢ã«æƒ…ç†±ã‚’ç§˜ã‚ã‚‹å‚è¬€ã‚¿ã‚¤ãƒ—ã€‚", advice: "çˆ†ç™ºã™ã‚‹å‰ã«å°å‡ºã—ã«ã‚¬ã‚¹æŠœãã‚’ã€‚" },
                "æˆŠ(åœŸ)": { tag: "æœ¬è³ªID", desc: "å±±å²³ã€‚å‹•ã˜ãªã„åŒ…å®¹åŠ›ã€‚ä¿¡é ¼ã¨ä¿¡ç”¨ã®å¡Šã§ã€äººãŒé›†ã¾ã‚‹ã€‚", advice: "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®é‡ã•ãŒæ©Ÿä¼šæå¤±ã«ãªã‚‰ã¬ã‚ˆã†æ³¨æ„ã€‚" },
                "å·±(åœŸ)": { tag: "æœ¬è³ªID", desc: "ç”°ç•‘ã€‚äººã‚’è‚²ã¦ã€å®Ÿã‚Šã‚’ã‚‚ãŸã‚‰ã™è‚²æˆè€…ã€‚æ•™è‚²äº‹æ¥­ã«é©æ€§ã€‚", advice: "å™¨ç”¨è²§ä¹ã«ãªã‚‰ã¬ã‚ˆã†å°‚é–€æ€§ã‚’æŒã¤ã“ã¨ã€‚" },
                "åºš(é‡‘)": { tag: "æœ¬è³ªID", desc: "é‹¼é‰„ã€‚æ”»æ’ƒåŠ›ã¨æ”¹é©åŠ›ã«å„ªã‚Œã‚‹æ­¦é—˜æ´¾ã€‚æ–§ã®ã‚ˆã†ã«åˆ‡ã‚Šæ‹“ãã€‚", advice: "å©ã‹ã‚Œã¦å¼·ããªã‚‹ã€‚è©¦ç·´ã‚’æ­“è¿ã›ã‚ˆã€‚" },
                "è¾›(é‡‘)": { tag: "æœ¬è³ªID", desc: "å®çŸ³ã€‚ç¹Šç´°ã§ç¾æ„è­˜ãŒé«˜ã„ã€‚ç‰¹åˆ¥æ‰±ã„ã•ã‚Œã‚‹ã“ã¨ã§è¼ãã€‚", advice: "ç£¨ã‹ã‚Œãªã„ã¨è¼ã‹ãªã„ã€‚è‹¦åŠ´ã¯ç ”ç£¨å‰¤ã¨æ€ã†ã“ã¨ã€‚" },
                "å£¬(æ°´)": { tag: "æœ¬è³ªID", desc: "å¤§æµ·ã€‚ã‚¹ã‚±ãƒ¼ãƒ«ãŒå¤§ããã€æµå‹•çš„ã§è‡ªç”±ã€‚æµ·å¤–ã¨ã®ç¸ã€‚", advice: "ç›®æ¨™ãŒãªã„ã¨æ°¾æ¿«ã™ã‚‹ã€‚å ¤é˜²ï¼ˆãƒ«ãƒ¼ãƒ«ï¼‰ã‚’è¨­ã‘ã‚‹ã“ã¨ã€‚" },
                "ç™¸(æ°´)": { tag: "æœ¬è³ªID", desc: "é›¨éœ²ã€‚æ…ˆæ„›ã«æº€ã¡ã€éš…ã€…ã¾ã§è¡Œãæ¸¡ã‚‹çŸ¥æ€§ã€‚ä¼ç”»åŠ›ãŒã‚ã‚‹ã€‚", advice: "å¿è€å¼·ã„ãŒã€ç©ã‚‚ã‚Šç©ã‚‚ã£ã¦æ±ºå£Šã›ã¬ã‚ˆã†ã€‚" }
            }
        };

        const CITIES = {
            asia: [{name:"Tokyo", tz:9, lat:35.68}, {name:"Seoul", tz:9, lat:37.56}, {name:"Beijing", tz:8, lat:39.90}],
            us: [{name:"New York", tz:-5, lat:40.71}, {name:"Los Angeles", tz:-8, lat:34.05}],
            eu: [{name:"London", tz:0, lat:51.50}, {name:"Paris", tz:1, lat:48.85}]
        };

        /* [LOGIC ENGINE] */
        class LogicEngine {
            constructor() { this.state = { jupiter: 'Gemini', gate: true }; }
            getKyusei(y) {
                let sum = 0; String(y).split('').forEach(n => sum += parseInt(n));
                while(sum > 9) sum = String(sum).split('').reduce((a,b)=>parseInt(a)+parseInt(b), 0);
                let star = 11 - sum; if(star > 9) star -= 9; if(star===0) star=9;
                return ["ä¸€ç™½æ°´æ˜Ÿ","äºŒé»’åœŸæ˜Ÿ","ä¸‰ç¢§æœ¨æ˜Ÿ","å››ç·‘æœ¨æ˜Ÿ","äº”é»„åœŸæ˜Ÿ","å…­ç™½é‡‘æ˜Ÿ","ä¸ƒèµ¤é‡‘æ˜Ÿ","å…«ç™½åœŸæ˜Ÿ","ä¹ç´«ç«æ˜Ÿ"][star-1];
            }
            getJukkan(y) { return ["åºš(é‡‘)","è¾›(é‡‘)","å£¬(æ°´)","ç™¸(æ°´)","ç”²(æœ¨)","ä¹™(æœ¨)","ä¸™(ç«)","ä¸(ç«)","æˆŠ(åœŸ)","å·±(åœŸ)"][y % 10]; }
            getMoon(y,m,d) {
                if(m<3){y--;m+=12;}
                let j = (365.25*y) + (30.6*m) + d - 694039.09; j /= 29.53058;
                return parseInt((j-parseInt(j))*29.53);
            }
            analyze(dateStr) {
                const d = new Date(dateStr);
                const y = d.getFullYear(); const m = d.getMonth()+1; const day = d.getDate();
                const kyusei = this.getKyusei(y); const jukkan = this.getJukkan(y); const moonAge = this.getMoon(y,m,day);
                const lastDigit = y % 10;
                
                let strategy = {};
                if([6,7].includes(lastDigit)) { 
                    strategy = { type: "MUTATION (å¤‰ç•°)", title: "ç ´å£Šã¨å†ç”Ÿã®ãƒ¯ãƒ«ãƒ„", body: "ãƒ©ã‚¤ã‚ªãƒ³ã‚ºã‚²ãƒ¼ãƒˆã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨ã‚ãªãŸã®æœ¬è³ªï¼ˆç«ï¼‰ãŒå…±é³´ã—ã¦ã„ã¾ã™ã€‚ä»Šã¯ãƒ­ã‚¸ãƒƒã‚¯ã‚ˆã‚Šã€Œé•å’Œæ„Ÿã€ã‚’ä¿¡ã˜ã¦ã€æ—¢å­˜ã®ãƒ¬ãƒ¼ãƒ«ã‚’ç ´å£Šã—ã€æ–°ã—ã„è»Œé“ã‚’æ•·ãã¹ãã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚", color: "#9D00FF" };
                } else if([0,1,8,9].includes(lastDigit)) {
                    strategy = { type: "CONFLICT (è‘›è—¤)", title: "è©¦ç·´ã®å©å ", body: "æ‹¡å¤§ã—ã‚ˆã†ã¨ã™ã‚‹æœ¨æ˜Ÿã¨ã€å›ºã‚ã‚ˆã†ã¨ã™ã‚‹ã‚ãªãŸã®æ€§è³ªãŒæ‘©æ“¦ã‚’èµ·ã“ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯æ•…éšœã§ã¯ãªãã€Œé›é€ ã€ã§ã™ã€‚å¤–ã«å‡ºã‚‹ã‚ˆã‚Šã€å†…éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã®åˆ·æ–°ï¼ˆå­¦ç¿’ãƒ»çµ„ç¹”åŒ–ï¼‰ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’é›†ä¸­ã—ã¦ãã ã•ã„ã€‚", color: "#ff3366" };
                } else {
                    strategy = { type: "SYNERGY (è¦šé†’)", title: "å®Œå…¨ãªã‚‹è¿½ã„é¢¨", body: "å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå™›ã¿åˆã£ã¦ã„ã¾ã™ã€‚ã‚ãªãŸãŒæ”¾ã¤çŸ¢ã¯ã€é¢¨ã«ä¹—ã£ã¦æƒ³å®šä»¥ä¸Šã®è·é›¢ã¸å±Šãã¾ã™ã€‚é æ…®ã¯ç½ªã§ã™ã€‚ä»Šã¾ã§æ¸©ã‚ã¦ããŸè¨ˆç”»ã‚’ã€ä»Šã™ãå®Ÿè¡Œã«ç§»ã—ã¦ãã ã•ã„ã€‚", color: "#D4AF37" };
                }

                const moonLabel = moonAge==0?"æ–°æœˆ":moonAge==15?"æº€æœˆ":`æœˆé½¢${moonAge}`;
                const jData = DICT.jukkan[jukkan] || DICT.jukkan["ç”²(æœ¨)"];
                const kData = DICT.kyusei[kyusei] || DICT.kyusei["äº”é»„åœŸæ˜Ÿ"];

                const gridData = [
                    { t:"ä¹æ˜Ÿæ°—å­¦", v:kyusei, ...kData },
                    { t:"åå¹²åäºŒæ”¯", v:jukkan, ...jData },
                    { t:"æœˆé½¢", v:moonLabel, tag:"çŸ­æœŸã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³", desc:`å†…é¢çš„ãªæ„Ÿæƒ…ã®æ³¢ã€‚æ½®ã®æº€ã¡å¼•ãã®ã‚ˆã†ã«ã€ä»Šã¯ã€Œ${moonAge<15?"æº€ã¡ã¦ã„ã":"æ‰‹æ”¾ã™"}ã€æ™‚æœŸã§ã™ã€‚`, advice:"ç›´æ„Ÿã«å¾“ã„ã€ç„¡ç†ãªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é¿ã‘ã¦ãã ã•ã„ã€‚" },
                    { t:"ä¸‰å…ƒä¹é‹", v:"ç¬¬ä¹é‹ (ç«)", tag:"æ™‚ä»£ã®æµã‚Œ", desc:"2024å¹´ã‹ã‚‰å§‹ã¾ã£ãŸ20å¹´é–“ã®æ–°æ™‚ä»£ã€‚ç‰©è³ªã‹ã‚‰ç²¾ç¥ãƒ»æƒ…å ±ã¸ä¾¡å€¤ãŒã‚·ãƒ•ãƒˆã—ã¾ã™ã€‚ç«ã¨å¯è¦–åŒ–ã®é‹ã€‚", advice:"ã€Œå¯è¦–åŒ–ã€ã¨ã€ŒçŸ¥ã®å…±æœ‰ã€ãŒæˆåŠŸã®éµã§ã™ã€‚" },
                    { t:"æœ¨æ˜Ÿ", v:"åŒå­åº§æœŸ", tag:"ä¸­æœŸã‚µã‚¤ã‚¯ãƒ«", desc:"æƒ…å ±ã€é€šä¿¡ã€ç§»å‹•ã€ãã—ã¦ã€Œæµ…ãåºƒã„å­¦ã³ã€ã«å¹¸é‹ãŒå®¿ã‚‹1å¹´ã§ã™ã€‚", advice:"ä¸€ã¤ã®ã“ã¨ã«å›ºåŸ·ã›ãšã€ãƒãƒ«ãƒã‚¿ã‚¹ã‚¯ã§å¯èƒ½æ€§ã‚’åºƒã’ã¦ãã ã•ã„ã€‚" },
                    { t:"åœŸæ˜Ÿ", v:"é­šåº§(é€†è¡Œ)", tag:"è©¦ç·´ã¨èª²é¡Œ", desc:"è¦‹ãªã„ãµã‚Šã‚’ã—ã¦ããŸã€Œç²¾ç¥çš„ãªèª²é¡Œã€ã‚„ã€Œéå»ã®ç²¾ç®—ã€ã‚’è¿«ã‚‰ã‚Œã‚‹æ™‚æœŸã€‚", advice:"é€ƒã’ãšã«å‘ãåˆãˆã°ã€å¼·å›ºãªåŸºç›¤ã«ãªã‚Šã¾ã™ã€‚" },
                    { t:"å…«å¦ç›¤", v:"éœ‡ (é›·)", tag:"æ„æ€æ±ºå®šã‚¹ã‚¿ã‚¤ãƒ«", desc:"é›·ã®ã‚ˆã†ãªç¬ç™ºåŠ›ã¨ã€çªç ´åŠ›ã‚’æŒã¤å¦ã€‚ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã®æ°—é‹ã€‚è¿·ã£ãŸã‚‰å‹•ãã€‚", advice:"èµ°ã‚ŠãªãŒã‚‰è€ƒãˆã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã§ã€ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’é‡è¦–ã€‚" },
                    { t:"ç«æ˜Ÿ", v:"ç…å­åº§", tag:"æƒ…ç†±", desc:"è‡ªå·±è¡¨ç¾ã¸ã®æ¬²æ±‚ãŒé«˜ã¾ã£ã¦ã„ã¾ã™ã€‚ãƒ‰ãƒ©ãƒãƒ†ã‚£ãƒƒã‚¯ãªå±•é–‹ã‚’å¥½ã‚€é…ç½®ã€‚", advice:"ã‚ãªãŸã®æƒ…ç†±ã‚’ç‰©èªï¼ˆã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼‰ã«ã—ã¦èªã£ã¦ãã ã•ã„ã€‚" },
                    { t:"é‡‘æ˜Ÿ", v:"8å¹´å‘¨æœŸ", tag:"ä¾¡å€¤è¦³", desc:"8å¹´å‰ã«èµ·ããŸã€Œæ„›ã‚„ãŠé‡‘ã€ã«é–¢ã™ã‚‹å‡ºæ¥äº‹ãŒãƒªãƒã‚¤ãƒãƒ«ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚", advice:"éå»ã®æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¾ä»£ç‰ˆã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã€‚" },
                    { t:"G.CONJUNCTION", v:"é¢¨ã®æ™‚ä»£", tag:"ãƒ‘ãƒ©ãƒ€ã‚¤ãƒ ", desc:"ç¸¦ç¤¾ä¼šï¼ˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰ï¼‰ã‹ã‚‰æ¨ªç¤¾ä¼šï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰ã¸ã®å®Œå…¨ç§»è¡Œã€‚", advice:"æ‰€æœ‰ã™ã‚‹ã‚ˆã‚Šã‚·ã‚§ã‚¢ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ã‚’ã€‚" },
                    { t:"ãƒ©ã‚¤ã‚ªãƒ³ã‚ºã‚²ãƒ¼ãƒˆ", v:"OPEN", tag:"å®‡å®™ç·š", desc:"ã‚·ãƒªã‚¦ã‚¹ã‹ã‚‰ã®é«˜æ¬¡ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒæµå…¥ä¸­ã€‚è¦šé†’ã¨æ··ä¹±ãŒåŒæ™‚ã«èµ·ãã¾ã™ã€‚", advice:"ä½“èª¿ä¸è‰¯ã¯å¥½è»¢åå¿œã€‚ç„¡ç†ã›ãšä¼‘æ¯ã‚’ã€‚" },
                    { t:"æ­³å·®é‹å‹•", v:"æ°´ç“¶åº§", tag:"æ–‡æ˜", desc:"2000å¹´å˜ä½ã®æ–‡æ˜ã®ã‚·ãƒ•ãƒˆã€‚å€‹ã®è‡ªç«‹ã¨å‹æ„›ãŒãƒ†ãƒ¼ãƒã€‚", advice:"å¤ã„æ¨©å¨ã«é ¼ã‚‰ãªã„ç”Ÿãæ–¹ã‚’æ¨¡ç´¢ã—ã¦ã€‚" },
                    { t:"åº§æ¨™ (TIME)", v:dateStr, tag:"åŸç‚¹", desc:"ã‚ãªãŸã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ™‚é–“åº§æ¨™IDã€‚", advice:"å…¨ã¦ã®é‹å‘½ã¯ã“ã®ä¸€ç‚¹ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚" },
                ];

                return { ...strategy, grid: gridData };
            }
        }

        /**
         * ============================================================
         * 3. VISUAL ENGINE (SOLAR SYSTEM EDITION)
         * ============================================================
         */
        class VisualEngine {
            constructor() {
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.FogExp2(0x020205, 0.001);
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
                this.camera.position.z = 40; // ã‚«ãƒ¡ãƒ©ã‚’å°‘ã—å¼•ã
                this.camera.position.y = 10;
                this.camera.lookAt(0,0,0);
                
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                document.getElementById('canvas-wrapper').appendChild(this.renderer.domElement);

                this.planets = [];
                this.initObjects();
                this.animate();
            }

            initObjects() {
                // 1. Central Sun (Core)
                const sunGeo = new THREE.IcosahedronGeometry(2.5, 1);
                const sunMat = new THREE.MeshBasicMaterial({ color: 0xffaa00, wireframe: true, transparent:true, opacity:0.6 });
                this.sun = new THREE.Mesh(sunGeo, sunMat);
                this.scene.add(this.sun);

                // 2. Fixed Star Field (Background)
                const sGeo = new THREE.BufferGeometry();
                const sCount = 6000;
                const sPos = new Float32Array(sCount * 3);
                for(let i=0; i<sCount*3; i++) sPos[i] = (Math.random() - 0.5) * 1000;
                sGeo.setAttribute('position', new THREE.BufferAttribute(sPos, 3));
                const sMat = new THREE.PointsMaterial({color:0xffffff, size:0.7, transparent:true, opacity:0.8, sizeAttenuation:true});
                this.starSystem = new THREE.Points(sGeo, sMat);
                this.scene.add(this.starSystem);

                // 3. Planets Data (Deformed Scale)
                const planetData = [
                    { name: 'Venus', color: 0xffcc33, size: 0.5, dist: 6, speed: 0.008 },
                    { name: 'Earth', color: 0x3366ff, size: 0.6, dist: 9, speed: 0.006, hasMoon: true },
                    { name: 'Mars', color: 0xff3300, size: 0.4, dist: 12, speed: 0.005 },
                    { name: 'Jupiter', color: 0xcc9966, size: 1.8, dist: 18, speed: 0.002 },
                    { name: 'Saturn', color: 0xddbb88, size: 1.5, dist: 24, speed: 0.0015, hasRing: true }
                ];

                // Create Planets
                planetData.forEach(pd => {
                    // Orbit Ring (Visual)
                    const ringGeo = new THREE.RingGeometry(pd.dist, pd.dist+0.05, 128);
                    const ringMat = new THREE.MeshBasicMaterial({color:0x445566, side:THREE.DoubleSide, transparent:true, opacity:0.1});
                    const ring = new THREE.Mesh(ringGeo, ringMat);
                    ring.rotation.x = Math.PI/2;
                    this.scene.add(ring);

                    // Pivot for Rotation
                    const pivot = new THREE.Group();
                    pivot.rotation.x = Math.random() * 0.2; // Slight tilt

                    // Planet Mesh
                    const planetGeo = new THREE.SphereGeometry(pd.size, 32, 32);
                    const planetMat = new THREE.MeshBasicMaterial({color: pd.color});
                    const planet = new THREE.Mesh(planetGeo, planetMat);
                    planet.position.x = pd.dist;
                    pivot.add(planet);

                    // Special Additions
                    let moonPivot = null;
                    if(pd.hasMoon) {
                        moonPivot = new THREE.Group();
                        const moonGeo = new THREE.SphereGeometry(0.15, 16, 16);
                        const moonMat = new THREE.MeshBasicMaterial({color: 0xaaaaaa});
                        const moon = new THREE.Mesh(moonGeo, moonMat);
                        moon.position.x = 1.2; // Distance from Earth
                        moonPivot.add(moon);
                        planet.add(moonPivot); // Add moon pivot to Earth
                    }
                    if(pd.hasRing) {
                        const sRingGeo = new THREE.RingGeometry(pd.size*1.2, pd.size*2, 64);
                        const sRingMat = new THREE.MeshBasicMaterial({color: 0xccaaff, side:THREE.DoubleSide, transparent:true, opacity:0.5});
                        const sRing = new THREE.Mesh(sRingGeo, sRingMat);
                        sRing.rotation.x = Math.PI/2.2;
                        planet.add(sRing);
                    }

                    this.scene.add(pivot);
                    this.planets.push({ pivot, planet, moonPivot, speed: pd.speed, selfRot: Math.random()*0.02 });
                });
            }

            animate() {
                requestAnimationFrame(this.animate.bind(this));
                
                // Sun & Stars Rotation
                this.sun.rotation.y -= 0.002;
                if(this.starSystem) this.starSystem.rotation.y += 0.0001;

                // Planet Animation
                this.planets.forEach(p => {
                    p.pivot.rotation.y += p.speed; // Revolution
                    p.planet.rotation.y += p.selfRot; // Rotation
                    if(p.moonPivot) p.moonPivot.rotation.y += 0.05; // Moon revolution
                });

                this.renderer.render(this.scene, this.camera);
            }
        }

        /* [MAIN CONTROLLER - Same as v4.2] */
        const app = {
            logic: new LogicEngine(), visual: null, data: null,
            audio: {
                ctx: null, muted: false,
                init: function() {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AC();
                    this.osc = this.ctx.createOscillator();
                    this.gain = this.ctx.createGain();
                    this.osc.connect(this.gain); this.gain.connect(this.ctx.destination);
                    this.osc.frequency.value = 55; this.gain.gain.value = 0.05; this.osc.start();
                },
                toggle: function() {
                    this.muted = !this.muted;
                    if(this.ctx) this.gain.gain.setTargetAtTime(this.muted?0:0.05, this.ctx.currentTime, 0.1);
                    document.getElementById('btn-audio').innerText = this.muted ? "AUDIO: OFF" : "AUDIO: ON";
                }
            },
            start: function() {
                document.getElementById('start-screen').style.opacity = 0;
                setTimeout(() => document.getElementById('start-screen').style.display = 'none', 800);
                this.visual = new VisualEngine();
                this.audio.init();
                const sel = document.getElementById('inp-city');
                Object.keys(CITIES).forEach(region => {
                    const optgroup = document.createElement('optgroup'); optgroup.label = region.toUpperCase();
                    CITIES[region].forEach(c => {
                        let opt = document.createElement('option');
                        opt.value = JSON.stringify(c); opt.text = c.name; optgroup.appendChild(opt);
                    });
                    sel.appendChild(optgroup);
                });
            },
            analyze: function() {
                const date = document.getElementById('inp-date').value;
                if(!date) return;
                document.getElementById('input-container').style.opacity = 0;
                document.getElementById('input-container').style.pointerEvents = 'none';
                this.data = this.logic.analyze(date);
                let history = JSON.parse(localStorage.getItem('cnn_hist') || '[]');
                history.unshift({date: new Date().toLocaleDateString(), title: this.data.title});
                localStorage.setItem('cnn_hist', JSON.stringify(history.slice(0,10)));
                setTimeout(() => { this.renderResult(this.data); }, 1000);
            },
            renderResult: function(d) {
                const overlay = document.getElementById('result-overlay');
                document.getElementById('out-title').innerText = d.title;
                document.getElementById('out-type').innerText = d.type;
                document.getElementById('out-type').style.color = d.color;
                document.getElementById('out-type').style.borderColor = d.color;
                document.getElementById('out-strategy').innerText = d.body;
                document.getElementById('out-strategy').style.borderLeftColor = d.color;
                const grid = document.getElementById('out-grid');
                grid.innerHTML = "";
                d.grid.forEach(item => {
                    const card = document.createElement('div');
                    card.className = "info-card";
                    card.innerHTML = `
                        <div class="card-header">
                            <span class="card-title">${item.t}</span>
                            <span class="card-badge" style="color:${d.color}">${item.tag}</span>
                        </div>
                        <div class="card-value">${item.v}</div>
                        <div class="card-text">${item.desc}</div>
                        <div class="card-advice">${item.advice}</div>
                    `;
                    grid.appendChild(card);
                });
                overlay.classList.add('active');
            },
            ui: {
                reset: function() {
                    document.getElementById('result-overlay').classList.remove('active');
                    document.getElementById('input-container').style.opacity = 1;
                    document.getElementById('input-container').style.pointerEvents = 'auto';
                },
                toggleHistory: function() {
                    const el = document.getElementById('modal-history');
                    el.style.display = 'flex';
                    const list = document.getElementById('history-list');
                    const h = JSON.parse(localStorage.getItem('cnn_hist') || '[]');
                    list.innerHTML = h.length ? h.map(i=>`<div class="history-item"><span>${i.date}</span><span style="color:var(--c-accent)">${i.title}</span></div>`).join('') : "<div style='color:#666'>NO HISTORY</div>";
                },
                toggleLogic: function() { document.getElementById('modal-logic').style.display = 'flex'; }
            },
            export: {
                image: function() {
                    const target = document.getElementById('capture-target');
                    html2canvas(target, { backgroundColor: '#020305', scale: 2, useCORS: true }).then(canvas => {
                        const a = document.createElement('a'); a.href = canvas.toDataURL("image/png"); a.download = 'cosmic_analysis.png'; a.click();
                    });
                },
                calendar: function() {
                    if(!app.data) return;
                    const title = encodeURIComponent(`ã€å‘¨æœŸå¾‹æˆ¦ç•¥ã€‘${app.data.title}`);
                    const details = encodeURIComponent(app.data.body);
                    const dStr = new Date().toISOString().replace(/-|:|\.\d+/g, '').slice(0,8);
                    window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dStr}/${dStr}&details=${details}`, '_blank');
                },
                sns: function() {
                    if(!app.data) return;
                    const text = encodeURIComponent(`å‘¨æœŸå¾‹åˆ†æçµæœ: ${app.data.title}\næˆ¦ç•¥: ${app.data.type}\n#CosmicNeuralNetwork`);
                    window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
                }
            }
        };
        window.onclick = function(e) { if(e.target.className === 'modal-wrap') e.target.style.display = 'none'; }
    </script>
</body>
</html>
