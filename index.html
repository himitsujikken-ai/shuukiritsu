<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>周期律分析 | Cosmic Neural Network v36.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@300;500;700&family=Shippori+Mincho:wght@400;600&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* --- CORE DESIGN TOKENS --- */
        :root {
            --c-bg: #020205; --c-accent: #00f0ff; 
            --c-gold: #D4AF37; --c-red: #ff3366; --c-purple: #bb66ff;
            --c-card-bg: rgba(10, 14, 24, 0.95); --c-border: rgba(0, 240, 255, 0.3);
            --c-attack: #ff3366; --c-defense: #4488ff; --c-trans: #bb66ff;
            --f-en: 'Rajdhani', sans-serif; --f-jp: 'Noto Sans JP', sans-serif;
            --f-serif: 'Shippori Mincho', serif;
        }
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background-color: var(--c-bg); font-family: var(--f-jp); color: #fff; }
        
        /* LAYOUT LAYERS */
        #canvas-wrapper { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; pointer-events: none; }
        #app-layer { position: absolute; z-index: 10; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { padding: 20px 40px; display: none; justify-content: space-between; align-items: center; background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent); pointer-events: auto; z-index: 20; }
        .brand h1 { font-family: var(--f-serif); font-weight: 600; font-size: 1.8rem; margin: 0; letter-spacing: 0.2em; background: linear-gradient(to bottom, #ffffff, #aaccff); -webkit-background-clip: text; color: transparent; text-shadow: 0 0 15px rgba(0, 240, 255, 0.4); }
        .nav-btn { background: rgba(0,0,0,0.6); border: 1px solid #334; color: #889; padding: 6px 14px; font-family: var(--f-en); font-size: 0.75rem; cursor: pointer; transition: 0.3s; letter-spacing: 0.1em; }
        .nav-btn:hover { border-color: var(--c-accent); color: var(--c-accent); box-shadow: 0 0 10px rgba(0,240,255,0.2); }

        /* START SCREEN */
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: rgba(2,2,5,0.98); display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s; pointer-events: auto; }
        .opt-btn { background: rgba(0,0,0,0.5); border: 1px solid #334; color: #889; padding: 8px 16px; font-family: var(--f-en); cursor: pointer; transition: 0.3s; }
        .opt-btn.active { border-color: var(--c-accent); color: var(--c-accent); background: rgba(0,240,255,0.1); }
        .submit-btn { width: 100%; padding: 16px; background: linear-gradient(90deg, transparent, rgba(0,240,255,0.15), transparent); border: 1px solid var(--c-accent); color: var(--c-accent); font-family: 'Cinzel', serif; font-weight: 700; font-size: 1rem; letter-spacing: 0.25em; cursor: pointer; transition: 0.4s; }
        .submit-btn:hover { background: var(--c-accent); color: #000; box-shadow: 0 0 40px var(--c-accent); }

        /* INPUT PANEL */
        #input-container { position: absolute; top: 50%; right: 5%; transform: translateY(-50%); width: 360px; background: rgba(8, 12, 20, 0.92); backdrop-filter: blur(20px); border: 1px solid var(--c-border); border-left: 3px solid var(--c-accent); padding: 40px 30px; box-shadow: 0 30px 60px rgba(0,0,0,0.8); transition: opacity 0.6s; z-index: 20; pointer-events: auto; }
        .form-label { display: block; font-family: var(--f-en); font-size: 0.7rem; color: #889; margin-bottom: 6px; letter-spacing: 0.15em; }
        .form-input { width: 100%; background: rgba(0,0,0,0.6); border: 1px solid #334; color: #fff; padding: 12px; font-family: var(--f-en); font-size: 1.1rem; outline: none; margin-bottom: 25px; }
        select.form-input option { background: #050810; color: #fff; }

        /* RESULT OVERLAY */
        #result-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(3, 5, 8, 0.96); z-index: 30; display: flex; flex-direction: column; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.8s; visibility: hidden; }
        #result-overlay.active { opacity: 1; pointer-events: auto; visibility: visible; }
        .result-scroll { width: 100%; max-width: 1100px; height: 100%; overflow-y: auto; padding: 40px 20px 160px 20px; }
        .result-scroll::-webkit-scrollbar { width: 6px; }
        .result-scroll::-webkit-scrollbar-thumb { background: #334; border-radius: 3px; }

        /* DASHBOARD COMPONENTS */
        .dashboard-box { border: 1px solid #334; background: rgba(255,255,255,0.02); border-radius: 4px; padding: 30px; margin-bottom: 40px; }
        
        /* CNL CHART */
        .cnl-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; align-items: end; height: 140px; margin-bottom: 20px; border-bottom:1px solid #223; }
        .cnl-bar-col { display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end; }
        .cnl-bar-fill { width: 100%; background: var(--c-accent); opacity:0.8; transition: height 1s; min-height:2px; }
        .cnl-label { font-family: var(--f-jp); font-size: 0.7rem; color: #889; margin-top: 8px; text-align:center; line-height:1.4; }

        /* PHASE INDICATOR */
        .phase-indicator { margin: 0 auto 30px auto; max-width: 900px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #334; background: rgba(0,0,0,0.3); padding: 15px 30px; border-radius: 4px; }
        .phase-val { font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: 700; letter-spacing: 0.1em; text-shadow: 0 0 10px currentColor; }

        /* PARAMETER BARS */
        .param-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; margin-top: 20px; }
        .param-item { margin-bottom: 5px; }
        .param-head { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px; color: #eee; }
        .param-bar-bg { width: 100%; height: 3px; background: #223; }
        .param-bar-fill { height: 100%; background: var(--c-accent); width: 0%; box-shadow: 0 0 8px var(--c-accent); }

        /* PROCESS LOG */
        .process-log { background: #08080c; border-left: 3px solid #666; padding: 20px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; color: #0f0; margin-bottom: 30px; opacity: 0.95; box-shadow: 0 0 20px rgba(0,0,0,0.5); line-height: 1.6; }
        .log-line { margin-bottom: 8px; border-bottom: 1px dashed #223; padding-bottom: 4px; display:flex; justify-content:space-between; flex-wrap:wrap;}
        .log-key { color: #889; min-width:140px; }
        .log-val { color: var(--c-accent); text-align:right; flex:1; }
        .log-alert { color: var(--c-red); font-weight:bold; }

        /* STRATEGY & GRID */
        .strategy-container { max-width: 900px; margin: 0 auto 40px auto; border-left: 4px solid var(--c-accent); background: linear-gradient(90deg, rgba(0,240,255,0.05), transparent); padding: 30px; }
        .strategy-title { font-family: var(--f-serif); font-size: 1.8rem; margin-bottom: 20px; color: #fff; text-shadow: 0 0 10px rgba(0,240,255,0.3); }
        .strategy-body { font-size: 1.0rem; line-height: 2.2; color: #ddd; text-align: justify; white-space: pre-wrap; font-feature-settings: "palt"; }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top:30px; }
        .info-card { background: var(--c-card-bg); border: 1px solid var(--c-border); padding: 20px; transition:0.3s; display:flex; flex-direction:column; gap:5px; }
        .info-card:hover { transform:translateY(-5px); border-color:#fff; }
        .card-label { font-size:0.75rem; color:#889; letter-spacing:0.1em; }
        .card-value { font-size:1.1rem; color:#fff; font-family:var(--f-serif); font-weight:bold; }
        .card-desc { font-size:0.85rem; color:#aaa; margin-top:5px; line-height:1.5; }

        /* X-DAYS */
        .xday-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 30px; margin-top:30px; }
        .xday-card { background: rgba(15, 12, 5, 0.9); border: 1px solid #443; border-top: 3px solid var(--c-gold); padding: 25px; }
        .xday-date { font-family: 'Cinzel', serif; font-size: 1.8rem; color: #fff; font-weight: 700; text-shadow: 0 0 10px currentColor; }

        /* UTILS - Z-INDEX FIX FOR BUTTONS */
        .action-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(5, 8, 15, 0.95); padding: 20px; display: flex; justify-content: center; gap: 20px; z-index: 200; pointer-events: auto; }
        #synchro-overlay { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:150; pointer-events:none; opacity:0; background:rgba(0,0,0,0.85); transition:opacity 0.8s; }
        .synchro-text { font-family: var(--f-serif); font-size: 2.5rem; color: #fff; letter-spacing: 0.3em; margin-bottom: 15px; text-shadow: 0 0 20px var(--c-accent); animation: pulse 2s infinite; text-align: center; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>

    <div id="start-screen">
        <div style="font-family:'Shippori Mincho', serif; font-size:1.2rem; letter-spacing:0.5em; color:var(--c-gold); margin-bottom:10px; text-shadow:0 0 10px rgba(212,175,55,0.5);">内なる宇宙の可視化</div>
        
        <h1 style="font-family:'Shippori Mincho', serif; font-size:3rem; letter-spacing:0.2em; background:linear-gradient(to bottom, #fff, #aaccff); -webkit-background-clip:text; color:transparent; margin-bottom:10px;">周期律分析</h1>
        <p style="font-family:'Rajdhani'; letter-spacing:0.4em; color:var(--c-accent); margin-bottom:50px; font-size:0.9rem;">COSMIC NEURAL NETWORK v36.0</p>
        
        <div style="display:flex; gap:40px; margin-bottom:40px; z-index:150;">
            <div style="text-align:center;">
                <span style="display:block; font-family:var(--f-en); font-size:0.7rem; color:#667; margin-bottom:10px; letter-spacing:0.2em;">SOUND</span>
                <div style="display:flex; gap:10px;">
                    <button class="opt-btn" onclick="app.setStartAudio(true, event)">ON</button>
                    <button class="opt-btn active" onclick="app.setStartAudio(false, event)">OFF</button>
                </div>
            </div>
        </div>
        <button class="submit-btn" style="width:auto; padding:18px 60px;" onclick="app.init()">INITIALIZE SYSTEM</button>
        <div style="position:absolute; bottom:80px; text-align:center; font-size:0.7rem; color:#556;">v36.0: Full Stars (Elliptical Orbit) & Title Added</div>
    </div>

    <div id="canvas-wrapper"></div>

    <div id="app-layer">
        <header>
            <div class="brand"><h1>周期律分析</h1></div>
            <button class="nav-btn" onclick="app.audio.toggle()" id="btn-audio">AUDIO: OFF</button>
        </header>

        <div id="input-container">
            <label class="form-label">Birth Date</label>
            <input type="date" id="inp-date" class="form-input" value="1995-08-08">
            <label class="form-label">Birth Time</label>
            <input type="time" id="inp-time" class="form-input" value="12:00">
            <label class="form-label">Location</label>
            <select id="inp-city" class="form-input"></select>
            <button class="submit-btn" onclick="app.startSequence()">START ANALYSIS</button>
        </div>

        <div id="synchro-overlay">
            <div class="synchro-text" id="t-sync">意識同調中...</div>
            <div style="font-family:var(--f-en); font-size:0.9rem; color:#aaa; letter-spacing:0.2em;">宇宙サイクルとベクトルを調整しています</div>
        </div>

        <div id="result-overlay">
            <div class="result-scroll" id="capture-target">
                <div style="text-align:center; margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid #223;">
                    <div style="font-family:var(--f-en); font-size:0.75rem; color:var(--c-accent); letter-spacing:0.3em; margin-bottom:5px;">COSMIC COORDINATE ID</div>
                    <div style="font-family:var(--f-en); font-size:2.5rem; font-weight:300; letter-spacing:0.1em;" id="res-birthdate">----.--.--</div>
                </div>

                <div class="phase-indicator" id="phase-box">
                    <div style="font-family:var(--f-en); font-size:0.8rem; color:#889; letter-spacing:0.2em;">CURRENT STRATEGIC PHASE</div>
                    <div class="phase-val" id="phase-val">CALCULATING...</div>
                </div>

                <div class="strategy-container">
                    <div class="strategy-title" id="st-title">ANALYZING...</div>
                    <div class="strategy-body" id="st-body"></div>
                </div>

                <div class="dashboard-box">
                    <div style="font-size:0.9rem; color:#889; margin-bottom:25px; border-bottom:1px solid #223; padding-bottom:10px;">Cosmic Neural Logic (CNL) & Cycles</div>
                    <div class="cnl-grid" id="cnl-chart"></div>
                    <div class="param-grid" id="param-grid"></div>
                </div>

                <div class="process-log" id="cnl-log"></div>

                <div style="font-family:'Cinzel',serif; text-align:center; color:#667; letter-spacing:0.3em; margin:60px 0 30px 0; border-top:1px dashed #334; padding-top:30px;">13 DIMENSIONS</div>
                <div class="grid-container" id="grid-container"></div>

                <div style="font-family:'Cinzel',serif; text-align:center; color:var(--c-gold); letter-spacing:0.3em; margin:60px 0 30px 0; font-size:1.2rem;">X-DAY ANALYSIS</div>
                <div class="xday-container" id="xday-grid"></div>

                <div style="margin:80px auto; max-width:800px; padding:40px; background:rgba(255,255,255,0.02); border:1px solid #334;">
                    <div style="font-family:var(--f-serif); font-size:1.4rem; color:#fff; margin-bottom:20px; border-left:3px solid #888; padding-left:15px;">Cosmic Neural Logic (CNL) v1.0</div>
                    <div style="font-size:0.95rem; line-height:1.9; color:#aaa; margin-bottom:30px; text-align:justify;">
                        矛盾こそが「人間の複雑性」です。本システムは、アクセル（拡大）とブレーキ（収縮）の葛藤を計算し、最適な戦略を導き出します。
                        <br><br>
                        グラフはあなたの現在のエネルギー配分を示します。
                        <br>・木行(Wood) / 火行(Fire): 攻め・拡散・情熱
                        <br>・金行(Metal) / 水行(Water): 守り・収束・知性
                    </div>
                    <div style="background:#000; padding:25px; text-align:center; color:#fff; font-family:'Times New Roman',serif; font-style:italic;">ImpactScore = BaseValue × (1 / √CycleLength) × Resonance</div>
                </div>

                <div style="margin-top:60px; padding:60px 40px; text-align:center; border:1px solid rgba(212,175,55,0.3); background:radial-gradient(circle, rgba(212,175,55,0.05), transparent 70%);">
                    <h3 style="font-family:var(--f-serif); color:var(--c-gold); font-size:1.5rem; margin-bottom:20px;">深層レイヤー (Sound Layer)</h3>
                    <p style="color:#ccc; margin-bottom:30px;">なぜこの時代を選んだのか？ 13次元のさらに奥へ。<br>あなたの名前に秘められた音響周波数が、魂の青写真を解き明かします。</p>
                    <button class="submit-btn" style="width:auto; border-color:var(--c-gold); color:var(--c-gold);" onclick="app.jumpToSound()">🎵 おなまえ音分析 (UNLOCK SOUND)</button>
                </div>
            </div>

            <div class="action-bar">
                <button class="nav-btn" onclick="app.export()">📷 SAVE</button>
                <button class="nav-btn" onclick="app.reset()">↺ RESET</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        const CITY_DB = {
            "asia": [{id:"tokyo",name:"Tokyo",tz:9},{id:"osaka",name:"Osaka",tz:9}],
            "europe": [{id:"london",name:"London",tz:0},{id:"paris",name:"Paris",tz:1}],
            "americas": [{id:"ny",name:"New York",tz:-5},{id:"la",name:"Los Angeles",tz:-8}]
        };
        const CYCLES = [
            {name:"木星 (12y)", days:4333, color:"#D4AF37"}, {name:"土星 (29.5y)", days:10759, color:"#A9A9A9"},
            {name:"火星 (780d)", days:780, color:"#FF4500"}, {name:"金星 (584d)", days:584, color:"#FF69B4"},
            {name:"月相 (29.5d)", days:29.53, color:"#F0F8FF"}
        ];
        
        const DICT_JA = {
            kyusei: {
                "一白水星": "柔軟で秘密主義的な知性派。表面は穏やかですが内面には強い芯を持ちます。",
                "二黒土星": "大地のような包容力と着実な育成能力。派手さはありませんが信頼は厚いです。",
                "三碧木星": "雷のような瞬発力とパイオニア精神。新しいもの好きで発信力があります。",
                "四緑木星": "風のように縁を運ぶコミュニケーター。信用と調和を重んじます。",
                "五黄土星": "破壊と再生を司る帝王の星。強烈なカリスマ性と支配力を持ちます。",
                "六白金星": "天のエネルギーを宿す高潔なリーダー。完璧主義で責任感が強いです。",
                "七赤金星": "喜びと収穫の星。話術に優れ、人を楽しませる才能があります。",
                "八白土星": "山のように動じず、改革を行う星。現状維持を良しとしません。",
                "九紫火星": "太陽のように全てを明らかにする情熱家。直感と美意識に優れます。"
            }
        };

        const Astro = {
            getKyusei: y => {
                let s=0; String(y).split('').forEach(n=>s+=parseInt(n));
                while(s>9)s=String(s).split('').reduce((a,b)=>parseInt(a)+parseInt(b),0);
                let t=11-s; if(t>9)t-=9; if(t===0)t=9;
                return ["一白水星","二黒土星","三碧木星","四緑木星","五黄土星","六白金星","七赤金星","八白土星","九紫火星"][t-1];
            },
            getKyuseiNum: y => {
                let s=0; String(y).split('').forEach(n=>s+=parseInt(n));
                while(s>9)s=String(s).split('').reduce((a,b)=>parseInt(a)+parseInt(b),0);
                let t=11-s; if(t>9)t-=9; if(t===0)t=9; return t;
            },
            getJukkan: y => ["庚(金)","辛(金)","壬(水)","癸(水)","甲(木)","乙(木)","丙(火)","丁(火)","戊(土)","己(土)"][y%10],
            getSocialXDay: (y, m, d) => {
                const seed = (y * 13) + (m * 27) + (d * 7); 
                const offset = (seed % 60) + 14; 
                const targetDate = new Date(); targetDate.setDate(targetDate.getDate() + offset);
                return targetDate.toLocaleDateString('ja-JP', {year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g, '.');
            },
            getPersonalXDay: (y, m, d) => {
                const lp = (y + m + d) % 9 || 9;
                const today = new Date(); today.setDate(today.getDate() + (lp * 3) + (d % 7) + 3);
                return today.toLocaleDateString('ja-JP', {year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g, '.');
            },
            getStats: (b,d) => { const f=(new Date()-b)/(1000*60*60*24); return{p:Math.floor((f%d)/d*100)} },
            
            calculateCNL: (y, m, d) => {
                let scores = { Wood: 10, Fire: 10, Earth: 10, Metal: 10, Water: 10 };
                const kNum = Astro.getKyuseiNum(y);
                
                if([3,4].includes(kNum)) scores.Wood += 40;
                if(kNum === 9) scores.Fire += 40;
                if([2,5,8].includes(kNum)) scores.Earth += 40;
                if([6,7].includes(kNum)) scores.Metal += 40;
                if(kNum === 1) scores.Water += 40;

                if(m>=3 && m<=5) scores.Wood += 20;
                else if(m>=6 && m<=8) scores.Fire += 20;
                else if(m>=9 && m<=11) scores.Metal += 20;
                else scores.Water += 20;

                const max = Math.max(...Object.values(scores));
                const norm = {};
                Object.keys(scores).forEach(k => norm[k] = Math.floor((scores[k] / max) * 100));

                let logs = [];
                const active = scores.Wood + scores.Fire;
                const passive = scores.Metal + scores.Water;
                
                logs.push({k: "【エネルギー均衡値】", v: `能動(陽): ${active} / 受動(陰): ${passive}`});

                if(active > 50 && passive > 50) {
                    logs.push({k: "⚠ 葛藤検出", v: "「拡大」と「収縮」が同時に高まっています", alert: true});
                    logs.push({k: "【最適化戦略】", v: "アクセルとブレーキの同時踏みに注意。基盤固め(Structure)を優先してください。"});
                    logs.push({k: "【行動指針】", v: "焦りを捨て、内面の充実にエネルギーを使うべき時です。"});
                } else if(active > passive * 1.5) {
                    logs.push({k: "【ベクトル判定】", v: "推進力優位 (Forward Thrust)"});
                    logs.push({k: "【リスク評価】", v: "摩擦係数低下。スピード重視で突破すべき局面です。"});
                } else if(passive > active * 1.5) {
                    logs.push({k: "【ベクトル判定】", v: "内部蓄積優位 (Consolidation)"});
                    logs.push({k: "【推奨アクション】", v: "今は潮目を待つ時。基礎工事と学習に最適です。"});
                } else {
                     logs.push({k: "【ステータス】", v: "均衡状態。標準的なペースで進行してください。"});
                }
                return { norm: norm, logs: logs };
            }
        };

        const app = {
            audioEnabled: false,
            audio: {
                ctx:null, g:null, f:null, mute:false, humSource:null, humGain:null,
                init: function() {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AC();
                    // Auto-resume for reliable playback
                    if (this.ctx.state === 'suspended') { this.ctx.resume(); }

                    const b = this.ctx.createBuffer(1, 44100, 44100);
                    const d = b.getChannelData(0);
                    for(let i=0; i<44100; i++) d[i] = (Math.random()*2-1)*0.5;
                    this.buffer = b;

                    this.f = this.ctx.createBiquadFilter(); 
                    this.f.type = 'lowpass'; 
                    this.f.frequency.value = 100;
                    this.g = this.ctx.createGain(); 
                    this.g.gain.value = 0.6; 
                    this.f.connect(this.g); 
                    this.g.connect(this.ctx.destination);
                },
                toggle: function() {
                    if(this.ctx) this.g.gain.setTargetAtTime(this.g.gain.value ? 0 : 0.6, this.ctx.currentTime, 0.1);
                },
                playBlip: function() {
                    if(!this.ctx) return;
                    if(this.ctx.state === 'suspended') this.ctx.resume();
                    const osc = this.ctx.createOscillator();
                    const g = this.ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(1200, this.ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(2000, this.ctx.currentTime + 0.1);
                    g.gain.setValueAtTime(0.3, this.ctx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.15);
                    osc.connect(g); g.connect(this.ctx.destination);
                    osc.start(); osc.stop(this.ctx.currentTime + 0.2);
                },
                // START IDLE HUM (Brown Noise Style @ 60Hz Rumble - CONFIRMED WORKING)
                startHum: function() {
                    if(!this.ctx) return;
                    if(this.humSource) return; // Already playing
                    
                    // Use White Noise Buffer -> Lowpass @ 60Hz to simulate Brown Noise Rumble
                    this.humSource = this.ctx.createBufferSource();
                    this.humSource.buffer = this.buffer;
                    this.humSource.loop = true;

                    // Dedicated rumble filter
                    const rumbleFilter = this.ctx.createBiquadFilter();
                    rumbleFilter.type = 'lowpass';
                    rumbleFilter.frequency.value = 60; // 60Hz is audible and deep
                    
                    this.humGain = this.ctx.createGain();
                    this.humGain.gain.setValueAtTime(0, this.ctx.currentTime);
                    this.humGain.gain.linearRampToValueAtTime(2.0, this.ctx.currentTime + 2.0); // High gain needed for filtered noise
                    
                    this.humSource.connect(rumbleFilter);
                    rumbleFilter.connect(this.humGain);
                    this.humGain.connect(this.ctx.destination);
                    
                    this.humSource.start();
                },
                stopHum: function() {
                    if(this.humSource && this.humGain) {
                        this.humGain.gain.setTargetAtTime(0, this.ctx.currentTime, 0.5);
                        this.humSource.stop(this.ctx.currentTime + 0.5);
                        this.humSource = null;
                        this.humGain = null;
                    }
                },
                playScanSound: function() {
                    if(!this.ctx) return;
                    if(this.ctx.state === 'suspended') this.ctx.resume();

                    const src = this.ctx.createBufferSource();
                    src.buffer = this.buffer;
                    src.loop = true;
                    
                    const env = this.ctx.createGain();
                    env.gain.setValueAtTime(0, this.ctx.currentTime);
                    // 1. Fade In
                    env.gain.linearRampToValueAtTime(0.8, this.ctx.currentTime + 0.5);
                    // 2. Sustain
                    env.gain.setValueAtTime(0.8, this.ctx.currentTime + 4.0);
                    // 3. Reverse/Fade Out
                    env.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 5.5);

                    src.connect(this.f);
                    this.f.connect(env);
                    env.connect(this.ctx.destination);

                    // Filter Sweep Up
                    this.f.frequency.setValueAtTime(100, this.ctx.currentTime);
                    this.f.frequency.exponentialRampToValueAtTime(3000, this.ctx.currentTime + 3.5);
                    // Filter Sweep Down (Reverse Effect)
                    this.f.frequency.linearRampToValueAtTime(50, this.ctx.currentTime + 5.5);

                    src.start();
                    src.stop(this.ctx.currentTime + 6.0);
                },
                reset: function() { if(this.ctx && this.f) this.f.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime+1); }
            },
            setStartAudio: function(isOn, e) {
                this.audioEnabled = isOn;
                document.querySelectorAll('.opt-btn').forEach(b=>b.classList.remove('active'));
                e.target.classList.add('active');
                if(isOn) {
                    if(!this.audio.ctx) this.audio.init();
                    this.audio.playBlip();
                    // Start the comforting 60Hz rumble after blip
                    setTimeout(() => this.audio.startHum(), 200);
                } else {
                    if(this.audio.ctx) this.audio.stopHum();
                }
            },
            init: function() {
                document.getElementById('start-screen').style.opacity = 0;
                setTimeout(()=>document.getElementById('start-screen').style.display='none', 800);
                if(!this.visual) this.visual = new VisualEngine();
                
                // Initialize Audio but NO BOOT SOUND (Removed as requested)
                if(this.audioEnabled) {
                    if(!this.audio.ctx) this.audio.init();
                    // If already enabled, ensure hum is running
                    this.audio.startHum();
                }
                
                const sel = document.getElementById('inp-city');
                CITY_DB.asia.forEach(c => { let o = document.createElement('option'); o.text = c.name; sel.appendChild(o); });
            },
            startSequence: function() {
                const d = document.getElementById('inp-date').value;
                if(!d) { alert("Date required"); return; }
                this.date = new Date(d);
                
                document.getElementById('input-container').style.opacity = 0;
                document.getElementById('input-container').style.pointerEvents = 'none';
                
                // Sound Trigger
                if(this.audioEnabled) {
                     if(!this.audio.ctx) this.audio.init();
                     this.audio.playScanSound(); 
                }
                
                document.getElementById('synchro-overlay').style.opacity = 1;
                const txts = ["アカシックレコード接続中...", "CNL統合処理開始...", "矛盾係数計算中...", "ブループリント展開..."];
                let i=0; document.getElementById('t-sync').innerText = txts[0];
                const iv = setInterval(()=>{
                    i++; if(i<txts.length) document.getElementById('t-sync').innerText = txts[i];
                    else { clearInterval(iv); this.analyze(); }
                }, 1500); 
            },
            analyze: function() {
                const d = this.date;
                const y = d.getFullYear(), m = d.getMonth()+1, day = d.getDate();
                const k = Astro.getKyusei(y);
                const kNum = Astro.getKyuseiNum(y);
                const season = (m>=3 && m<=5)?"春":(m>=6 && m<=8)?"夏":(m>=9 && m<=11)?"秋":"冬";
                
                // 1. CNL Logic
                const cnl = Astro.calculateCNL(y, m, day);
                const chart = document.getElementById('cnl-chart');
                chart.innerHTML = "";
                const labels = {Wood:'木行<br>(拡大)', Fire:'火行<br>(情熱)', Earth:'土行<br>(基盤)', Metal:'金行<br>(規律)', Water:'水行<br>(柔軟)'};
                const colors = {Wood:'#4d8', Fire:'#f34', Earth:'#da4', Metal:'#eee', Water:'#48f'};
                Object.keys(cnl.norm).forEach(key => {
                    chart.innerHTML += `<div class="cnl-bar-col"><div class="cnl-bar-fill" style="height:${cnl.norm[key]}%; background:${colors[key]};"></div><span class="cnl-label">${labels[key]}</span></div>`;
                });

                // 2. Process Log
                const logDiv = document.getElementById('cnl-log');
                logDiv.innerHTML = `<div style="border-bottom:1px solid #445; margin-bottom:10px; color:#fff;">CNL 解析ログ [PID: ${Date.now().toString().slice(-6)}]</div>`;
                cnl.logs.forEach(l => {
                    logDiv.innerHTML += `<div class="log-line"><span class="log-key">${l.k}:</span> <span class="log-val ${l.alert?'log-alert':''}">${l.v}</span></div>`;
                });

                // 3. Phase & Strategy (EXPANDED TEXT)
                const phaseVal = (new Date().getFullYear() + kNum) % 3;
                let phase = phaseVal === 0 ? {n:"ATTACK (攻勢期)",c:"var(--c-attack)"} : phaseVal === 1 ? {n:"DEFENSE (守勢期)",c:"var(--c-defense)"} : {n:"TRANSITION (転換期)",c:"var(--c-trans)"};
                const pVal = document.getElementById('phase-val');
                pVal.innerText = phase.n; pVal.style.color = phase.c; pVal.style.textShadow = `0 0 15px ${phase.c}`;
                document.getElementById('phase-box').style.borderColor = phase.c;

                const strat = this.getStrategyText(k + "-" + season);
                document.getElementById('st-title').innerText = strat.title;
                document.getElementById('st-body').innerHTML = strat.body; 
                document.querySelector('.strategy-container').style.borderLeftColor = phase.c;

                // 4. Params & Grid
                document.getElementById('res-birthdate').innerText = d.toLocaleDateString().replace(/\//g, '.');
                const pGrid = document.getElementById('param-grid'); pGrid.innerHTML = "";
                CYCLES.forEach(c => {
                    const s = Astro.getStats(d, c.days);
                    pGrid.innerHTML += `<div class="param-item"><div class="param-head"><span>${c.name}</span><span>${s.p}%</span></div><div class="param-bar-bg"><div class="param-bar-fill" style="width:${s.p}%;background:${c.color}"></div></div></div>`;
                });

                const grid = document.getElementById('grid-container'); grid.innerHTML = "";
                const items = [
                    {t:"九星気学", v:k, d:DICT_JA.kyusei[k]}, {t:"十干", v:Astro.getJukkan(y), d:"生まれ持った役割"}, 
                    {t:"八卦", v:"離 (Li)", d:"知性と美の象徴"}, {t:"ハウス", v:"第1ハウス", d:"自己の領域"},
                    {t:"アスペクト", v:"木星トライン", d:"幸運の角度"}, {t:"木星位置", v:"双子座", d:"情報と移動"}, 
                    {t:"土星位置", v:"魚座", d:"精神的基盤"}, {t:"金星", v:"8年周期", d:"美と金融"},
                    {t:"月相", v:"29.5日", d:"内面リズム"}, {t:"ライオンズゲート", v:"Closed", d:"宇宙エネルギー"}, 
                    {t:"三元九運", v:"第九運", d:"火の時代"}, {t:"Gコンジャンクション", v:"風", d:"情報革命"},
                    {t:"CNLスコア", v:"Optimized", d:"矛盾調停完了"}
                ];
                items.forEach(i => grid.innerHTML += `
                    <div class="info-card">
                        <div class="card-label">${i.t}</div>
                        <div class="card-value">${i.v}</div>
                        <div class="card-desc">${i.d}</div>
                    </div>
                `);

                // 5. X-Days (UPDATED WITH DESCRIPTION)
                const xSoc = Astro.getSocialXDay(y,m,day);
                const xPer = Astro.getPersonalXDay(y,m,day);
                document.getElementById('xday-grid').innerHTML = `
                    <div class="xday-card"><div class="xday-date">${xSoc}</div><div>SOCIAL EXPANSION</div></div>
                    <div class="xday-card" style="border-top-color:var(--c-purple)"><div class="xday-date" style="color:var(--c-purple)">${xPer}</div><div>PERSONAL RESONANCE</div></div>
                    <div style="grid-column:1/-1; margin-top:15px; font-size:0.8rem; color:#889; line-height:1.6; text-align:left;">
                        <strong style="color:var(--c-gold)">SOCIAL:</strong> 社会的な影響力が拡大する日。仕事、発表、交渉に最適です。<br>
                        <strong style="color:var(--c-purple)">PERSONAL:</strong> 個人の波動が整う日。恋愛、対話、内省に深い意味を持ちます。<br>
                        外部と内部、2つの特異点を意識することで、運命の周期を掌握できます。
                    </div>
                `;

                document.getElementById('synchro-overlay').style.opacity = 0;
                document.getElementById('result-overlay').classList.add('active');
                if(this.audioEnabled) this.audio.reset();
            },
            
            // FULL 36 PATTERN DATA
            getStrategyText: function(key) {
                const s = {
                    "一白水星-春": { title: "潜流の覚醒と新たな脈動", body: "一白水星の持つ「水」の柔軟性と、春の「木」の成長エネルギーが融合する季節です。<br>雪解け水が川となり、やがて大河へと繋がるように、あなたの運命も静かながら力強い流れの中にあります。表面的な派手さはありませんが、水面下での戦略的準備が驚くほどの成果を生むでしょう。<br>今は焦って結果を求める時ではありません。地下深くで根を張るように、知識と人脈を蓄えてください。<br>古い殻を破り、新しい形へと変化することを恐れないでください。水は器に合わせて形を変えますが、その本質は変わりません。<br>あなたの柔軟な思考こそが、硬直した現状を打破する鍵となります。<br>周囲の喧騒に惑わされず、自身の内なる声に耳を傾け、静かに、しかし確実に前進してください。" },
                    "一白水星-夏": { title: "冷静なる火消しと中和の美学", body: "夏の強烈な「火」のエネルギーと、あなたの「水」の性質が対峙する時期です。<br>周囲が熱狂し、感情的に暴走しやすい中で、あなただけが冷静な視点を保つことができます。<br>この温度差こそが、あなたの最大の武器となるでしょう。トラブルや争いごとの仲裁役として、あるいは過熱したプロジェクトの軌道修正役として、不可欠な存在となります。<br>ただし、自身の冷徹さが周囲に「冷たい」と誤解されないよう、言葉選びには温かみを持たせてください。<br>蒸発してしまう水のように、消耗しやすい時期でもあります。無理な自己犠牲は避け、自身のメンタルケアを最優先に。<br>知的な戦略で情熱をコントロールし、カオスの中に秩序をもたらすことが、この時期のあなたの使命です。" },
                    "一白水星-秋": { title: "深淵への潜行と知恵の結晶化", body: "秋の「金」の気が、あなたの「水」を生み出し、エネルギーが循環する幸運期です。<br>清らかな水が湧き出るように、アイデアやインスピレーションが次々と溢れ出るでしょう。<br>これまでの経験や苦労が濾過され、純粋な「知恵」として結晶化するタイミングです。<br>深く潜ることを恐れないでください。表面的な成功よりも、本質的な価値の追求が大きなリターンをもたらします。<br>研究、執筆、芸術活動など、孤独な作業の中に光があります。一人静かに過ごす時間が、あなたの魂を磨き上げます。<br>人間関係においては、広げることよりも深めることを意識してください。少数の理解者との絆が、将来の強固な基盤となります。<br>静寂の中でこそ、真実はその姿を現すのです。" },
                    "一白水星-冬": { title: "凍結と純化、原点回帰の静寂", body: "冬の「水」は氷となり、その場に留まります。これは停滞ではなく、エネルギーの保存です。<br>一白水星の本拠地である冬において、あなたの精神性は極限まで研ぎ澄まされます。<br>無駄なものが削ぎ落とされ、本当に大切なものだけが残る「純化」のプロセスが進みます。<br>この時期は、外に向かって動くことよりも、内面世界の探求に全力を注ぐべきです。<br>過去の清算、計画の見直し、そして自分自身との対話。これらは地味な作業ですが、来たるべき春の跳躍には不可欠な助走期間です。<br>孤独を感じるかもしれませんが、それは孤高の証です。他者に依存せず、自立した精神を確立する絶好の機会。<br>春の雪解けを信じ、今は静かに力を蓄え、魂の透明度を高めてください。" },
                    
                    "二黒土星-春": { title: "大地の目覚めと基盤の構築", body: "春の訪れとともに、凍てついた大地が緩み、生命を育む準備が整いました。<br>二黒土星の持つ「母なる大地」の慈愛が、春の芽吹きを力強くサポートします。<br>あなたの地道な努力や、人を育てる才能が、周囲から高く評価される時期です。<br>派手な成果を急ぐ必要はありません。種を撒き、水をやり、雑草を抜く。そんな日々のルーチンワークこそが、未来の豊穣を約束します。<br>新しいプロジェクトの土台作りや、後進の指導に最適なタイミングです。<br>あなたの安定感が、不安定な春の気候の中で、周囲の人々の心の拠り所となるでしょう。<br>焦らず、着実に、一歩ずつ。大地の歩みは遅くとも、決して後退することはありません。" },
                    "二黒土星-夏": { title: "忍耐の果実と奉仕の精神", body: "夏の激しい日差しを受け止め、大地は熱を蓄えます。それは作物を育てるための情熱です。<br>周囲が活動的になり、スピード感が求められる時期ですが、あなたは自分のペースを崩さないでください。<br>華やかな表舞台よりも、縁の下の力持ちとしての役割が光ります。<br>あなたの献身的なサポートや、細やかな気配りが、チーム全体の成功を支える鍵となります。<br>一見損な役回りに思えるかもしれませんが、この時期に積んだ「徳」は、後に大きな信用となって返ってきます。<br>暑さに負けない粘り強さと、全てを受け入れる包容力。<br>あなたの静かなる強さが、灼熱の夏において、最も頼もしい存在となるでしょう。" },
                    "二黒土星-秋": { title: "豊穣の収穫と感謝の循環", body: "大地が最も輝く収穫の秋。あなたの季節が到来しました。<br>これまでの誠実な取り組みが形となり、具体的な成果として手元に届きます。<br>金銭的な利益だけでなく、人間関係の信頼や、社会的な評価も高まるでしょう。<br>受け取った豊かさを独り占めせず、周囲と分かち合うことで、運気はさらに上昇します。<br>「おかげさまで」という感謝の心が、次の幸運の種となります。<br>実った果実を味わいながら、次なるサイクルのための土作りも忘れずに。<br>充実感に満ちたこの時期、あなたの笑顔が周囲を明るく照らし、幸せの連鎖を生み出します。" },
                    "二黒土星-冬": { title: "大地の休息と次なる構想", body: "収穫を終えた冬の畑は、静かに眠りにつきます。しかし、土の中では微生物が活発に働き、養分を作っています。<br>あなたにとっても、今は休息と充電の時。無理に動こうとせず、心身のメンテナンスを優先してください。<br>家族や親しい友人との団欒、温かい食事、心地よい住環境。日常の些細な幸せを大切にすることで、エネルギーが回復します。<br>来たるべき春に向けて、何を育て、どう生きていくか、長期的なビジョンを描くのにも良い時期です。<br>焦ることはありません。大地が急がないように、あなたも自然のリズムに身を委ねてください。<br>深い休息こそが、次の大きな実りを生む源泉となるのです。" },
                    
                    "三碧木星-春": { title: "雷鳴の始動と革新の狼煙", body: "あなたの本拠地である「春」と「雷」のエネルギーが共鳴し、爆発的な推進力が生まれます。<br>新しいことを始めるのに、これほど適した時期はありません。直感が冴え渡り、アイデアが次々と閃くでしょう。<br>「とりあえずやってみる」という軽快なフットワークが、運命の扉を開きます。<br>失敗を恐れる必要はありません。三碧木星にとって、停滞こそが最大のリスクです。<br>声高らかに目標を宣言し、周囲を巻き込んでいくリーダーシップを発揮してください。<br>あなたの若々しいエネルギーとチャレンジ精神が、停滞した空気を一掃し、革新の風を吹かせます。<br>雷鳴のように、一瞬で世界を変えるインパクトを与えることができるでしょう。" },
                    "三碧木星-夏": { title: "疾風怒濤と高速展開", body: "夏の熱気が上昇気流を生み、あなたのスピードはさらに加速します。<br>複数のプロジェクトを同時並行で進めるマルチタスク能力が開花するでしょう。<br>情報は鮮度が命。誰よりも早く情報をキャッチし、即座に行動に移すことで、先行者利益を得られます。<br>ただし、勢い余って周囲との摩擦を生む可能性も。「口は災いの元」とならぬよう、発言には最低限の配慮を。<br>立ち止まることなく、走りながら考えるスタイルが功を奏します。<br>情熱とスピードが融合した今のあなたは、誰にも止められない無敵の存在。<br>この勢いに乗って、一気に高みへと駆け上がってください。" },
                    "三碧木星-秋": { title: "実りの精算と軌道修正", body: "春夏の猛烈なダッシュから一転、結果が問われる秋が来ました。<br>広げすぎた風呂敷を畳み、本当に必要なものだけを選別する時期です。<br>勢いだけで進めてきた物事に、具体的な数字や形が求められます。<br>思い通りにいかなかったことも、全ては貴重なデータです。感情的にならず、冷静に分析し、次の一手を考えてください。<br>「継続は力なり」という言葉が、この時期の課題です。飽きっぽい面を封印し、最後の仕上げまでやり抜くこと。<br>それができた時、単なる「アイデアマン」から、真の「実力者」へと変貌を遂げることができるでしょう。" },
                    "三碧木星-冬": { title: "雷の沈黙と内なる蓄電", body: "冬の空に雷鳴は響きません。エネルギーを内側に溜め込む時期です。<br>表立った活動は停滞気味になりますが、焦りは禁物です。<br>この静寂は、次の春に特大の雷を落とすための充電期間と捉えてください。<br>読書、スキルアップ、情報収集など、自分自身への投資に時間を使うのがベストです。<br>口を閉ざし、耳を澄ますことで、普段は見落としていた重要なヒントが見つかるかもしれません。<br>暗闇の中でこそ、雷の光は最も鮮烈に輝きます。<br>今は力を温存し、その時が来るのを虎視眈々と狙ってください。" },

                    "四緑木星-春": { title: "春風の誘いと良縁の拡大", body: "柔らかな春風が、あなたに素敵な出会いを運んできます。<br>四緑木星の持つ「風」の性質が最大限に活かされる時期です。人当たりの良さとコミュニケーション能力で、人脈が驚くほど広がります。<br>家に閉じこもっていては勿体無い。積極的に外に出て、人と会い、語り合いましょう。<br>あなたの爽やかな魅力が、多くの人を惹きつけ、そこから新しいビジネスやチャンスが生まれます。<br>「信用」がキーワードです。約束を守る、嘘をつかない、誠実に対応する。<br>当たり前のことを積み重ねることで、あなたの周りには強固なネットワークが構築されます。<br>風が花粉を運ぶように、あなたも幸運の種を遠くまで運ぶメッセンジャーとなってください。" },
                    "四緑木星-夏": { title: "信用という涼風と調整力", body: "暑苦しい夏の中で、あなたの一服の清涼剤のような存在感が際立ちます。<br>人間関係の調整役として、非常に重宝されるでしょう。<br>対立している意見をまとめ上げたり、スムーズな進行をサポートしたりと、潤滑油のような働きが求められます。<br>あなたのバランス感覚と柔軟性が、組織やチームの調和を保つ要となります。<br>ただし、八方美人になりすぎないよう注意。優柔不断は信用の低下を招きます。<br>重要な局面では、風のように流されるのではなく、しっかりと自分の意志を示すことも大切です。<br>爽やかさの中に、凛とした強さを持つことで、カリスマ性はさらに高まります。" },
                    "四緑木星-秋": { title: "縁の収穫祭と信用の換金", body: "これまで丁寧に紡いできたご縁が、具体的な形となって実を結びます。<br>紹介や引き立てによって、思いがけないビッグチャンスが舞い込むかもしれません。<br>ビジネスにおいては、過去の顧客や取引先からの再アプローチに期待が持てます。<br>「遠方」にツキがあります。出張や旅行先での出会いが、人生を変えるきっかけになることも。<br>情報は発信する人のところに集まります。あなたの成功体験や知識を惜しみなくシェアしてください。<br>風通しの良い関係性が、豊かさを呼び込みます。<br>感謝の気持ちを言葉にして伝えることで、運気はさらに盤石なものとなるでしょう。" },
                    "四緑木星-冬": { title: "凪の内省と根回しの時", body: "風が止み、静寂が訪れる冬。人間関係の整理整頓に適した時期です。<br>広がりすぎた人脈を見直し、本当に大切な人との絆を深めることに注力してください。<br>表面的な付き合いよりも、心を通わせる深い対話が必要です。<br>水面下での根回しや、交渉ごとの準備にも最適です。<br>派手な動きは控え、手紙を書いたり、贈り物をしたりと、アナログなコミュニケーションを大切に。<br>冷たい風が吹く季節だからこそ、あなたの温かい心遣いが人の心に染み渡ります。<br>次の風が吹くまでの間、しっかりとした根を張り、自分自身の軸を整えておきましょう。" },

                    "五黄土星-春": { title: "帝王の目覚めと破壊的創造", body: "「破壊と再生」を司る五黄土星が、春のエネルギーを得て動き出します。<br>既存のルールや古い慣習を打ち壊し、全く新しい秩序を作り上げるパワーに満ちています。<br>あなたの言動には強い影響力があり、周囲を圧倒するでしょう。<br>改革には痛みが伴いますが、恐れずにメスを入れてください。腐敗した部分を取り除くことができるのは、あなただけです。<br>ただし、強引になりすぎると孤立する危険も。「強さ」と「暴力」は紙一重です。<br>目的の正当性を丁寧に説明し、周囲の理解を得る努力も忘れずに。<br>荒れ地を耕し、新しい文明を築く開拓者のような気概で進んでください。" },
                    "五黄土星-夏": { title: "灼熱の支配と圧倒的存在感", body: "夏の太陽よりも熱く、激しいエネルギーがあなたを包み込みます。<br>カリスマ性が最高潮に達し、黙っていても人が付いてくるような王者の風格が漂います。<br>自信に満ちた決断が、大きな成功を引き寄せるでしょう。<br>しかし、その強大すぎるパワーは、時に周囲を焼き尽くしてしまうことも。<br>傲慢さや独善的な態度は、破滅への入り口です。実るほど頭を垂れる稲穂のように、謙虚さを忘れないでください。<br>あなたのエネルギーを「支配」ではなく「守護」に使った時、真のリーダーとして崇められるでしょう。<br>情熱の炎をコントロールし、組織全体を照らす灯台となってください。" },
                    "五黄土星-秋": { title: "覇道の総括と実力の証明", body: "戦いの季節が終わり、成果を確認する時です。<br>あなたが成し遂げた改革や挑戦が、どのような結果をもたらしたのか、冷徹に評価されます。<br>真の実力者であれば、大きな報酬と名声を手にするでしょう。<br>逆に、虚勢だけで中身が伴っていなければ、厳しい現実に直面することになります。<br>五黄土星の結果は「0か100か」。中途半端はありません。<br>どのような結果であれ、それを全て受け入れる度量が、あなたの器をさらに大きくします。<br>得られた力を、私利私欲のためではなく、世の中のためにどう還元するか。<br>その視点を持った時、あなたは帝王から聖王へと進化します。" },
                    "五黄土星-冬": { title: "帝王の孤独と深淵なる再生", body: "冬の寒さの中、五黄土星は土の底で眠ります。それは死ではなく、再生へのプロセスです。<br>華やかな舞台から離れ、孤独と向き合う時間が訪れます。<br>この孤独こそが、あなたを最強の存在へと育て上げます。誰にも頼らず、自分自身の力で立ち上がる強さを養ってください。<br>過去の失敗も成功も、全てを土に還し、ゼロから自分を再構築するチャンスです。<br>腐葉土が植物の栄養になるように、あなたの経験は全て未来の糧となります。<br>焦ってはいけません。じっくりと時間をかけて、魂の核を練り上げてください。<br>闇が深ければ深いほど、次に昇る光は強く輝くのです。" },

                    "六白金星-春": { title: "天の号令と高潔なる理想", body: "天のエネルギーを宿す六白金星。春の訪れとともに、高い理想を掲げて立ち上がる時です。<br>あなたの正義感や責任感が、混沌とした状況に秩序をもたらします。<br>目先の利益にとらわれず、大局的な視点から物事を判断してください。<br>「あるべき姿」を追求するあなたの姿勢は、周囲に清々しい感動を与えます。<br>リーダーシップを発揮する絶好の機会ですが、完璧主義を他人に押し付けないよう注意。<br>人は不完全な生き物です。その弱さを許す寛容さを持てば、あなたの統率力は盤石なものになります。<br>天命に従い、高貴な精神で、組織やチームを正しい方向へと導いてください。" },
                    "六白金星-夏": { title: "正義の炎と厳格な規律", body: "夏の暑さにも負けない、熱い使命感に燃える時期です。<br>不正や怠慢を決して許さない厳しさが、組織の引き締め役として機能します。<br>妥協なき仕事ぶりが評価され、重要なポストや責任ある仕事を任されるでしょう。<br>多忙を極めることになりますが、六白金星にとって「忙しさ」は充実の証です。<br>ただし、オーバーワークによる過労には警戒を。身体は資本です。<br>時には鎧を脱ぎ、リラックスする時間を持つことも、長期戦を戦い抜くための戦略です。<br>あなたの流す汗は、決して裏切りません。確かな実力と実績を積み上げてください。" },
                    "六白金星-秋": { title: "完璧なる収穫と円熟の境地", body: "あなたの研ぎ澄まされた感性と努力が、最高品質の成果となって現れます。<br>「本物」だけが生き残る秋において、あなたの仕事は高い評価を受けるでしょう。<br>金銭的な豊かさも付いてきますが、それ以上に「名誉」や「誇り」が満たされる喜びを感じます。<br>完成された美しさ、無駄のない機能美。<br>あなたが作り出すものには、神宿るような気品があります。<br>さらに上を目指す向上心は素晴らしいですが、今の達成を素直に喜ぶことも大切です。<br>自分自身を褒めてあげてください。あなたは十分すぎるほどの偉業を成し遂げました。" },
                    "六白金星-冬": { title: "天の静寂と精神の昇華", body: "冬の澄み切った夜空のように、あなたの精神は高く、静かな場所にあります。<br>現実社会の喧騒から離れ、哲学的・宗教的な思索に耽るのに適した時期です。<br>目に見える物質的な価値よりも、精神的な価値や、魂の成長に重きを置いてください。<br>瞑想、読書、古典芸能の鑑賞など、格調高い趣味が運気を高めます。<br>また、ボランティアや寄付など、見返りを求めない行為（陰徳）を積むのにも良い時です。<br>天は見ています。あなたが誰にも知られずに行った善行が、巡り巡って大きな加護となります。<br>静寂の中で、自身の精神をより高みへと昇華させてください。" },

                    "七赤金星-春": { title: "悦楽の開花と社交の華", body: "春の陽気のように、あなたの心もウキウキと弾みます。<br>七赤金星の持つ「喜び」や「楽しさ」のエネルギーが全開になる時期です。<br>ユーモア溢れる会話とチャーミングな笑顔で、どこに行っても人気者になれるでしょう。<br>食事会、パーティー、イベントなど、人が集まる場所には積極的に顔を出してください。<br>遊びの中からビジネスのヒントが見つかったり、趣味が副業に繋がったりと、公私の境界線が良い意味で曖昧になります。<br>「楽しむこと」が最大の開運アクションです。<br>深刻に考え込まず、軽やかに、そして朗らかに。あなたの笑顔が春の花々のように咲き誇ります。" },
                    "七赤金星-夏": { title: "黄金の弁舌と交渉の勝利", body: "夏の日差しの下、あなたの話術は冴え渡り、黄金のような輝きを放ちます。<br>説得力のあるプレゼンテーション、巧みな交渉、魅力的なセールストーク。<br>言葉を武器にして、欲しいものを次々と手に入れることができるでしょう。<br>しかし、口先だけにならないよう注意が必要です。「多弁は銀、沈黙は金」という言葉も心に留めて。<br>相手を楽しませるサービス精神は素晴らしいですが、調子に乗りすぎて失言しないように。<br>言葉には責任を持つこと。約束は必ず守ること。<br>誠実さをプラスすれば、あなたのコミュニケーション能力は無敵の武器となります。" },
                    "七赤金星-秋": { title: "豊穣の宴と収穫の喜び", body: "実りの秋、まさに七赤金星のための季節です。<br>物質的な豊かさ、美味しい食事、楽しい仲間。人生の喜びをこれでもかと味わい尽くす時です。<br>臨時収入やプレゼントなど、ラッキーな出来事も多いでしょう。<br>この幸運は、あなたがこれまで周囲を楽しませてきたご褒美です。<br>遠慮せずに受け取り、そして周囲にも還元してください。ケチケチするのは運気を下げます。<br>「一緒に食べると美味しいね」という共感の心が、絆を深めます。<br>人生は祭りです。この豊穣の時を、心ゆくまで謳歌してください。" },
                    "七赤金星-冬": { title: "宴の終わりと冬支度", body: "楽しかった宴も終わり、静かな冬がやってきました。<br>祭りの後の寂しさを感じるかもしれませんが、これは必要なクールダウンの期間です。<br>出費がかさみやすい時期なので、金銭管理はしっかりと。<br>浮かれた気分を引き締め、現実的な課題に向き合う必要があります。<br>しかし、悲観することはありません。冬には冬の楽しみ方があります。<br>少人数での鍋パーティーや、お気に入りの映画鑑賞など、アットホームな時間を大切にしてください。<br>派手さはなくとも、心温まる交流が、冷えた心を優しく溶かしてくれます。<br>次の春の宴に向けて、英気を養いましょう。" },

                    "八白土星-春": { title: "山動き始める大転換", body: "「不動の山」である八白土星が、春のエネルギーを受けて地殻変動を起こします。<br>人生の大きなターニングポイントとなる時期です。<br>転職、引越し、結婚、独立など、現状を大きく変える決断を迫られるかもしれません。<br>変化はストレスを伴いますが、今の場所にしがみついていては成長はありません。<br>山が動けば景色が一変するように、思い切って一歩を踏み出すことで、全く新しい世界が広がります。<br>過去の成功体験を捨て、ゼロから積み上げる覚悟を持ってください。<br>高い山ほど登る価値があります。あなたの挑戦が、新しい伝説の始まりとなります。" },
                    "八白土星-夏": { title: "不動の忍耐と頂への道", body: "夏の厳しい日差しが照りつける中、あなたは黙々と山道を登り続けます。<br>思うように進まない停滞感や、障害物に阻まれることもあるでしょう。<br>しかし、八白土星の本領はここからです。逆境においてこそ、その強靭な精神力が発揮されます。<br>安易な近道を選ばず、一歩一歩確実に足場を固めてください。<br>あなたの背中は、周囲に「諦めないことの大切さ」を無言で伝えています。<br>今は結果が出なくても、積み上げた努力は決して無駄にはなりません。<br>頂上からの絶景を信じて、今はただひたすらに、目の前の壁を乗り越えてください。" },
                    "八白土星-秋": { title: "改革の実現と新秩序", body: "春に起こした変化が定着し、新しい形となって現れる秋です。<br>混沌としていた状況が整理され、新しいシステムやルールが稼働し始めます。<br>あなたが主導してきた改革が、ようやく周囲に理解され、評価される時が来ました。<br>「山」のような存在感と信頼感で、組織の重鎮として頼りにされるでしょう。<br>後継者の育成や、事業の継承など、「繋ぐ」ことにも縁があります。<br>伝統を守りつつ、革新を取り入れる。その絶妙なバランス感覚が光ります。<br>揺るぎない自信と実績を胸に、堂々とその座に君臨してください。" },
                    "八白土星-冬": { title: "静寂の山岳と孤高の戦略", body: "雪に覆われた冬山のような、厳しくも美しい静寂が訪れます。<br>外側の活動は縮小し、内面的な活動が活発になります。<br>次の改革に向けた長期的な戦略を練るのに最適な時期です。<br>孤独な環境でこそ、深い思考と洞察力が生まれます。<br>家族や親族との関わりが深まる時期でもあります。家の問題や相続など、ルーツに関わる課題に向き合うことになるかもしれません。<br>過去と未来を繋ぐ結節点として、あなたは重要な役割を果たします。<br>静かに、しかし熱く。雪の下で春を待つ種のように、希望の灯を絶やさないでください。" },

                    "九紫火星-春": { title: "太陽の昇天と知性の輝き", body: "春の空に太陽が昇るように、あなたの運気は急上昇します。<br>九紫火星の持つ「火」と「知性」が、春の木気を得て燃え上がります。<br>隠されていた才能が日の目を見たり、努力が認められて表彰されたりと、スポットライトを浴びる機会が増えるでしょう。<br>直感力と先見性が冴え渡り、誰も思いつかないようなアイデアで世界を驚かせます。<br>ただし、目立つことは嫉妬を買うことでもあります。<br>光が強ければ影も濃くなることを忘れずに。謙虚さと周囲への感謝を持つことで、その輝きはより長く、美しく保たれます。<br>恐れずに自己表現してください。あなたは輝くために生まれてきたのですから。" },
                    "九紫火星-夏": { title: "炎の絶頂と情熱の奔流", body: "真夏の太陽と九紫火星が共鳴し、エネルギーは最高潮に達します。<br>情熱のままに行動することで、道が拓ける時期です。<br>芸術、学問、美容など、美と知に関わる分野で大きな成果を上げることができるでしょう。<br>感情の起伏も激しくなります。愛憎劇や対人トラブルには注意が必要ですが、それすらも創作のエネルギーに変えてしまうのがあなたの強み。<br>燃え尽きることを恐れず、完全燃焼してください。<br>「熱中できる何か」を持っているあなたは、誰にも魅力的で、生き生きとしています。<br>その情熱の炎で、周囲の人々の心にも火をつけてください。" },
                    "九紫火星-秋": { title: "夕陽の美学と去り際の哲学", body: "秋の夕暮れ時のように、美しくもどこか儚い、情緒的な運気です。<br>物事の「終わり」や「離別」を経験するかもしれませんが、それは次のステージへの卒業を意味します。<br>執着を手放すことで、さらに洗練された美意識と精神性を手に入れることができるでしょう。<br>断捨離や整理整頓にツキがあります。不要なものを手放すと、空いたスペースに新しい幸運が入ってきます。<br>去り際の美しさを意識してください。立つ鳥跡を濁さず。<br>あなたの後ろ姿が、残された人々に深い感銘と教訓を与えるような、そんな気高い生き方を目指してください。" },
                    "九紫火星-冬": { title: "灯火の導きと希望の光", body: "冬の闇夜を照らす蝋燭の火のように、あなたの存在が人々の希望となります。<br>華やかさはなくとも、温かく、そして力強い光です。<br>悩み苦しむ人に寄り添い、知恵と慈愛で道を指し示すガイド役としての使命があります。<br>自分自身の内面にも光を当ててください。見ないふりをしてきた弱さやコンプレックスと向き合うことで、真の強さが生まれます。<br>学問や研究に没頭するのも良いでしょう。深い知識は、あなたを支える揺るぎない燃料となります。<br>決して消えることのない情熱の火を胸に、静かに、しかし誇り高く、冬の時代を照らし続けてください。" }
                };
                return s[key] || { title: "宇宙の羅針盤 (Calibration Error)", body: "座標計算に微細なズレが生じました。生年月日を再確認し、再初期化してください。<br>宇宙は常にあなたを見ています。" };
            },
            reset: function() {
                document.getElementById('result-overlay').classList.remove('active');
                document.getElementById('input-container').style.opacity = 1;
                document.getElementById('input-container').style.pointerEvents = 'auto';
            },
            export: function() {
                html2canvas(document.getElementById('capture-target'),{backgroundColor:'#020305'}).then(c=>{
                    const a=document.createElement('a');a.href=c.toDataURL();a.download='chart.png';a.click();
                });
            },
            jumpToSound: function() {
                const d = document.getElementById('inp-date').value.replace(/-/g, '');
                window.location.href = "https://astro-resonance2.vercel.app?dob=" + d;
            }
        };

        class VisualEngine {
            constructor() {
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.FogExp2(0x020205, 0.001);
                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 4000);
                this.camera.position.set(0, 30, 50); this.camera.lookAt(0, 0, 0);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                document.getElementById('canvas-wrapper').appendChild(this.renderer.domElement);
                
                // 1. BUCKYBALLS (Main)
                const g1 = new THREE.DodecahedronGeometry(2.2,0);
                const m1 = new THREE.MeshBasicMaterial({color:0x00ffff, wireframe:true, transparent:true, opacity:0.8});
                this.c1=new THREE.Mesh(g1,m1); this.scene.add(this.c1);
                const g2 = new THREE.IcosahedronGeometry(2.5,0);
                const m2 = new THREE.MeshBasicMaterial({color:0x0088ff, wireframe:true, transparent:true, opacity:0.4});
                this.c2=new THREE.Mesh(g2,m2); this.scene.add(this.c2);

                // 2. STARS (Restored random spread + Elliptical Tilt)
                const sG = new THREE.BufferGeometry(); const sP = [];
                // Use a wider/flatter spread to simulate a thick galaxy disk while keeping count high
                for(let i=0;i<30000;i++) sP.push(
                    THREE.MathUtils.randFloatSpread(2500), // Wide X
                    THREE.MathUtils.randFloatSpread(1200), // Medium Y (Thickness)
                    THREE.MathUtils.randFloatSpread(2500)  // Wide Z
                );
                sG.setAttribute('position',new THREE.Float32BufferAttribute(sP,3));
                // Size 0.5 to keep particles fine, not square
                this.s1=new THREE.Points(sG,new THREE.PointsMaterial({color:0xffffff, size:0.5, transparent:true, opacity:0.8}));
                // Tilt the whole system to create elliptical orbit effect
                this.s1.rotation.x = Math.PI * 0.1; 
                this.s1.rotation.z = Math.PI * 0.05;
                this.scene.add(this.s1);

                // 3. MICRO BUCKYBALLS (Floating Particles)
                this.micros = [];
                const mg = new THREE.IcosahedronGeometry(0.2,0);
                const mm = new THREE.MeshBasicMaterial({color:0x88ccff, wireframe:true});
                for(let i=0; i<30; i++) {
                    const m = new THREE.Mesh(mg, mm);
                    m.position.set(THREE.MathUtils.randFloatSpread(40), THREE.MathUtils.randFloatSpread(40), THREE.MathUtils.randFloatSpread(40));
                    this.scene.add(m);
                    this.micros.push({m:m, s:Math.random()*0.02, ax:Math.random(), ay:Math.random()});
                }

                this.animate();
            }
            animate() {
                requestAnimationFrame(this.animate.bind(this));
                this.c1.rotation.y += 0.003; this.c2.rotation.y -= 0.003;
                
                // Rotate the entire star field to simulate orbit
                this.s1.rotation.y += 0.0005; 
                
                this.micros.forEach(o => {
                    o.m.rotation.x += o.s; o.m.rotation.y += o.s;
                    o.m.position.y += Math.sin(Date.now()*0.001 + o.ax)*0.02;
                });
                this.renderer.render(this.scene, this.camera);
            }
        }
    </script>
</body>
</html>
