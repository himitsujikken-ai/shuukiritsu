<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¨æœŸå¾‹åˆ†æ | Cosmic Neural Network</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@300;500;700&family=Shippori+Mincho:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- CORE STYLES --- */
        :root { --c-accent: #00f0ff; --c-warn: #ff3366; --c-syn: #D4AF37; --bg-glass: rgba(8, 12, 24, 0.85); }
        body { margin: 0; overflow: hidden; background-color: #020205; font-family: 'Rajdhani', sans-serif; color: #fff; user-select: none; }
        
        /* Layout Layers */
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 0; transition: filter 1s; }
        #ui-layer { position: absolute; z-index: 10; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; }
        
        /* Typography */
        h1 { font-family: 'Shippori Mincho', serif; font-weight: 600; font-size: 2rem; margin: 0; letter-spacing: 0.2em; background: linear-gradient(to bottom, #fff, #aaccff); -webkit-background-clip: text; color: transparent; }
        .subtitle { font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.4em; color: var(--c-accent); text-transform: uppercase; margin-top: 5px; opacity: 0.8; }

        /* HEADER */
        header { padding: 30px; text-align: center; pointer-events: auto; position: relative; }
        .util-btn { position: absolute; top: 30px; cursor: pointer; border: 1px solid #334455; padding: 8px 15px; font-size: 0.7rem; transition: 0.3s; color: #8899aa; background: rgba(0,0,0,0.5); }
        .util-btn:hover { border-color: var(--c-accent); color: var(--c-accent); }
        #btn-sound { right: 30px; }
        #btn-logic { right: 120px; }
        #btn-history { right: 200px; }

        /* START OVERLAY */
        #start-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: rgba(2, 2, 5, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(10px); transition: opacity 0.8s, visibility 0.8s; pointer-events: auto; }
        .btn-start { padding: 20px 40px; border: 1px solid var(--c-accent); background: transparent; color: var(--c-accent); font-family: 'Cinzel', serif; font-size: 1.2rem; letter-spacing: 0.2em; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .btn-start:hover { background: rgba(0, 240, 255, 0.1); box-shadow: 0 0 30px var(--c-accent); }

        /* INPUT PANEL */
        #control-panel { 
            position: absolute; top: 50%; right: 5%; transform: translateY(-50%); width: 320px;
            background: var(--bg-glass); backdrop-filter: blur(16px);
            border: 1px solid rgba(0, 240, 255, 0.2); border-radius: 2px; padding: 40px 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6); pointer-events: auto; transition: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.75rem; color: #8899aa; margin-bottom: 8px; letter-spacing: 0.1em; }
        input, select { width: 100%; background: rgba(0, 0, 0, 0.4); border: 1px solid #334455; color: #fff; padding: 12px; font-family: 'Rajdhani'; font-size: 1.1rem; outline: none; box-sizing: border-box; }
        input:focus { border-color: var(--c-accent); box-shadow: 0 0 15px rgba(0, 240, 255, 0.1); }
        .btn-analyze { width: 100%; padding: 15px; margin-top: 15px; background: linear-gradient(90deg, transparent, rgba(0, 240, 255, 0.1), transparent); border: 1px solid var(--c-accent); color: var(--c-accent); font-family: 'Cinzel'; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-analyze:hover { background: var(--c-accent); color: #000; box-shadow: 0 0 30px var(--c-accent); }

        /* RESULT CARD (HIDDEN INITIALLY) */
        #result-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 80%; max-width: 600px;
            background: rgba(5, 8, 15, 0.95); border: 1px solid var(--c-accent);
            padding: 40px; box-shadow: 0 0 50px rgba(0,0,0,0.8);
            opacity: 0; pointer-events: none; transition: 0.5s; z-index: 20;
            display: flex; flex-direction: column; gap: 20px;
        }
        #result-panel.active { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
        
        .result-header { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: baseline; }
        .result-title { font-family: 'Shippori Mincho'; font-size: 1.8rem; color: #fff; }
        .result-type { font-size: 1rem; color: var(--c-accent); font-weight: bold; border: 1px solid var(--c-accent); padding: 2px 8px; }
        .result-body { font-family: 'Shippori Mincho'; font-size: 1rem; line-height: 1.8; color: #ddd; white-space: pre-wrap; }
        .result-strategy { background: rgba(0, 240, 255, 0.05); border-left: 3px solid var(--c-accent); padding: 15px; margin-top: 10px; font-size: 0.95rem; }
        
        /* Action Buttons */
        .action-row { display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid #333; padding-top: 20px; }
        .btn-action { flex: 1; padding: 10px; background: transparent; border: 1px solid #555; color: #aaa; cursor: pointer; font-size: 0.8rem; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-action:hover { border-color: var(--c-accent); color: var(--c-accent); background: rgba(0,240,255,0.05); }

        /* LOGIC MODAL & HISTORY */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { width: 90%; max-width: 700px; height: 80%; background: #111; border: 1px solid #333; padding: 40px; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 1.5rem; color: #555; }
        .close-modal:hover { color: #fff; }
        
        .logic-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .logic-item { border: 1px solid #333; padding: 15px; }
        .logic-item h4 { color: var(--c-accent); margin: 0 0 10px 0; }

        @media (max-width: 768px) {
            #control-panel { position: absolute; bottom: 0; right: 0; top: auto; transform: none; width: 100%; border-radius: 0; }
            #result-panel { width: 95%; padding: 20px; overflow-y: auto; max-height: 80vh; }
            .action-row { flex-wrap: wrap; }
            header { padding: 15px; }
            #btn-logic, #btn-history { display: none; } /* Mobile simplify */
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h1 style="font-size: 3rem; margin-bottom: 10px;">å‘¨æœŸå¾‹åˆ†æ</h1>
        <p style="font-family:'Rajdhani'; letter-spacing:0.3em; color:#8899aa; margin-bottom:40px;">COSMIC NEURAL NETWORK</p>
        <button class="btn-start" onclick="app.init()">INITIALIZE SYSTEM</button>
    </div>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <header>
            <h1>å‘¨æœŸå¾‹åˆ†æ</h1>
            <div class="subtitle">Cosmic Neural Network</div>
            <div class="util-btn" id="btn-history" onclick="app.toggleHistory()">HISTORY</div>
            <div class="util-btn" id="btn-logic" onclick="app.toggleLogic()">LOGIC ARCHIVE</div>
            <div class="util-btn" id="btn-sound" onclick="app.toggleMute()">AUDIO: ON</div>
        </header>

        <div id="control-panel">
            <div class="form-group">
                <label>Date of Birth (Coordinate)</label>
                <input type="date" id="inp-date" value="1995-08-08">
            </div>
            <div class="form-group">
                <label>Birth Place</label>
                <select id="inp-place">
                    <option>Tokyo, Japan</option>
                    <option>New York, USA</option>
                    <option>London, UK</option>
                </select>
            </div>
            <button class="btn-analyze" onclick="app.runAnalysis()">START SYNCHRONIZATION</button>
            <div id="status-text" style="font-size:0.7rem; color:var(--c-accent); margin-top:15px; text-align:right; opacity:0.6;">SYSTEM STANDBY</div>
        </div>

        <div id="result-panel">
            <div class="result-header">
                <div class="result-title" id="res-title">ANALYZING...</div>
                <div class="result-type" id="res-type">WAIT</div>
            </div>
            <div class="result-body" id="res-body">
                Calculating planetary alignments...
            </div>
            <div class="result-strategy" id="res-strategy">
                // Strategy will appear here
            </div>
            <div style="font-size:0.7rem; color:#555; margin-top:10px; font-family:'Rajdhani'">
                SCORE: EXP <span id="sc-exp">0</span> / STB <span id="sc-stb">0</span> / SPI <span id="sc-spi">0</span>
            </div>

            <div class="action-row">
                <button class="btn-action" onclick="app.saveImage()">ğŸ“· SAVE IMAGE</button>
                <button class="btn-action" onclick="app.saveCalendar()">ğŸ“… CALENDAR</button>
                <button class="btn-action" onclick="app.shareSNS()">ğŸ¦ X / TWITTER</button>
                <button class="btn-action" onclick="app.resetUI()">â†º RESET</button>
            </div>
        </div>
    </div>

    <div id="logic-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="app.toggleLogic()">Ã—</span>
            <h2 style="font-family:'Shippori Mincho'; color:var(--c-accent);">è§£æãƒ­ã‚¸ãƒƒã‚¯ã¨æ ¹æ‹ </h2>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:30px;">æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ä»¥ä¸‹ã®13ã®è¦³ç‚¹ã‚’ã€ŒCNLã‚¨ãƒ³ã‚¸ãƒ³ã€ã«ã‚ˆã‚Šçµ±åˆã—ã€çŸ›ç›¾ã‚’èª¿åœã—ã¦ã„ã¾ã™ã€‚</p>
            
            <div class="logic-grid">
                <div class="logic-item">
                    <h4>Micro Cosmos (å€‹)</h4>
                    <p style="font-size:0.8rem; color:#ccc;">ç”Ÿå¹´æœˆæ—¥ã€åå¹²åäºŒæ”¯ã€å…«å¦ã€ä¹æ˜Ÿæ°—å­¦ã‚’ç”¨ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€Œå‘¨æ³¢æ•°ï¼ˆå±æ€§ï¼‰ã€ã‚’å®šç¾©ã—ã¾ã™ã€‚</p>
                </div>
                <div class="logic-item">
                    <h4>Macro Cosmos (ç’°å¢ƒ)</h4>
                    <p style="font-size:0.8rem; color:#ccc;">æœ¨æ˜Ÿï¼ˆæ‹¡å¤§ï¼‰ã€åœŸæ˜Ÿï¼ˆè©¦ç·´ï¼‰ã€æ­³å·®é‹å‹•ï¼ˆæ™‚ä»£ï¼‰ã®ç¾åœ¨ä½ç½®ã‹ã‚‰ã€ç¤¾ä¼šçš„ãªã€Œé¢¨å‘ãã€ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</p>
                </div>
                <div class="logic-item">
                    <h4>Conflict Resolution</h4>
                    <p style="font-size:0.8rem; color:#ccc;">ã€Œæ‹¡å¤§æœŸã€ã¨ã€Œç©ºäº¡ï¼ˆå¤©ä¸­æ®ºï¼‰ã€ãŒé‡ãªã‚‹å ´åˆãªã©ã€çŸ›ç›¾ã™ã‚‹ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’ãƒ™ã‚¯ãƒˆãƒ«åˆæˆã—ã€ã€Œãƒ‰ãƒªãƒ•ãƒˆèµ°è¡Œã€ãªã©ã®é«˜åº¦ãªæˆ¦ç•¥ã‚’å°ãå‡ºã—ã¾ã™ã€‚</p>
                </div>
                <div class="logic-item">
                    <h4>Algorithm</h4>
                    <p style="font-size:0.8rem; color:#ccc;">$$Score = (PlanetaryPower \times Aspect) + (EasternSupport \times Decay)$$<br>ç‹¬è‡ªã®é‡ã¿ä»˜ã‘è¨ˆç®—å¼ã‚’æ¡ç”¨ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="app.toggleHistory()">Ã—</span>
            <h2 style="font-family:'Shippori Mincho'; color:var(--c-accent);">è§£æå±¥æ­´</h2>
            <div id="history-list" style="margin-top:20px;">
                </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        /**
         * ----------------------------------------------------
         * COSMIC NEURAL LOGIC ENGINE (CNL)
         * ----------------------------------------------------
         */
        class LogicEngine {
            constructor() {
                // Mock Cosmic State (Current Environment)
                this.cosmicState = {
                    jupiter: { element: 'WATER', status: 'EXPANSION' },
                    saturn: { element: 'EARTH', status: 'RETROGRADE' }, // é€†è¡Œä¸­
                    gate: { isOpen: true, intensity: 0.9 } // ãƒ©ã‚¤ã‚ªãƒ³ã‚ºã‚²ãƒ¼ãƒˆ
                };
            }

            // 1. Identify User Attribute (Simple Logic based on last digit of year)
            analyzeAttribute(dateStr) {
                const year = parseInt(dateStr.split('-')[0]);
                const lastDigit = year % 10;
                // 0-1:Metal, 2-3:Water, 4-5:Wood, 6-7:Fire, 8-9:Earth
                const types = [
                    { t:'METAL', n:'é‹¼ (Structure)', c:'#aaddff' }, { t:'METAL', n:'å®çŸ³ (Value)', c:'#aaddff' },
                    { t:'WATER', n:'å¤§æ²³ (Flow)', c:'#3366ff' }, { t:'WATER', n:'é›¨éœ² (Intellect)', c:'#3366ff' },
                    { t:'WOOD', n:'å¤§æ¨¹ (Growth)', c:'#22ff88' }, { t:'WOOD', n:'è‰èŠ± (Connect)', c:'#22ff88' },
                    { t:'FIRE', n:'å¤ªé™½ (Passion)', c:'#ff3300' }, { t:'FIRE', n:'ç¯ç« (Insight)', c:'#ff3300' },
                    { t:'EARTH', n:'å±±å²³ (Base)', c:'#D4AF37' }, { t:'EARTH', n:'å¤§åœ° (Nurture)', c:'#D4AF37' }
                ];
                return types[lastDigit];
            }

            // 2. Matrix Calculation
            calculate(dateStr) {
                const attr = this.analyzeAttribute(dateStr);
                let result = {
                    type: 'STABLE', // SYNERGY, CONFLICT, MUTATION, STABLE
                    title: '',
                    body: '',
                    strategy: '',
                    scores: { exp:50, stb:50, spi:50 },
                    color: attr.c
                };

                // Logic Simulation
                // Fire/Water types react strongly to Lions Gate -> Mutation/Synergy
                if (attr.t === 'FIRE' || attr.t === 'WATER') {
                    if (this.cosmicState.gate.isOpen) {
                        result.type = 'MUTATION';
                        result.title = 'å¤‰ç•°ç‚¹ (MUTATION)';
                        result.body = `ã‚ãªãŸã®æœ¬è³ªã§ã‚ã‚‹ã€Œ${attr.n}ã€ãŒã€ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ãƒ©ã‚¤ã‚ªãƒ³ã‚ºã‚²ãƒ¼ãƒˆã¨å¼·çƒˆãªåŒ–å­¦åå¿œã‚’èµ·ã“ã—ã¦ã„ã¾ã™ã€‚é€šå¸¸ã§ã¯ã‚ã‚Šå¾—ãªã„é–ƒãã‚„ã€å¶ç„¶ã®å‡ºä¼šã„ãŒå¤šç™ºã™ã‚‹ãƒ•ã‚§ãƒ¼ã‚ºã§ã™ã€‚`;
                        result.strategy = 'ã€æˆ¦ç•¥çš„æè¨€ã€‘\næ—¢å­˜ã®ãƒ«ãƒ¼ãƒ«ã‚’ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚ä»Šã¯ã€Œé•å’Œæ„Ÿã€ã“ããŒæ­£è§£ã®ã‚³ãƒ³ãƒ‘ã‚¹ã§ã™ã€‚è»¢è·ã€ç‹¬ç«‹ã€å¼•ã£è¶Šã—ãªã©ã€ä¸å¯é€†ãªæ±ºæ–­ã‚’ä¸‹ã™ã®ã«ã€ã“ã‚Œã»ã©é©ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                        result.scores.spi = 95;
                        result.scores.exp = 80;
                        result.color = '#9D00FF'; // Purple for mutation
                    }
                }
                // Metal/Earth types clash with Water Jupiter -> Conflict
                else if (attr.t === 'METAL' || attr.t === 'EARTH') {
                    result.type = 'CONFLICT';
                    result.title = 'è©¦ç·´ã®å©å  (CRUCIBLE)';
                    result.body = `æ‹¡å¤§ã‚’ä¿ƒã™æœ¨æ˜Ÿã¨ã€ã‚ãªãŸã®å …å®Ÿãªæ€§è³ªï¼ˆ${attr.n}ï¼‰ãŒæ‘©æ“¦ã‚’èµ·ã“ã—ã¦ã„ã¾ã™ã€‚ã‚¢ã‚¯ã‚»ãƒ«ã‚’è¸ã¿ãªãŒã‚‰ãƒ–ãƒ¬ãƒ¼ã‚­ãŒã‹ã‹ã‚‹ã‚ˆã†ãªã€ç„¦ç‡¥æ„Ÿã‚’æ„Ÿã˜ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚`;
                    result.strategy = 'ã€æˆ¦ç•¥çš„æè¨€ã€‘\nã“ã®æ‘©æ“¦ç†±ã‚’ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«å¤‰ãˆã¦ãã ã•ã„ã€‚å¤–ã«æ‰“ã£ã¦å‡ºã‚‹ã‚ˆã‚Šã€å†…éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã®åˆ·æ–°ï¼ˆå‹‰å¼·ãƒ»ç­‹ãƒˆãƒ¬ãƒ»æ–­æ¨é›¢ï¼‰ã«æŠ•è³‡ã™ã¹ãæ™‚ã§ã™ã€‚ä»Šè“„ãˆãŸåŠ›ã¯ã€åŠå¹´å¾Œã«çˆ†ç™ºçš„ãªåˆ©ç›Šã‚’ç”Ÿã¿ã¾ã™ã€‚';
                    result.scores.stb = 85;
                    result.scores.exp = 30;
                    result.color = '#ff3366'; // Red for conflict
                }
                // Wood types Synergy with Water Jupiter
                else {
                    result.type = 'SYNERGY';
                    result.title = 'å®Œå…¨è¦šé†’ (AWAKENING)';
                    result.body = `æ°´ï¼ˆæœ¨æ˜Ÿï¼‰ãŒæœ¨ï¼ˆã‚ãªãŸï¼‰ã‚’è‚²ã¦ã‚‹ã€å®Œç’§ãªå¾ªç’°ã«å…¥ã‚Šã¾ã—ãŸã€‚åŠªåŠ›ãŒãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«æˆæœã«çµã³ã¤ãã¾ã™ã€‚è¿½ã„é¢¨ãŒå¹ã„ã¦ã„ã¾ã™ã€‚`;
                    result.strategy = 'ã€æˆ¦ç•¥çš„æè¨€ã€‘\né æ…®ã¯ç½ªã§ã™ã€‚ã‚ãªãŸã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ä¸–ç•Œã«ç™ºä¿¡ã—ã¦ãã ã•ã„ã€‚å¤±æ•—ã¨ã„ã†æ¦‚å¿µãŒä¸€æ™‚çš„ã«æ¶ˆå¤±ã—ã¦ã„ã¾ã™ã€‚';
                    result.scores.exp = 95;
                    result.scores.stb = 60;
                    result.color = '#D4AF37'; // Gold for synergy
                }
                
                return result;
            }
        }

        /**
         * ----------------------------------------------------
         * VISUAL ENGINE (Three.js)
         * ----------------------------------------------------
         */
        class VisualEngine {
            constructor() {
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.FogExp2(0x020205, 0.002);
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.camera.position.z = 30;
                this.camera.position.y = 5;
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                document.getElementById('canvas-container').appendChild(this.renderer.domElement);
                
                this.orbits = [];
                this.core = null;
                this.analyzeMode = false;
                this.targetColor = new THREE.Color(0x00f0ff);

                this.initObjects();
                this.animate();
            }

            initObjects() {
                // Core
                const coreGeo = new THREE.IcosahedronGeometry(1.5, 1);
                const coreMat = new THREE.MeshBasicMaterial({ color: 0x00f0ff, wireframe: true, transparent:true, opacity:0.5 });
                this.core = new THREE.Mesh(coreGeo, coreMat);
                this.scene.add(this.core);

                // Orbits
                for(let i=1; i<=13; i++) {
                    const dist = 5 + i * 1.5;
                    const ringGeo = new THREE.RingGeometry(dist, dist+0.03, 64);
                    const ringMat = new THREE.MeshBasicMaterial({ color: 0x445566, side:THREE.DoubleSide, transparent:true, opacity:0.15 });
                    const ring = new THREE.Mesh(ringGeo, ringMat);
                    ring.rotation.x = Math.PI/2;
                    this.scene.add(ring);

                    const pivot = new THREE.Group();
                    const planet = new THREE.Mesh(new THREE.SphereGeometry(0.2,16,16), new THREE.MeshBasicMaterial({color:0xffffff}));
                    planet.position.x = dist;
                    pivot.add(planet);
                    pivot.rotation.x = (Math.random()-0.5);
                    this.scene.add(pivot);
                    
                    this.orbits.push({ pivot: pivot, speed: 0.002 + Math.random()*0.005, mesh: planet });
                }

                // Stars
                const starGeo = new THREE.BufferGeometry();
                const starPos = new Float32Array(3000*3);
                for(let i=0; i<3000*3; i++) starPos[i] = (Math.random()-0.5)*200;
                starGeo.setAttribute('position', new THREE.BufferAttribute(starPos,3));
                this.scene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({color:0x88ccee, size:0.1})));
            }

            animate() {
                requestAnimationFrame(this.animate.bind(this));
                
                // Color interpolation
                this.core.material.color.lerp(this.targetColor, 0.05);

                this.core.rotation.y -= 0.005;
                this.orbits.forEach(o => {
                    o.pivot.rotation.y += this.analyzeMode ? 0.1 : o.speed;
                    o.mesh.material.color.lerp(this.targetColor, 0.05);
                });
                this.renderer.render(this.scene, this.camera);
            }
            
            setMode(isActive, hexColor) {
                this.analyzeMode = isActive;
                if(hexColor) this.targetColor.set(hexColor);
            }
        }

        /**
         * ----------------------------------------------------
         * AUDIO ENGINE (Web Audio API)
         * ----------------------------------------------------
         */
        class AudioEngine {
            constructor() {
                this.ctx = null;
                this.master = null;
                this.osc = [];
                this.isMuted = false;
            }
            init() {
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.master = this.ctx.createGain();
                this.master.connect(this.ctx.destination);
                this.master.gain.value = 0.3;
                
                // Drone 1 (Base)
                this.createOsc(55, 'sine');
                // Drone 2 (Binaural)
                this.createOsc(55.5, 'triangle');
            }
            createOsc(freq, type) {
                const o = this.ctx.createOscillator();
                o.type = type;
                o.frequency.value = freq;
                const g = this.ctx.createGain();
                g.gain.value = 0.5;
                o.connect(g);
                g.connect(this.master);
                o.start();
                this.osc.push(o);
            }
            tune(freq) {
                if(!this.ctx) return;
                const now = this.ctx.currentTime;
                this.osc[0].frequency.exponentialRampToValueAtTime(freq, now+2);
                this.osc[1].frequency.exponentialRampToValueAtTime(freq+0.5, now+2);
            }
            toggleMute() {
                this.isMuted = !this.isMuted;
                if(this.master) this.master.gain.setTargetAtTime(this.isMuted?0:0.3, this.ctx.currentTime, 0.1);
                return this.isMuted;
            }
        }

        /**
         * ----------------------------------------------------
         * MAIN APP CONTROLLER
         * ----------------------------------------------------
         */
        const app = {
            logic: new LogicEngine(),
            visual: null,
            audio: new AudioEngine(),
            resultData: null,

            init: function() {
                document.getElementById('start-overlay').style.opacity = 0;
                setTimeout(()=> document.getElementById('start-overlay').style.display='none', 800);
                
                this.visual = new VisualEngine();
                this.audio.init();
            },

            runAnalysis: function() {
                const date = document.getElementById('inp-date').value;
                if(!date) return;

                // 1. UI Transition
                document.getElementById('status-text').innerText = "CALCULATING VECTORS...";
                document.getElementById('control-panel').style.opacity = 0;
                document.getElementById('control-panel').style.pointerEvents = 'none';

                // 2. Logic Execution
                this.resultData = this.logic.calculate(date);
                
                // 3. Audio/Visual Sync
                this.visual.setMode(true, this.resultData.color);
                
                // Frequency based on date (simple hash)
                const freq = 50 + (parseInt(date.slice(-2)) * 2); 
                this.audio.tune(freq);

                // 4. Save History
                this.saveToHistory(date, this.resultData);

                // 5. Show Result (Delay)
                setTimeout(() => {
                    this.visual.setMode(false); // Slow down spin
                    this.showResult(this.resultData);
                }, 2000);
            },

            showResult: function(data) {
                const panel = document.getElementById('result-panel');
                
                // Text Injection
                document.getElementById('res-title').innerText = data.title;
                document.getElementById('res-type').innerText = data.type;
                document.getElementById('res-type').style.color = data.color;
                document.getElementById('res-type').style.borderColor = data.color;
                document.getElementById('res-body').innerText = data.body;
                document.getElementById('res-strategy').innerText = data.strategy;
                document.getElementById('result-panel').style.borderColor = data.color;

                document.getElementById('sc-exp').innerText = data.scores.exp;
                document.getElementById('sc-stb').innerText = data.scores.stb;
                document.getElementById('sc-spi').innerText = data.scores.spi;

                panel.classList.add('active');
            },

            resetUI: function() {
                document.getElementById('result-panel').classList.remove('active');
                document.getElementById('control-panel').style.opacity = 1;
                document.getElementById('control-panel').style.pointerEvents = 'auto';
                document.getElementById('status-text').innerText = "SYSTEM STANDBY";
                this.visual.setMode(false, '#00f0ff');
                this.audio.tune(55); // Reset pitch
            },

            // --- UTILITIES ---

            toggleMute: function() {
                const m = this.audio.toggleMute();
                document.getElementById('btn-sound').innerText = m ? "AUDIO: OFF" : "AUDIO: ON";
            },

            toggleLogic: function() {
                const el = document.getElementById('logic-modal');
                el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
            },

            toggleHistory: function() {
                const el = document.getElementById('history-modal');
                el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
                if(el.style.display === 'flex') this.renderHistory();
            },

            saveImage: function() {
                const target = document.getElementById('result-panel');
                html2canvas(target, { backgroundColor: '#05080f' }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'cosmic-diagnosis.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            },

            saveCalendar: function() {
                if(!this.resultData) return;
                // Add event for tomorrow
                const d = new Date();
                d.setDate(d.getDate() + 1);
                const dateStr = d.toISOString().replace(/-|:|\.\d\d\d/g,"").slice(0,8);
                
                const title = encodeURIComponent(`ã€å‘¨æœŸå¾‹æˆ¦ç•¥ã€‘${this.resultData.title}`);
                const details = encodeURIComponent(this.resultData.strategy);
                const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dateStr}/${dateStr}&details=${details}`;
                window.open(url, '_blank');
            },

            shareSNS: function() {
                if(!this.resultData) return;
                const text = encodeURIComponent(`ç§ã®å‘¨æœŸå¾‹è¨ºæ–­çµæœï¼šã€${this.resultData.title}ã€‘\næˆ¦ç•¥ï¼š${this.resultData.strategy.substring(0, 30)}...\n#CosmicNeuralNetwork`);
                const url = `https://twitter.com/intent/tweet?text=${text}`;
                window.open(url, '_blank');
            },

            saveToHistory: function(date, data) {
                let history = JSON.parse(localStorage.getItem('cnl_history') || '[]');
                history.unshift({ date: new Date().toLocaleString(), dob: date, title: data.title });
                localStorage.setItem('cnl_history', JSON.stringify(history.slice(0, 10))); // Max 10 items
            },

            renderHistory: function() {
                const list = document.getElementById('history-list');
                const history = JSON.parse(localStorage.getItem('cnl_history') || '[]');
                if(history.length === 0) {
                    list.innerHTML = "<div style='color:#666'>NO HISTORY FOUND</div>";
                    return;
                }
                list.innerHTML = history.map(h => `
                    <div style="border-bottom:1px solid #333; padding:10px 0;">
                        <div style="font-size:0.7rem; color:#888;">${h.date}</div>
                        <div style="color:var(--c-accent);">${h.title}</div>
                    </div>
                `).join('');
            }
        };
    </script>
</body>
</html>
