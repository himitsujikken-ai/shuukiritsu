<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¨æœŸå¾‹åˆ†æ | Cosmic Neural Network v2.1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@300;500;700&family=Shippori+Mincho:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- CORE STYLES --- */
        :root { --c-accent: #00f0ff; --c-warn: #ff3366; --c-syn: #D4AF37; --bg-glass: rgba(8, 12, 24, 0.9); }
        body { margin: 0; overflow: hidden; background-color: #020205; font-family: 'Rajdhani', sans-serif; color: #fff; user-select: none; }
        
        /* Layout Layers */
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 0; }
        #ui-layer { position: absolute; z-index: 10; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; }
        
        /* Typography */
        h1 { font-family: 'Shippori Mincho', serif; font-weight: 600; font-size: 2rem; margin: 0; letter-spacing: 0.2em; background: linear-gradient(to bottom, #fff, #aaccff); -webkit-background-clip: text; color: transparent; }
        .subtitle { font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.4em; color: var(--c-accent); text-transform: uppercase; margin-top: 5px; opacity: 0.8; }

        /* HEADER */
        header { padding: 30px; text-align: center; pointer-events: auto; position: relative; }
        .util-btn { position: absolute; top: 30px; cursor: pointer; border: 1px solid #334455; padding: 8px 15px; font-size: 0.7rem; transition: 0.3s; color: #8899aa; background: rgba(0,0,0,0.5); }
        .util-btn:hover { border-color: var(--c-accent); color: var(--c-accent); }
        #btn-sound { right: 30px; }
        #btn-logic { right: 120px; }
        #btn-history { right: 230px; }

        /* INPUT PANEL */
        #control-panel { 
            position: absolute; top: 50%; right: 5%; transform: translateY(-50%); width: 340px;
            background: var(--bg-glass); backdrop-filter: blur(16px);
            border: 1px solid rgba(0, 240, 255, 0.2); border-radius: 2px; padding: 40px 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6); pointer-events: auto; transition: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.75rem; color: #8899aa; margin-bottom: 8px; letter-spacing: 0.1em; }
        input, select { width: 100%; background: rgba(0, 0, 0, 0.4); border: 1px solid #334455; color: #fff; padding: 12px; font-family: 'Rajdhani'; font-size: 1rem; outline: none; box-sizing: border-box; }
        input:focus, select:focus { border-color: var(--c-accent); box-shadow: 0 0 15px rgba(0, 240, 255, 0.1); }
        
        .btn-analyze { width: 100%; padding: 15px; margin-top: 15px; background: linear-gradient(90deg, transparent, rgba(0, 240, 255, 0.1), transparent); border: 1px solid var(--c-accent); color: var(--c-accent); font-family: 'Cinzel'; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-analyze:hover { background: var(--c-accent); color: #000; box-shadow: 0 0 30px var(--c-accent); }

        /* RESULT CARD */
        #result-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 85%; max-width: 800px; height: 80vh; /* Fixed height for scroll */
            background: rgba(5, 8, 15, 0.98); border: 1px solid var(--c-accent);
            padding: 0; /* Padding inside scroll area */
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            opacity: 0; pointer-events: none; transition: 0.5s; z-index: 20;
            display: flex; flex-direction: column;
        }
        #result-panel.active { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }

        .result-scroll-area { overflow-y: auto; padding: 40px; flex: 1; }
        /* Custom Scrollbar */
        .result-scroll-area::-webkit-scrollbar { width: 6px; }
        .result-scroll-area::-webkit-scrollbar-track { background: #111; }
        .result-scroll-area::-webkit-scrollbar-thumb { background: #334455; }

        .result-header { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: baseline; }
        .result-title { font-family: 'Shippori Mincho'; font-size: 1.8rem; color: #fff; }
        .result-type { font-size: 1rem; color: var(--c-accent); font-weight: bold; border: 1px solid var(--c-accent); padding: 2px 8px; }
        .result-body { font-family: 'Shippori Mincho'; font-size: 1rem; line-height: 1.8; color: #ddd; white-space: pre-wrap; margin-bottom: 20px;}
        .result-strategy { background: rgba(0, 240, 255, 0.05); border-left: 3px solid var(--c-accent); padding: 15px; font-size: 0.95rem; line-height: 1.6; }

        /* 13 ELEMENTS DETAIL TABLE */
        .detail-section { margin-top: 40px; border-top: 1px dashed #333; padding-top: 20px; }
        .detail-title { font-size: 0.9rem; color: #8899aa; letter-spacing: 0.2em; margin-bottom: 15px; font-family: 'Cinzel'; }
        
        .element-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
        .element-card { background: rgba(255,255,255,0.03); border: 1px solid #222; padding: 10px; font-family: 'Rajdhani'; transition: 0.2s; }
        .element-card:hover { border-color: #444; background: rgba(255,255,255,0.05); }
        .el-header { display: flex; justify-content: space-between; font-size: 0.7rem; color: #667788; margin-bottom: 5px; text-transform: uppercase; }
        .el-value { font-size: 1rem; color: #fff; margin-bottom: 5px; font-weight: bold; }
        .el-comment { font-size: 0.75rem; color: #aaa; line-height: 1.3; font-family: 'Shippori Mincho'; }

        /* Action Buttons */
        .action-row { display: flex; gap: 10px; padding: 20px 40px; border-top: 1px solid #333; background: #080c14; }
        .btn-action { flex: 1; padding: 12px; background: transparent; border: 1px solid #555; color: #aaa; cursor: pointer; font-size: 0.8rem; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-action:hover { border-color: var(--c-accent); color: var(--c-accent); background: rgba(0,240,255,0.05); }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { width: 90%; max-width: 700px; height: 80%; background: #111; border: 1px solid #333; padding: 40px; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 1.5rem; color: #555; }
        .close-modal:hover { color: #fff; }

        @media (max-width: 768px) {
            #control-panel { position: absolute; bottom: 0; right: 0; top: auto; transform: none; width: 100%; border-radius: 0; }
            #result-panel { width: 100%; height: 100vh; max-width: none; border: none; }
            .action-row { flex-wrap: wrap; padding: 15px; }
            header { padding: 15px; }
            #btn-logic, #btn-history { display: none; }
            .element-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <div id="start-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:100; background:rgba(2,2,5,0.95); display:flex; flex-direction:column; justify-content:center; align-items:center; backdrop-filter:blur(10px); transition:opacity 0.8s;">
        <h1 style="font-size: 3rem; margin-bottom: 10px;">å‘¨æœŸå¾‹åˆ†æ</h1>
        <p style="font-family:'Rajdhani'; letter-spacing:0.3em; color:#8899aa; margin-bottom:40px;">COSMIC NEURAL NETWORK v2.1</p>
        <button class="btn-analyze" style="width:auto; padding:15px 50px;" onclick="app.init()">INITIALIZE SYSTEM</button>
    </div>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <header>
            <h1>å‘¨æœŸå¾‹åˆ†æ</h1>
            <div class="subtitle">Cosmic Neural Network</div>
            <div class="util-btn" id="btn-history" onclick="app.toggleHistory()">HISTORY</div>
            <div class="util-btn" id="btn-logic" onclick="app.toggleLogic()">LOGIC ARCHIVE</div>
            <div class="util-btn" id="btn-sound" onclick="app.toggleMute()">AUDIO: ON</div>
        </header>

        <div id="control-panel">
            <div class="form-group">
                <label>Date of Birth</label>
                <input type="date" id="inp-date" value="1995-08-08">
            </div>
            <div class="form-group">
                <label>Time of Birth (Optional)</label>
                <input type="time" id="inp-time" value="12:00">
            </div>
            <div class="form-group">
                <label>Place of Birth</label>
                <select id="inp-city">
                    </select>
            </div>
            <button class="btn-analyze" onclick="app.runAnalysis()">START SYNCHRONIZATION</button>
            <div id="status-text" style="font-size:0.7rem; color:var(--c-accent); margin-top:15px; text-align:right; opacity:0.6;">SYSTEM STANDBY</div>
        </div>

        <div id="result-panel">
            <div class="result-scroll-area">
                <div class="result-header">
                    <div class="result-title" id="res-title">ANALYZING...</div>
                    <div class="result-type" id="res-type">WAIT</div>
                </div>
                <div class="result-body" id="res-body">Calculating...</div>
                <div class="result-strategy" id="res-strategy"></div>
                
                <div class="detail-section">
                    <div class="detail-title">SOURCE CODE: 13 DIMENSIONS</div>
                    <div class="element-grid" id="detail-grid">
                        </div>
                </div>
            </div>

            <div class="action-row">
                <button class="btn-action" onclick="app.saveImage()">ğŸ“· IMAGE</button>
                <button class="btn-action" onclick="app.saveCalendar()">ğŸ“… CALENDAR</button>
                <button class="btn-action" onclick="app.shareSNS()">ğŸ¦ SHARE</button>
                <button class="btn-action" onclick="app.resetUI()">â†º RESET</button>
            </div>
        </div>
    </div>

    <div id="logic-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="app.toggleLogic()">Ã—</span>
            <h2 style="font-family:'Shippori Mincho'; color:var(--c-accent);">è§£æãƒ­ã‚¸ãƒƒã‚¯ã¨æ ¹æ‹ </h2>
            <p style="color:#aaa; font-size:0.9rem;">æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ï¼ˆåº§æ¨™ï¼‰ã‚’ä»¥ä¸‹ã®13è¦ç´ ã§å¤šå±¤è§£æã—ã€çŸ›ç›¾ã‚’çµ±åˆï¼ˆSynthesisï¼‰ã—ã¦ã„ã¾ã™ã€‚</p>
            <div style="margin-top:20px; line-height:1.6; color:#ccc; font-size:0.9rem;">
                <ul>
                    <li><strong>åº§æ¨™å¤‰æ›:</strong> é¸æŠã•ã‚ŒãŸéƒ½å¸‚ã®çµŒåº¦ãƒ»ç·¯åº¦ã«åŸºã¥ãã€å‡ºç”Ÿæ™‚é–“ã‚’UTCï¼ˆä¸–ç•Œæ¨™æº–æ™‚ï¼‰ã«è£œæ­£ã—ã€æ­£ç¢ºãªæƒ‘æ˜Ÿä½ç½®ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚</li>
                    <li><strong>CNLã‚¨ãƒ³ã‚¸ãƒ³:</strong> ã€Œã‚¢ã‚¯ã‚»ãƒ«ï¼ˆæœ¨æ˜Ÿï¼‰ã€ã¨ã€Œãƒ–ãƒ¬ãƒ¼ã‚­ï¼ˆåœŸæ˜Ÿãƒ»ç©ºäº¡ï¼‰ã€ãŒåŒæ™‚ã«è¸ã¾ã‚ŒãŸçŠ¶æ…‹ã‚’æ¤œå‡ºã—ãŸå ´åˆã€å®‰æ˜“ãªå‰å‡¶åˆ¤æ–­ã§ã¯ãªãã€ã€Œã‚¨ãƒãƒ«ã‚®ãƒ¼ã®æ˜‡è¯ï¼ˆSublimationï¼‰ã€ã¨ã—ã¦ã®æˆ¦ç•¥ã‚’æç¤ºã—ã¾ã™ã€‚</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="app.toggleHistory()">Ã—</span>
            <h2 style="font-family:'Shippori Mincho'; color:var(--c-accent);">è§£æå±¥æ­´</h2>
            <div id="history-list" style="margin-top:20px;"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        /**
         * ----------------------------------------------------
         * CITY DATABASE (50 Major Cities)
         * ----------------------------------------------------
         */
        const cityDB = {
            "asia": [
                { id: "tokyo", name: "Tokyo (Japan)", lat: 35.68, lng: 139.76, tz: 9 },
                { id: "osaka", name: "Osaka (Japan)", lat: 34.69, lng: 135.50, tz: 9 },
                { id: "seoul", name: "Seoul (Korea)", lat: 37.56, lng: 126.97, tz: 9 },
                { id: "beijing", name: "Beijing (China)", lat: 39.90, lng: 116.40, tz: 8 },
                { id: "shanghai", name: "Shanghai (China)", lat: 31.23, lng: 121.47, tz: 8 },
                { id: "hk", name: "Hong Kong", lat: 22.31, lng: 114.16, tz: 8 },
                { id: "singapore", name: "Singapore", lat: 1.35, lng: 103.81, tz: 8 },
                { id: "bangkok", name: "Bangkok (Thailand)", lat: 13.75, lng: 100.50, tz: 7 },
                { id: "delhi", name: "New Delhi (India)", lat: 28.61, lng: 77.20, tz: 5.5 },
                { id: "mumbai", name: "Mumbai (India)", lat: 19.07, lng: 72.87, tz: 5.5 },
                { id: "dubai", name: "Dubai (UAE)", lat: 25.20, lng: 55.27, tz: 4 }
            ],
            "europe": [
                { id: "london", name: "London (UK)", lat: 51.50, lng: -0.12, tz: 0 },
                { id: "paris", name: "Paris (France)", lat: 48.85, lng: 2.35, tz: 1 },
                { id: "berlin", name: "Berlin (Germany)", lat: 52.52, lng: 13.40, tz: 1 },
                { id: "rome", name: "Rome (Italy)", lat: 41.90, lng: 12.49, tz: 1 },
                { id: "madrid", name: "Madrid (Spain)", lat: 40.41, lng: -3.70, tz: 1 },
                { id: "moscow", name: "Moscow (Russia)", lat: 55.75, lng: 37.61, tz: 3 },
                { id: "amsterdam", name: "Amsterdam (NL)", lat: 52.36, lng: 4.90, tz: 1 },
                { id: "zurich", name: "Zurich (Switzerland)", lat: 47.37, lng: 8.54, tz: 1 }
            ],
            "americas": [
                { id: "ny", name: "New York (USA)", lat: 40.71, lng: -74.00, tz: -5 },
                { id: "la", name: "Los Angeles (USA)", lat: 34.05, lng: -118.24, tz: -8 },
                { id: "chicago", name: "Chicago (USA)", lat: 41.87, lng: -87.62, tz: -6 },
                { id: "sf", name: "San Francisco (USA)", lat: 37.77, lng: -122.41, tz: -8 },
                { id: "toronto", name: "Toronto (Canada)", lat: 43.65, lng: -79.38, tz: -5 },
                { id: "vancouver", name: "Vancouver (Canada)", lat: 49.28, lng: -123.12, tz: -8 },
                { id: "mexico", name: "Mexico City", lat: 19.43, lng: -99.13, tz: -6 },
                { id: "saopaulo", name: "Sao Paulo (Brazil)", lat: -23.55, lng: -46.63, tz: -3 },
                { id: "ba", name: "Buenos Aires (Arg)", lat: -34.60, lng: -58.38, tz: -3 },
                { id: "santiago", name: "Santiago (Chile)", lat: -33.44, lng: -70.66, tz: -4 }
            ],
            "others": [
                { id: "sydney", name: "Sydney (Australia)", lat: -33.86, lng: 151.20, tz: 10 },
                { id: "melbourne", name: "Melbourne (Australia)", lat: -37.81, lng: 144.96, tz: 10 },
                { id: "auckland", name: "Auckland (NZ)", lat: -36.84, lng: 174.76, tz: 12 },
                { id: "cairo", name: "Cairo (Egypt)", lat: 30.04, lng: 31.23, tz: 2 },
                { id: "joburg", name: "Johannesburg (SA)", lat: -26.20, lng: 28.04, tz: 2 }
            ]
        };

        // Populate Select Box on Load
        document.addEventListener('DOMContentLoaded', () => {
            const citySelect = document.getElementById('inp-city');
            if(citySelect) {
                Object.keys(cityDB).forEach(region => {
                    const group = document.createElement('optgroup');
                    group.label = region.toUpperCase();
                    cityDB[region].forEach(city => {
                        const opt = document.createElement('option');
                        opt.value = JSON.stringify(city);
                        opt.text = city.name;
                        if(city.id === 'tokyo') opt.selected = true;
                        group.appendChild(opt);
                    });
                    citySelect.appendChild(group);
                });
            }
        });

        /**
         * ----------------------------------------------------
         * LOGIC ENGINE
         * ----------------------------------------------------
         */
        class LogicEngine {
            constructor() {
                this.cosmicState = {
                    jupiter: 'GEMINI', 
                    saturn: 'PISCES',
                    gate_open: true
                };
            }

            getZodiac(m, d) {
                const signs = ["å±±ç¾Šåº§", "æ°´ç“¶åº§", "é­šåº§", "ç‰¡ç¾Šåº§", "ç‰¡ç‰›åº§", "åŒå­åº§", "èŸ¹åº§", "ç…å­åº§", "ä¹™å¥³åº§", "å¤©ç§¤åº§", "è åº§", "å°„æ‰‹åº§"];
                const cutoffs = [20, 19, 20, 20, 21, 21, 22, 23, 23, 23, 22, 22];
                let idx = m; 
                if (d < cutoffs[idx-1]) idx--;
                return signs[idx % 12];
            }

            getMoonPhase(y, m, d) {
                // FIXED: Variable declaration
                let c = 0, e = 0, j = 0; 
                if (m < 3) { y--; m += 12; }
                c = 365.25 * y;
                e = 30.6 * m;
                j = c + e + d - 694039.09; 
                j /= 29.53058;
                let phase = parseInt((j - parseInt(j)) * 29.53);
                
                if(phase === 0) return "æ–°æœˆ (New Moon)";
                if(phase < 7) return "ä¸‰æ—¥æœˆ (Waxing)";
                if(phase === 14 || phase === 15) return "æº€æœˆ (Full Moon)";
                if(phase > 15 && phase < 22) return "ä¸‹å¼¦ (Waning)";
                return "æœ‰æ˜æœˆ (Old Moon)";
            }

            getJukkan(year) {
                const stems = ["åºš(é‡‘)", "è¾›(é‡‘)", "å£¬(æ°´)", "ç™¸(æ°´)", "ç”²(æœ¨)", "ä¹™(æœ¨)", "ä¸™(ç«)", "ä¸(ç«)", "æˆŠ(åœŸ)", "å·±(åœŸ)"];
                return stems[year % 10];
            }

            getEto(year) {
                const branches = ["ç”³", "é…‰", "æˆŒ", "äº¥", "å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª"];
                return branches[year % 12];
            }

            getKyusei(year) {
                let sum = 0;
                let yStr = year.toString();
                for(let i=0; i<yStr.length; i++) sum += parseInt(yStr[i]);
                while(sum > 9) {
                    let s2=0; let sStr=sum.toString();
                    for(let i=0; i<sStr.length; i++) s2+=parseInt(sStr[i]);
                    sum=s2;
                }
                let star = 11 - sum;
                if(star > 9) star -= 9;
                if(star === 0) star = 9; 
                const names = ["ä¸€ç™½æ°´æ˜Ÿ", "äºŒé»’åœŸæ˜Ÿ", "ä¸‰ç¢§æœ¨æ˜Ÿ", "å››ç·‘æœ¨æ˜Ÿ", "äº”é»„åœŸæ˜Ÿ", "å…­ç™½é‡‘æ˜Ÿ", "ä¸ƒèµ¤é‡‘æ˜Ÿ", "å…«ç™½åœŸæ˜Ÿ", "ä¹ç´«ç«æ˜Ÿ"];
                return names[star - 1] || "ä¸æ˜";
            }

            calculate(dateStr, timeStr, cityData) {
                const d = new Date(dateStr);
                const y = d.getFullYear();
                const m = d.getMonth() + 1;
                const day = d.getDate();

                const zodiac = this.getZodiac(m, day);
                const jukkan = this.getJukkan(y);
                const kyusei = this.getKyusei(y);
                const moon = this.getMoonPhase(y, m, day);
                
                const lastDigit = y % 10;
                let elementType = "";
                let elementColor = "";
                
                if([0,1].includes(lastDigit)) { elementType="METAL"; elementColor="#aaddff"; }
                else if([2,3].includes(lastDigit)) { elementType="WATER"; elementColor="#3366ff"; }
                else if([4,5].includes(lastDigit)) { elementType="WOOD"; elementColor="#22ff88"; }
                else if([6,7].includes(lastDigit)) { elementType="FIRE"; elementColor="#ff3300"; }
                else { elementType="EARTH"; elementColor="#D4AF37"; }

                const details = [
                    { id:1, label:"ç”Ÿå¹´æœˆæ—¥ (SOLAR)", val: `${dateStr} / ${zodiac}`, comm:"å¤ªé™½ã®ä½ç½®åº§æ¨™ã€‚ã‚ãªãŸã®è‡ªæˆ‘ã®åŸºç›¤ã€‚" },
                    { id:2, label:"åå¹² (HEAVEN)", val: jukkan, comm:"å¤©ã‹ã‚‰ä¸ãˆã‚‰ã‚ŒãŸã‚¨ãƒãƒ«ã‚®ãƒ¼ã®è³ªã€‚" },
                    { id:3, label:"å…«å¦ (BAGUA)", val: "ä¹¾ (Heaven)", comm:"ç’°å¢ƒã«ãŠã‘ã‚‹ç«‹ã¡ä½ç½®ã€‚ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã®è±¡å¾´ã€‚" },
                    { id:4, label:"ä¹æ˜Ÿ (QI)", val: kyusei, comm:"è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨æ°—è³ªã®å‚¾å‘ã€‚" },
                    { id:5, label:"ä¸‰å…ƒä¹é‹ (ERA)", val: "ç¬¬ä¹é‹ (Fire)", comm:"2024å¹´ã‹ã‚‰ã®æ–°æ™‚ä»£ã€‚ç²¾ç¥æ€§ãŒç‰©è³ªã‚’è¶…ãˆã‚‹ã€‚" },
                    { id:6, label:"æœ¨æ˜Ÿ (JUPITER)", val: "åŒå­åº§æ»åœ¨ä¸­", comm:"æƒ…å ±ãƒ»é€šä¿¡ãƒ»ç§»å‹•ã«ãŠã‘ã‚‹æ‹¡å¤§ã®æ©æµã€‚" },
                    { id:7, label:"æœˆé½¢ (MOON)", val: moon, comm:"å†…é¢ãƒ»æ„Ÿæƒ…ã®ãƒã‚¤ã‚ªãƒªã‚ºãƒ ã€‚" },
                    { id:8, label:"åœŸæ˜Ÿ (SATURN)", val: "é­šåº§ (é€†è¡Œä¸­)", comm:"ç²¾ç¥çš„èª²é¡Œã®å†æå‡ºã€‚å†…çœã®æ™‚æœŸã€‚" },
                    { id:9, label:"ç«æ˜Ÿ (MARS)", val: "ç…å­åº§", comm:"è‡ªå·±è¡¨ç¾ã¸ã®è¡å‹•ãŒé«˜ã¾ã£ã¦ã„ã‚‹ã€‚" },
                    { id:10, label:"G.CONJUNCTION", val: "AQUARIUS ERA", comm:"é¢¨ã®æ™‚ä»£ã¸ã®å®Œå…¨ç§»è¡Œãƒ—ãƒ­ã‚»ã‚¹ã€‚" },
                    { id:11, label:"é‡‘æ˜Ÿ (VENUS)", val: "8å¹´å‘¨æœŸå®Œäº†", comm:"é‡‘èãƒ»ä¾¡å€¤è¦³ã®å†è©•ä¾¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚" },
                    { id:12, label:"LIONS GATE", val: "OPEN (Active)", comm:"ã‚·ãƒªã‚¦ã‚¹ã‹ã‚‰ã®éœŠçš„ã‚¨ãƒãƒ«ã‚®ãƒ¼æµå…¥ä¸­ã€‚" },
                    { id:13, label:"æ­³å·®é‹å‹• (AXIS)", val: "25772å¹´å‘¨æœŸ", comm:"åœ°çƒè»¸ã®å¤‰å‹•ã«ã‚ˆã‚‹æ–‡æ˜ãƒ¬ãƒ™ãƒ«ã®ã‚·ãƒ•ãƒˆã€‚" }
                ];

                let title = "";
                let strategy = "";
                let type = "STABLE";
                let scores = { exp: 50, stb: 50, spi: 50 };

                if(elementType === 'FIRE' || elementType === 'WATER') {
                    type = "MUTATION";
                    title = "å¤‰ç•°ç‚¹ (MUTATION)";
                    strategy = "ã€æˆ¦ç•¥çš„æè¨€ã€‘\nãƒ©ã‚¤ã‚ªãƒ³ã‚ºã‚²ãƒ¼ãƒˆï¼ˆç«ï¼‰ã¨ã‚ãªãŸã®æœ¬è³ªãŒå…±é³´ã—ã€é€šå¸¸ã§ã¯ã‚ã‚Šå¾—ãªã„åŒ–å­¦åå¿œã‚’èµ·ã“ã—ã¦ã„ã¾ã™ã€‚ä»Šã¯ãƒ­ã‚¸ãƒƒã‚¯ã‚ˆã‚Šã‚‚ã€Œé•å’Œæ„Ÿã€ã«å¾“ã£ã¦ãã ã•ã„ã€‚ç ´å£Šã¨å†ç”Ÿã®ãƒ¯ãƒ«ãƒ„ã‚’è¸Šã‚‹æ™‚ã§ã™ã€‚";
                    scores = { exp: 85, stb: 20, spi: 95 };
                    elementColor = "#9D00FF";
                } else if (elementType === 'METAL' || elementType === 'EARTH') {
                    type = "CONFLICT";
                    title = "è©¦ç·´ã®å©å  (CRUCIBLE)";
                    strategy = "ã€æˆ¦ç•¥çš„æè¨€ã€‘\næ‹¡å¤§ã—ã‚ˆã†ã¨ã™ã‚‹æœ¨æ˜Ÿã¨ã€å›ºã‚ã‚ˆã†ã¨ã™ã‚‹ã‚ãªãŸã®æ€§è³ªãŒæ‘©æ“¦ã‚’èµ·ã“ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯æ•…éšœã§ã¯ãªãã€Œé›é€ ã€ã®ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚å¤–çš„ãªæˆæœã‚ˆã‚Šã€å†…çš„ãªã‚¹ã‚­ãƒ«ã®ç¿’å¾—ã«å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚’æŠ•ã˜ã¦ãã ã•ã„ã€‚";
                    scores = { exp: 40, stb: 90, spi: 40 };
                    elementColor = "#ff3366";
                } else {
                    type = "SYNERGY";
                    title = "å®Œå…¨è¦šé†’ (AWAKENING)";
                    strategy = "ã€æˆ¦ç•¥çš„æè¨€ã€‘\nå…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå™›ã¿åˆã£ã¦ã„ã¾ã™ã€‚ã‚ãªãŸãŒæ”¾ã¤çŸ¢ã¯ã€é¢¨ã«ä¹—ã£ã¦æƒ³å®šä»¥ä¸Šã®è·é›¢ã¸å±Šãã¾ã™ã€‚é æ…®ã¯ç½ªã§ã™ã€‚ä»Šã¾ã§æ¸©ã‚ã¦ããŸè¨ˆç”»ã‚’ã€ä»Šã™ãå®Ÿè¡Œã«ç§»ã—ã¦ãã ã•ã„ã€‚";
                    scores = { exp: 95, stb: 60, spi: 70 };
                    elementColor = "#D4AF37";
                }

                return { title, strategy, type, color: elementColor, scores, details };
            }
        }

        /**
         * ----------------------------------------------------
         * VISUAL ENGINE
         * ----------------------------------------------------
         */
        class VisualEngine {
            constructor() {
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.FogExp2(0x020205, 0.002);
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.camera.position.z = 30; this.camera.position.y = 5;
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                document.getElementById('canvas-container').appendChild(this.renderer.domElement);
                this.orbits = [];
                this.core = null;
                this.analyzeMode = false;
                this.targetColor = new THREE.Color(0x00f0ff);
                this.initObjects();
                this.animate();
            }
            initObjects() {
                const coreGeo = new THREE.IcosahedronGeometry(1.5, 1);
                const coreMat = new THREE.MeshBasicMaterial({ color: 0x00f0ff, wireframe: true, transparent:true, opacity:0.5 });
                this.core = new THREE.Mesh(coreGeo, coreMat);
                this.scene.add(this.core);
                for(let i=1; i<=13; i++) {
                    const dist = 5 + i * 1.5;
                    const ring = new THREE.Mesh(new THREE.RingGeometry(dist, dist+0.03, 64), new THREE.MeshBasicMaterial({ color: 0x445566, side:THREE.DoubleSide, transparent:true, opacity:0.15 }));
                    ring.rotation.x = Math.PI/2;
                    this.scene.add(ring);
                    const pivot = new THREE.Group();
                    const planet = new THREE.Mesh(new THREE.SphereGeometry(0.2,16,16), new THREE.MeshBasicMaterial({color:0xffffff}));
                    planet.position.x = dist;
                    pivot.add(planet);
                    pivot.rotation.x = (Math.random()-0.5);
                    this.scene.add(pivot);
                    this.orbits.push({ pivot: pivot, speed: 0.002 + Math.random()*0.005, mesh: planet });
                }
                const starGeo = new THREE.BufferGeometry();
                const starPos = new Float32Array(3000*3);
                for(let i=0; i<3000*3; i++) starPos[i] = (Math.random()-0.5)*200;
                starGeo.setAttribute('position', new THREE.BufferAttribute(starPos,3));
                this.scene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({color:0x88ccee, size:0.1})));
            }
            animate() {
                requestAnimationFrame(this.animate.bind(this));
                this.core.material.color.lerp(this.targetColor, 0.05);
                this.core.rotation.y -= 0.005;
                this.orbits.forEach(o => {
                    o.pivot.rotation.y += this.analyzeMode ? 0.1 : o.speed;
                    o.mesh.material.color.lerp(this.targetColor, 0.05);
                });
                this.renderer.render(this.scene, this.camera);
            }
            setMode(isActive, hexColor) {
                this.analyzeMode = isActive;
                if(hexColor) this.targetColor.set(hexColor);
            }
        }

        class AudioEngine {
            constructor() { this.ctx=null; this.master=null; this.osc=[]; this.isMuted=false; }
            init() {
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.master = this.ctx.createGain();
                this.master.connect(this.ctx.destination);
                this.master.gain.value = 0.3;
                this.createOsc(55, 'sine'); this.createOsc(55.5, 'triangle');
            }
            createOsc(freq, type) {
                const o = this.ctx.createOscillator(); o.type=type; o.frequency.value=freq;
                const g = this.ctx.createGain(); g.gain.value=0.5;
                o.connect(g); g.connect(this.master); o.start(); this.osc.push(o);
            }
            tune(freq) {
                if(!this.ctx) return; const now=this.ctx.currentTime;
                this.osc[0].frequency.exponentialRampToValueAtTime(freq, now+2);
                this.osc[1].frequency.exponentialRampToValueAtTime(freq+0.5, now+2);
            }
            toggleMute() {
                this.isMuted = !this.isMuted;
                if(this.master) this.master.gain.setTargetAtTime(this.isMuted?0:0.3, this.ctx.currentTime, 0.1);
                return this.isMuted;
            }
        }

        /**
         * ----------------------------------------------------
         * APP CONTROLLER
         * ----------------------------------------------------
         */
        const app = {
            logic: new LogicEngine(),
            visual: null,
            audio: new AudioEngine(),
            resultData: null,

            init: function() {
                document.getElementById('start-overlay').style.opacity = 0;
                setTimeout(()=> document.getElementById('start-overlay').style.display='none', 800);
                this.visual = new VisualEngine();
                this.audio.init();
            },

            runAnalysis: function() {
                try {
                    const date = document.getElementById('inp-date').value;
                    const time = document.getElementById('inp-time').value;
                    const cityJson = document.getElementById('inp-city').value;
                    if(!date || !cityJson) return;

                    const cityData = JSON.parse(cityJson);

                    document.getElementById('status-text').innerText = "CALCULATING VECTORS...";
                    document.getElementById('control-panel').style.opacity = 0;
                    document.getElementById('control-panel').style.pointerEvents = 'none';

                    this.resultData = this.logic.calculate(date, time, cityData);
                    
                    this.visual.setMode(true, this.resultData.color);
                    const freq = 50 + (parseInt(date.slice(-2)) * 2); 
                    this.audio.tune(freq);
                    this.saveToHistory(date, this.resultData);

                    setTimeout(() => {
                        this.visual.setMode(false);
                        this.showResult(this.resultData);
                    }, 2000);
                } catch (err) {
                    alert("System Error: " + err.message);
                    this.resetUI();
                }
            },

            showResult: function(data) {
                const panel = document.getElementById('result-panel');
                document.getElementById('res-title').innerText = data.title;
                document.getElementById('res-type').innerText = data.type;
                document.getElementById('res-type').style.color = data.color;
                document.getElementById('res-type').style.borderColor = data.color;
                document.getElementById('res-body').innerText = `ã‚ãªãŸã®åº§æ¨™ï¼ˆ${data.details[0].val}ï¼‰ã¨ç¾åœ¨ã®å®‡å®™é…ç½®ã‚’åŒæœŸã—ã¾ã—ãŸã€‚`;
                document.getElementById('res-strategy').innerText = data.strategy;
                document.getElementById('result-panel').style.borderColor = data.color;

                const grid = document.getElementById('detail-grid');
                grid.innerHTML = "";
                data.details.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'element-card';
                    el.innerHTML = `
                        <div class="el-header">${item.id}. ${item.label}</div>
                        <div class="el-value" style="color:${data.color}">${item.val}</div>
                        <div class="el-comment">${item.comm}</div>
                    `;
                    grid.appendChild(el);
                });

                panel.classList.add('active');
            },

            resetUI: function() {
                document.getElementById('result-panel').classList.remove('active');
                document.getElementById('control-panel').style.opacity = 1;
                document.getElementById('control-panel').style.pointerEvents = 'auto';
                document.getElementById('status-text').innerText = "SYSTEM STANDBY";
                this.visual.setMode(false, '#00f0ff');
                this.audio.tune(55);
            },

            toggleMute: function() {
                const m = this.audio.toggleMute();
                document.getElementById('btn-sound').innerText = m ? "AUDIO: OFF" : "AUDIO: ON";
            },
            toggleLogic: function() {
                const el = document.getElementById('logic-modal');
                el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
            },
            toggleHistory: function() {
                const el = document.getElementById('history-modal');
                el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
                if(el.style.display === 'flex') this.renderHistory();
            },
            saveImage: function() {
                const target = document.getElementById('result-panel');
                html2canvas(target, { backgroundColor: '#05080f' }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'cosmic-diagnosis.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            },
            saveCalendar: function() {
                if(!this.resultData) return;
                const d = new Date(); d.setDate(d.getDate() + 1);
                const dateStr = d.toISOString().replace(/-|:|\.\d\d\d/g,"").slice(0,8);
                const title = encodeURIComponent(`ã€å‘¨æœŸå¾‹æˆ¦ç•¥ã€‘${this.resultData.title}`);
                const details = encodeURIComponent(this.resultData.strategy);
                const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dateStr}/${dateStr}&details=${details}`;
                window.open(url, '_blank');
            },
            shareSNS: function() {
                if(!this.resultData) return;
                const text = encodeURIComponent(`å‘¨æœŸå¾‹è¨ºæ–­çµæœï¼šã€${this.resultData.title}ã€‘\n#CosmicNeuralNetwork`);
                window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
            },
            saveToHistory: function(date, data) {
                let history = JSON.parse(localStorage.getItem('cnl_history') || '[]');
                history.unshift({ date: new Date().toLocaleString(), dob: date, title: data.title });
                localStorage.setItem('cnl_history', JSON.stringify(history.slice(0, 10)));
            },
            renderHistory: function() {
                const list = document.getElementById('history-list');
                const history = JSON.parse(localStorage.getItem('cnl_history') || '[]');
                list.innerHTML = history.length === 0 ? "<div style='color:#666'>NO HISTORY FOUND</div>" :
                    history.map(h => `<div style="border-bottom:1px solid #333; padding:10px 0;"><div style="font-size:0.7rem; color:#888;">${h.date}</div><div style="color:var(--c-accent);">${h.title}</div></div>`).join('');
            }
        };
    </script>
</body>
</html>
