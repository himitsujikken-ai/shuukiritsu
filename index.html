<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Neural Network v10.0 - Real Calculation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@300;500;700&family=Shippori+Mincho:wght@400;600&family=Noto+Sans+JP:wght@300;400;500&family=Noto+Sans+SC:wght@300;400&family=Noto+Sans+Devanagari:wght@300;400&display=swap" rel="stylesheet">
    <style>
        /* --- TOKENS --- */
        :root {
            --c-bg: #020205; --c-accent: #00f0ff; --c-accent-dim: rgba(0, 240, 255, 0.1);
            --c-gold: #D4AF37; --c-card-bg: rgba(12, 18, 30, 0.95); --c-border: rgba(0, 240, 255, 0.3);
            --f-en: 'Rajdhani', sans-serif; --f-jp: 'Noto Sans JP', sans-serif;
            --f-zh: 'Noto Sans SC', sans-serif; --f-hi: 'Noto Sans Devanagari', sans-serif;
            --f-serif: 'Shippori Mincho', serif;
        }
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background-color: var(--c-bg); font-family: var(--f-jp); color: #fff; }
        
        /* LAYOUT */
        #canvas-wrapper { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; pointer-events: none; }
        #app-layer { position: absolute; z-index: 10; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); pointer-events: auto; }
        .brand h1 { 
            font-family: var(--f-serif); font-weight: 600; font-size: 1.8rem; margin: 0; letter-spacing: 0.2em;
            background: linear-gradient(to bottom, #ffffff, #aaccff); -webkit-background-clip: text; color: transparent;
            text-shadow: 0 0 10px rgba(0, 240, 255, 0.3);
        }
        .nav-menu { display: flex; gap: 10px; }
        .nav-btn { background: rgba(0,0,0,0.5); border: 1px solid #334; color: #889; padding: 5px 12px; font-family: var(--f-en); cursor: pointer; transition: 0.3s; font-size: 0.8rem; }
        .nav-btn:hover, .nav-btn.active { border-color: var(--c-accent); color: var(--c-accent); background: rgba(0,240,255,0.1); }

        /* INPUT */
        #input-container {
            position: absolute; top: 50%; right: 5%; transform: translateY(-50%);
            width: 360px; background: rgba(10, 15, 25, 0.9); backdrop-filter: blur(20px);
            border: 1px solid var(--c-accent-dim); border-left: 2px solid var(--c-accent);
            padding: 40px 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            transition: opacity 0.5s; pointer-events: auto; z-index: 20;
        }
        .form-label { display: block; font-family: var(--f-en); font-size: 0.7rem; color: #889; margin-bottom: 5px; letter-spacing: 0.1em; text-transform: uppercase; }
        .form-input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #334; color: #fff; padding: 10px; font-family: var(--f-en); font-size: 1.1rem; outline: none; margin-bottom: 20px; }
        .form-input:focus { border-color: var(--c-accent); }
        select.form-input option { background: #000; color: #fff; }
        .submit-btn { width: 100%; padding: 15px; background: linear-gradient(90deg, transparent, var(--c-accent-dim), transparent); border: 1px solid var(--c-accent); color: var(--c-accent); font-family: 'Cinzel', serif; font-weight: 700; cursor: pointer; transition: 0.3s; letter-spacing: 0.2em; }
        .submit-btn:hover { background: var(--c-accent); color: #000; box-shadow: 0 0 30px var(--c-accent); }

        /* SYNCHRO */
        #synchro-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; pointer-events: none; opacity: 0; transition: opacity 0.5s; background: rgba(0,0,0,0.8);
        }
        .synchro-text { font-family: var(--f-en); font-size: 2rem; color: var(--c-accent); letter-spacing: 0.5em; text-shadow: 0 0 20px var(--c-accent); }

        /* RESULT */
        #result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 3, 5, 0.95); z-index: 30;
            display: flex; flex-direction: column; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.8s; visibility: hidden;
        }
        #result-overlay.active { opacity: 1; pointer-events: auto; visibility: visible; }
        .result-scroll { width: 100%; max-width: 1200px; height: 100%; overflow-y: auto; padding: 40px 20px 120px 20px; }
        .result-scroll::-webkit-scrollbar { width: 6px; }
        .result-scroll::-webkit-scrollbar-thumb { background: #334; border-radius: 3px; }

        /* BIRTH DATE DISPLAY */
        .birth-display { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #334; padding-bottom: 20px; }
        .birth-label { font-family: var(--f-en); font-size: 0.8rem; color: var(--c-accent); letter-spacing: 0.2em; margin-bottom: 5px; }
        .birth-value { font-family: var(--f-en); font-size: 2.5rem; color: #fff; letter-spacing: 0.1em; text-shadow: 0 0 10px rgba(0,240,255,0.3); font-weight: 300; }

        /* DASHBOARD */
        .dashboard-box { border: 1px solid #334455; background: rgba(5, 10, 20, 0.6); border-radius: 8px; padding: 30px; margin-bottom: 40px; }
        .dash-title { font-size: 0.9rem; color: #889; border-bottom: 1px solid #334; padding-bottom: 10px; margin-bottom: 20px; }
        .param-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; }
        .param-item { margin-bottom: 5px; }
        .param-head { display: flex; justify-content: space-between; font-size: 0.85rem; color: #fff; margin-bottom: 5px; }
        .param-bar-bg { width: 100%; height: 4px; background: #223; border-radius: 2px; overflow: hidden; }
        .param-bar-fill { height: 100%; background: var(--c-accent); width: 0%; transition: width 1.5s ease-out; box-shadow: 0 0 8px var(--c-accent); }

        /* STRATEGY */
        .strategy-container { max-width: 900px; margin: 0 auto 50px auto; border-left: 4px solid var(--c-accent); background: linear-gradient(90deg, rgba(0,240,255,0.05), transparent); padding: 30px; }
        .strategy-title { font-family: var(--f-serif); font-size: 1.8rem; margin-bottom: 15px; color: #fff; text-shadow: 0 0 10px rgba(0,240,255,0.3); }
        .strategy-body { font-size: 1.05rem; line-height: 1.9; color: #ddd; text-align: justify; white-space: pre-wrap; }

        /* GRID */
        .grid-header { font-family: 'Cinzel', serif; text-align: center; color: #667; letter-spacing: 0.3em; margin: 40px 0 20px 0; border-top: 1px dashed #334; padding-top: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .info-card { background: var(--c-card-bg); border: 1px solid var(--c-border); border-radius: 4px; padding: 25px; display: flex; flex-direction: column; gap: 12px; }
        .card-head { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
        .card-name { font-size: 1.1rem; color: #fff; font-weight: bold; }
        .card-val { font-family: var(--f-en); font-size: 1rem; color: #ccc; }
        .card-desc { font-size: 0.9rem; line-height: 1.7; color: #ddd; }
        .card-adv { font-size: 0.85rem; color: #9ab; margin-top: auto; padding-top: 12px; border-top: 1px dashed #445; }

        /* PREMIUM GATE (COMING SOON) */
        .premium-gate { margin-top: 80px; padding: 50px 30px; text-align: center; background: radial-gradient(circle, rgba(212, 175, 55, 0.05) 0%, rgba(0,0,0,0) 70%); border: 1px solid rgba(212, 175, 55, 0.3); }
        .premium-gate h3 { color: var(--c-gold); font-size: 1.6rem; margin-bottom: 15px; }
        .premium-btn { 
            background: #111; border: 1px solid #555; color: #777; 
            padding: 15px 40px; font-family: 'Cinzel', serif; 
            cursor: not-allowed; transition: 0.4s; opacity: 0.7;
        }
        .premium-btn:hover { box-shadow: none; border-color: #555; color: #777; }

        #mvp-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 5, 8, 0.98); z-index: 100; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: 1s; visibility: hidden; }
        #mvp-screen.active { opacity: 1; pointer-events: auto; visibility: visible; }
        .mvp-header { text-align: center; padding: 40px 20px 20px 20px; }
        .mvp-title { font-family: 'Cinzel', serif; font-size: 2rem; color: var(--c-gold); letter-spacing: 0.3em; }
        .mvp-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; padding: 40px; max-width: 1200px; margin: 0 auto; width: 100%; overflow-y: auto; }
        .mvp-card { background: rgba(20, 15, 5, 0.8); border: 1px solid var(--c-gold); padding: 30px; display: flex; flex-direction: column; }
        .mvp-label { font-family: 'Cinzel', serif; color: var(--c-gold); font-size: 0.8rem; letter-spacing: 0.2em; margin-bottom: 15px; }
        .mvp-val { font-family: var(--f-serif); font-size: 1.5rem; color: #fff; margin-bottom: 20px; line-height: 1.4; border-bottom:1px solid #334; padding-bottom:10px; }
        .mvp-desc { font-size: 0.9rem; color: #ccc; line-height: 1.8; text-align: justify; }
        .back-btn { position: absolute; top: 20px; right: 20px; color: #666; cursor: pointer; font-size: 2rem; }

        /* FOOTER */
        .action-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #05080c; border-top: 1px solid #334; padding: 15px; display: flex; justify-content: center; gap: 15px; z-index: 30; }
        .action-btn { background: transparent; border: 1px solid #556; color: #889; padding: 10px 30px; cursor: pointer; transition: 0.2s; }
        .action-btn:hover { border-color: var(--c-accent); color: var(--c-accent); }

        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: rgba(2,2,5,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-family:'Shippori Mincho', serif; font-size:2.5rem; letter-spacing:0.2em; background:linear-gradient(to bottom, #fff, #aaccff); -webkit-background-clip:text; color:transparent;" id="t-start-title">å‘¨æœŸå¾‹åˆ†æ</h1>
        <p style="font-family:'Rajdhani'; letter-spacing:0.3em; color:var(--c-accent); margin-bottom:40px;">COSMIC NEURAL NETWORK v10.0 REAL</p>
        <button class="submit-btn" style="width:auto; padding:15px 50px;" onclick="app.init()" id="t-start-btn">INITIALIZE SYSTEM</button>
    </div>

    <div id="canvas-wrapper"></div>

    <div id="app-layer">
        <header>
            <div class="brand"><h1 id="t-header">å‘¨æœŸå¾‹åˆ†æ</h1></div>
            <div class="nav-menu">
                <button class="nav-btn active" onclick="app.setLang('ja', event)">JP</button>
                <button class="nav-btn" onclick="app.setLang('en', event)">EN</button>
                <button class="nav-btn" onclick="app.setLang('zh', event)">ZH</button>
                <button class="nav-btn" onclick="app.setLang('hi', event)">HI</button>
                <button class="nav-btn" onclick="app.audio.toggle()" id="btn-audio">AUDIO</button>
            </div>
        </header>

        <div id="input-container">
            <label class="form-label" id="l-date">Birth Date</label>
            <input type="date" id="inp-date" class="form-input" value="1995-08-08">
            <label class="form-label" id="l-time">Birth Time</label>
            <input type="time" id="inp-time" class="form-input" value="12:00">
            <label class="form-label" id="l-loc">Location</label>
            <select id="inp-city" class="form-input"></select>
            <button class="submit-btn" onclick="app.startSequence()" id="b-analyze">START ANALYSIS</button>
        </div>

        <div id="synchro-overlay">
            <div class="synchro-text" id="t-sync">TUNING...</div>
            <div class="synchro-sub" id="t-sync-sub">Aligning Vectors</div>
        </div>

        <div id="result-overlay">
            <div class="result-scroll" id="capture-target">
                <div class="birth-display">
                    <div class="birth-label" id="l-coord">COSMIC COORDINATE ID</div>
                    <div class="birth-value" id="res-birthdate">----.--.--</div>
                </div>

                <div class="dashboard-box">
                    <div class="dash-title" id="t-dash">Cycle Dashboard</div>
                    <div class="param-grid" id="param-grid"></div>
                </div>
                <div class="strategy-container">
                    <div class="strategy-title" id="st-title">ANALYZING...</div>
                    <div class="strategy-body" id="st-body"></div>
                </div>
                <div class="grid-header" id="t-grid">13 DIMENSIONS</div>
                <div class="grid-container" id="grid-container"></div>
                
                <div class="premium-gate">
                    <h3 id="t-prem-title">THE HIDDEN LAYER</h3>
                    <p id="t-prem-desc">Unlock the deep core analysis.</p>
                    <button class="premium-btn" id="b-prem">COMING SOON</button>
                </div>
            </div>
            <div class="action-bar">
                <button class="action-btn" onclick="app.export()" id="b-save">SAVE</button>
                <button class="action-btn" onclick="app.reset()" id="b-reset">RESET</button>
            </div>
        </div>

        <div id="mvp-screen">
            <span class="back-btn" onclick="app.ui.hideMVP()">Ã—</span>
            <div class="mvp-header"><div class="mvp-title">MVP CORE ANALYSIS</div></div>
            <div class="mvp-grid" id="mvp-grid"></div>
            <div style="text-align:center; padding-bottom:40px;">
                <button class="nav-btn" style="font-size:1rem; padding:15px 40px;" onclick="app.ui.hideMVP()" id="b-back">RETURN</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.js"></script>

    <script>
        /* --- RICH DATA --- */
        const DICT_JA_DETAIL = {
            kyusei:{"ä¸€ç™½æ°´æ˜Ÿ":"æŸ”è»Ÿã§ç§˜å¯†ä¸»ç¾©çš„ãªçŸ¥æ€§æ´¾ã€‚","äºŒé»’åœŸæ˜Ÿ":"åŒ…å®¹åŠ›ã¨ç€å®Ÿãªè‚²æˆèƒ½åŠ›ã€‚","ä¸‰ç¢§æœ¨æ˜Ÿ":"ç¬ç™ºåŠ›ã¨ãƒ‘ã‚¤ã‚ªãƒ‹ã‚¢ç²¾ç¥ã€‚","å››ç·‘æœ¨æ˜Ÿ":"ç¸ã‚’é‹ã¶ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚¿ãƒ¼ã€‚","äº”é»„åœŸæ˜Ÿ":"ç ´å£Šã¨å†ç”Ÿã®ã‚«ãƒªã‚¹ãƒã€‚","å…­ç™½é‡‘æ˜Ÿ":"é«˜æ½”ãªãƒªãƒ¼ãƒ€ãƒ¼ã€‚","ä¸ƒèµ¤é‡‘æ˜Ÿ":"å–œã³ã¨åç©«ã®æ˜Ÿã€‚","å…«ç™½åœŸæ˜Ÿ":"ç¶™æ‰¿ã¨é©æ–°ã‚’è¡Œã†å±±ã€‚","ä¹ç´«ç«æ˜Ÿ":"å…¨ã¦ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹æƒ…ç†±å®¶ã€‚"},
            jukkan:{
                "ç”²(æœ¨)":"å¤§æ¨¹ã€‚å‘ä¸Šå¿ƒãŒå¼·ã„ã€‚",
                "ä¹™(æœ¨)":"è‰èŠ±ã€‚ç’°å¢ƒé©å¿œåŠ›ãŒé«˜ã„ã€‚",
                "ä¸™(ç«)":"å¤ªé™½ã€‚ä¸­å¿ƒã«ãªã‚‹å­˜åœ¨ã€‚",
                "ä¸(ç«)":"ç¯ç«ã€‚é‹­ã„æ´å¯ŸåŠ›ã€‚",
                "æˆŠ(åœŸ)":"å±±å²³ã€‚ä¿¡é ¼ã¨ä¿¡ç”¨ã®å¡Šã€‚",
                "å·±(åœŸ)":"ç”°ç•‘ã€‚äººã‚’è‚²ã¦ã‚‹ã€‚",
                "åºš(é‡‘)":"é‹¼é‰„ã€‚æ”¹é©åŠ›ã«å„ªã‚Œã‚‹ã€‚",
                "è¾›(é‡‘)":"å®çŸ³ã€‚ç¹Šç´°ã§ç¾æ„è­˜ãŒé«˜ã„ã€‚",
                "å£¬(æ°´)":"å¤§æµ·ã€‚ã‚¹ã‚±ãƒ¼ãƒ«ãŒå¤§ãã„ã€‚",
                "ç™¸(æ°´)":"é›¨éœ²ã€‚éš…ã€…ã¾ã§è¡Œãæ¸¡ã‚‹ã€‚"
            }
        };

        const LANG = {
            ja: {
                title: "å‘¨æœŸå¾‹åˆ†æ", start: "ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•", analyze: "è§£æé–‹å§‹",
                date: "ç”Ÿå¹´æœˆæ—¥", time: "å‡ºç”Ÿæ™‚é–“", loc: "å‡ºç”Ÿåœ°", coord: "å®‡å®™åº§æ¨™ID",
                dash: "ã‚ãªãŸã®ç¾åœ¨ä½ç½® (ã‚µã‚¤ã‚¯ãƒ«é€²è¡Œåº¦)", grid: "13æ¬¡å…ƒã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰",
                save: "ç”»åƒä¿å­˜", reset: "ãƒªã‚»ãƒƒãƒˆ", audio: "éŸ³å£°: ON/OFF",
                premT: "æ·±å±¤ãƒ¬ã‚¤ãƒ¤ãƒ¼", premD: "ã“ã®ç¾å®Ÿã¯ã€ã‚ãªãŸãŒç”Ÿã¾ã‚Œã‚‹å‰ã«äº¤ã‚ã—ãŸã€Œå¥‘ç´„ã€ã®çµæœã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚\nãªãœã€ã“ã®æ™‚ä»£ã‚’é¸ã‚“ã ã®ã‹ï¼Ÿ èª°ã¨å‡ºä¼šã†é‹å‘½ãªã®ã‹ï¼Ÿ\n13æ¬¡å…ƒã®ã•ã‚‰ã«å¥¥ã€é­‚ã®é’å†™çœŸï¼ˆãƒ–ãƒ«ãƒ¼ãƒ—ãƒªãƒ³ãƒˆï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã‹ï¼Ÿ", premB: "æº–å‚™ä¸­ (Coming Soon)",
                sync: "æ„è­˜åŒèª¿ä¸­...", syncS: "å®‡å®™ã‚µã‚¤ã‚¯ãƒ«ã¨ãƒ™ã‚¯ãƒˆãƒ«ã‚’èª¿æ•´ã—ã¦ã„ã¾ã™",
                mvp: ["ãƒ“ã‚¸ãƒã‚¹å¥½æ©Ÿ (X-DAY)", "é­‚ã®å¥‘ç´„ (Partner)", "ãƒªã‚¹ã‚¯ç®¡ç† (Void)"],
                stT: ["ç ´å£Šã¨å†ç”Ÿã®ãƒ¯ãƒ«ãƒ„", "è©¦ç·´ã®å©å  (The Crucible)", "å®Œå…¨ãªã‚‹è¿½ã„é¢¨"],
                stB: ["ã‚ãªãŸã®æœ¬è³ªã§ã‚ã‚‹ã€Œç«ã€ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨ã€ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ãƒ©ã‚¤ã‚ªãƒ³ã‚ºã‚²ãƒ¼ãƒˆã®å®‡å®™ç·šãŒå…±é³´ã—ã€é€šå¸¸ã§ã¯ã‚ã‚Šå¾—ãªã„åŒ–å­¦åå¿œã‚’èµ·ã“ã—ã¦ã„ã¾ã™ã€‚\n\nä»Šã¯ãƒ­ã‚¸ãƒƒã‚¯ã‚ˆã‚Šã‚‚ã€Œé•å’Œæ„Ÿã€ã‚’ä¿¡ã˜ã¦ãã ã•ã„ã€‚æ—¢å­˜ã®ãƒ¬ãƒ¼ãƒ«ã‚’ç ´å£Šã—ã€æ–°ã—ã„è»Œé“ã‚’æ•·ãã¹ãã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚ç ´å£Šã¯ææ€–ã§ã¯ãªãã€é€²åŒ–ã®ãŸã‚ã®ç¥ç¥­ã§ã™ã€‚", "æ‹¡å¤§ã—ã‚ˆã†ã¨ã™ã‚‹æœ¨æ˜Ÿã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨ã€å›ºã‚ã‚ˆã†ã¨ã™ã‚‹ã‚ãªãŸã®æ€§è³ªãŒæ‘©æ“¦ã‚’èµ·ã“ã—ã¦ã„ã¾ã™ã€‚\n\nã“ã‚Œã¯æ•…éšœã§ã¯ãªãã€Œé›é€ ã€ã®ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚ä»Šã¯å¤–ã«å‡ºã‚‹ã‚ˆã‚Šã‚‚ã€å†…éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã®åˆ·æ–°ï¼ˆå­¦ç¿’ãƒ»çµ„ç¹”åŒ–ãƒ»å¥‘ç´„ã®è¦‹ç›´ã—ï¼‰ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’é›†ä¸­ã—ã¦ãã ã•ã„ã€‚ã“ã®æ™‚æœŸã«è“„ãˆãŸåŠ›ã¯ã€åŠå¹´å¾Œã«çˆ†ç™ºçš„ãªåˆ©ç›Šã‚’ç”Ÿã¿ã¾ã™ã€‚", "å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå™›ã¿åˆã£ã¦ã„ã¾ã™ã€‚æ°´ï¼ˆçŸ¥æ€§ï¼‰ãŒæœ¨ï¼ˆã‚ãªãŸï¼‰ã‚’è‚²ã¦ã€é¢¨ï¼ˆæ™‚ä»£ï¼‰ãŒãã‚Œã‚’é‹ã¶ã€å®Œç’§ãªå¾ªç’°ã«å…¥ã‚Šã¾ã—ãŸã€‚\n\nã‚ãªãŸãŒæ”¾ã¤çŸ¢ã¯ã€é¢¨ã«ä¹—ã£ã¦æƒ³å®šä»¥ä¸Šã®è·é›¢ã¸å±Šãã¾ã™ã€‚é æ…®ã¯ç½ªã§ã™ã€‚ä»Šã¾ã§æ¸©ã‚ã¦ããŸè¨ˆç”»ã‚’ã€ä»Šã™ãå®Ÿè¡Œã«ç§»ã—ã¦ãã ã•ã„ã€‚å¤±æ•—ã¨ã„ã†æ¦‚å¿µãŒä¸€æ™‚çš„ã«æ¶ˆå¤±ã—ã¦ã„ã¾ã™ã€‚"],
                items: { k:"ä¹æ˜Ÿæ°—å­¦",j:"åå¹²åäºŒæ”¯",jup:"æœ¨æ˜Ÿä½ç½®",sat:"åœŸæ˜Ÿä½ç½®",mars:"ç«æ˜Ÿ",ven:"é‡‘æ˜Ÿ",moon:"æœˆç›¸",gate:"ãƒ©ã‚¤ã‚ªãƒ³ã‚ºã‚²ãƒ¼ãƒˆ",pre:"æ­³å·®é‹å‹•",co:"åº§æ¨™",era:"ä¸‰å…ƒä¹é‹",bag:"å…«å¦",gc:"Gã‚³ãƒ³ã‚¸ãƒ£ãƒ³ã‚¯ã‚·ãƒ§ãƒ³" }
            },
            en: {
                title: "Cosmic Analysis", start: "INITIALIZE SYSTEM", analyze: "START ANALYSIS",
                date: "Birth Date", time: "Birth Time", loc: "Location", coord: "COSMIC COORDINATE ID",
                dash: "Cycle Dashboard", grid: "13 DIMENSION SOURCE",
                save: "SAVE IMAGE", reset: "RESET", audio: "AUDIO",
                premT: "THE HIDDEN LAYER", premD: "This reality might be a result of a contract.\nAccess your soul blueprint?", premB: "Coming Soon",
                sync: "TUNING...", syncS: "Aligning Vectors with Cosmic Cycles",
                mvp: ["Business Timing (X-DAY)", "Soul Contract", "Risk Management (Void)"],
                stT: ["Mutation Waltz", "The Crucible", "Full Awakening"],
                stB: ["Your inner fire resonates with the Lions Gate. Trust intuition over logic.", "Jupiter's expansion clashes with Saturn. Focus on internal systems.", "All parameters aligned. Execute your plan now."],
                items: { k:"Nine Star Ki",j:"Zodiac/Stem",jup:"Jupiter",sat:"Saturn",mars:"Mars",ven:"Venus",moon:"Moon Phase",gate:"Lions Gate",pre:"Precession",co:"Coordinate",era:"Era 9",bag:"Bagua",gc:"G.Conjunction" }
            },
            zh: {
                title: "å‘¨æœŸå¾‹åˆ†æ", start: "ç³»ç»Ÿåˆå§‹åŒ–", analyze: "å¼€å§‹åˆ†æ",
                date: "å‡ºç”Ÿæ—¥æœŸ", time: "å‡ºç”Ÿæ—¶é—´", loc: "å‡ºç”Ÿåœ°ç‚¹", coord: "å®‡å®™åæ ‡ID",
                dash: "å½“å‰å‘¨æœŸä½ç½®", grid: "13ç»´æºä»£ç ",
                save: "ä¿å­˜å›¾ç‰‡", reset: "é‡ç½®", audio: "éŸ³é¢‘",
                premT: "æ·±å±‚é¢†åŸŸ", premD: "ç°å®å¯èƒ½æ˜¯å¥‘çº¦çš„ç»“æœã€‚æ˜¯å¦è®¿é—®çµé­‚è“å›¾ï¼Ÿ", premB: "å³å°†æ¨å‡º",
                sync: "åŒè°ƒä¸­...", syncS: "æ­£åœ¨æ ¡å‡†å®‡å®™å‘¨æœŸå‘é‡",
                mvp: ["å•†ä¸šæ—¶æœº", "çµé­‚å¥‘çº¦", "é£é™©ç®¡ç†"],
                stT: ["ç ´åä¸å†ç”Ÿ", "è¯•ç‚¼çš„ç†”ç‚‰", "å®Œå…¨è§‰é†’"],
                stB: ["æœ¬è´¨ï¼ˆç«ï¼‰ä¸ç‹®å­é—¨å…±é¸£ã€‚ç›¸ä¿¡ç›´è§‰ã€‚", "æœ¨æ˜Ÿæ‰©å¼ ä¸åœŸæ˜Ÿæ‘©æ“¦ã€‚è¿™æ˜¯é”»é€ ã€‚", "å‚æ•°å¯¹é½ã€‚ç«‹å³æ‰§è¡Œã€‚"],
                items: { k:"ä¹æ˜Ÿ",j:"å¹²æ”¯",jup:"æœ¨æ˜Ÿ",sat:"åœŸæ˜Ÿ",mars:"ç«æ˜Ÿ",ven:"é‡‘æ˜Ÿ",moon:"æœˆç›¸",gate:"ç‹®å­é—¨",pre:"å²å·®",co:"åæ ‡",era:"ä¸‰å…ƒä¹è¿",bag:"å…«å¦",gc:"å¤§åˆç›¸" }
            },
            hi: {
                title: "à¤¬à¥à¤°à¤¹à¥à¤®à¤¾à¤‚à¤¡à¥€à¤¯ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£", start: "à¤ªà¥à¤°à¤£à¤¾à¤²à¥€ à¤ªà¥à¤°à¤¾à¤°à¤‚à¤­", analyze: "à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤¶à¥à¤°à¥‚ à¤•à¤°à¥‡à¤‚",
                date: "à¤œà¤¨à¥à¤® à¤¤à¤¿à¤¥à¤¿", time: "à¤œà¤¨à¥à¤® à¤¸à¤®à¤¯", loc: "à¤¸à¥à¤¥à¤¾à¤¨", coord: "à¤¬à¥à¤°à¤¹à¥à¤®à¤¾à¤‚à¤¡à¥€à¤¯ à¤¸à¤®à¤¨à¥à¤µà¤¯ à¤†à¤ˆà¤¡à¥€",
                dash: "à¤šà¤•à¥à¤° à¤¡à¥ˆà¤¶à¤¬à¥‹à¤°à¥à¤¡", grid: "à¥§à¥© à¤†à¤¯à¤¾à¤®à¥€ à¤¸à¥à¤°à¥‹à¤¤",
                save: "à¤›à¤µà¤¿ à¤¸à¤¹à¥‡à¤œà¥‡à¤‚", reset: "à¤°à¥€à¤¸à¥‡à¤Ÿ", audio: "à¤‘à¤¡à¤¿à¤¯à¥‹",
                premT: "à¤›à¤¿à¤ªà¥€ à¤¹à¥à¤ˆ à¤ªà¤°à¤¤", premD: "à¤†à¤¤à¥à¤®à¤¾ à¤•à¥‡ à¤¬à¥à¤²à¥‚à¤ªà¥à¤°à¤¿à¤‚à¤Ÿ à¤¤à¤• à¤ªà¤¹à¥à¤‚à¤šà¥‡à¤‚à¥¤", premB: "à¤œà¤²à¥à¤¦ à¤† à¤°à¤¹à¤¾ à¤¹à¥ˆ",
                sync: "à¤Ÿà¥à¤¯à¥‚à¤¨à¤¿à¤‚à¤—...", syncS: "à¤¬à¥à¤°à¤¹à¥à¤®à¤¾à¤‚à¤¡à¥€à¤¯ à¤šà¤•à¥à¤°à¥‹à¤‚ à¤•à¥‡ à¤¸à¤¾à¤¥ à¤¸à¤‚à¤°à¥‡à¤–à¤£",
                mvp: ["à¤µà¥à¤¯à¤¾à¤ªà¤¾à¤° à¤¸à¤®à¤¯", "à¤†à¤¤à¥à¤®à¤¾ à¤…à¤¨à¥à¤¬à¤‚à¤§", "à¤œà¥‹à¤–à¤¿à¤® à¤ªà¥à¤°à¤¬à¤‚à¤§à¤¨"],
                stT: ["à¤ªà¤°à¤¿à¤µà¤°à¥à¤¤à¤¨ à¤•à¤¾ à¤¨à¥ƒà¤¤à¥à¤¯", "à¤…à¤—à¥à¤¨à¤¿ à¤ªà¤°à¥€à¤•à¥à¤·à¤¾", "à¤ªà¥‚à¤°à¥à¤£ à¤œà¤¾à¤—à¥ƒà¤¤à¤¿"],
                stB: ["à¤†à¤‚à¤¤à¤°à¤¿à¤• à¤…à¤—à¥à¤¨à¤¿ à¤²à¤¾à¤¯à¤‚à¤¸ à¤—à¥‡à¤Ÿ à¤•à¥‡ à¤¸à¤¾à¤¥ à¤—à¥‚à¤‚à¤œ à¤°à¤¹à¥€ à¤¹à¥ˆà¥¤", "à¤¬à¥ƒà¤¹à¤¸à¥à¤ªà¤¤à¤¿ à¤”à¤° à¤¶à¤¨à¤¿ à¤•à¤¾ à¤Ÿà¤•à¤°à¤¾à¤µà¥¤", "à¤¸à¤­à¥€ à¤ªà¥ˆà¤°à¤¾à¤®à¥€à¤Ÿà¤° à¤¸à¤‚à¤°à¥‡à¤–à¤¿à¤¤ à¤¹à¥ˆà¤‚à¥¤"],
                items: { k:"à¤¨à¥Œ à¤¸à¤¿à¤¤à¤¾à¤°à¤¾",j:"à¤°à¤¾à¤¶à¤¿",jup:"à¤¬à¥ƒà¤¹à¤¸à¥à¤ªà¤¤à¤¿",sat:"à¤¶à¤¨à¤¿",mars:"à¤®à¤‚à¤—à¤²",ven:"à¤¶à¥à¤•à¥à¤°",moon:"à¤šà¤‚à¤¦à¥à¤°à¤®à¤¾",gate:"à¤²à¤¾à¤¯à¤‚à¤¸ à¤—à¥‡à¤Ÿ",pre:"à¤…à¤¯à¤¨",co:"à¤¸à¤®à¤¨à¥à¤µà¤¯",era:"à¤¯à¥à¤— 9",bag:"à¤¬à¤—à¥à¤†",gc:"à¤®à¤¹à¤¾à¤¸à¤‚à¤¯à¥‹à¤—" }
            }
        };

        const CITY_DB = {
            "asia": [
                {id:"tokyo",name:"Tokyo (æ±äº¬)",lat:35.6762,lon:139.6503,tz:9},
                {id:"osaka",name:"Osaka (å¤§é˜ª)",lat:34.6937,lon:135.5023,tz:9},
                {id:"seoul",name:"Seoul (ì„œìš¸)",lat:37.5665,lon:126.9780,tz:9},
                {id:"beijing",name:"Beijing (åŒ—äº¬)",lat:39.9042,lon:116.4074,tz:8},
                {id:"delhi",name:"New Delhi (à¤¨à¤ˆ à¤¦à¤¿à¤²à¥à¤²à¥€)",lat:28.6139,lon:77.2090,tz:5.5}
            ],
            "europe": [
                {id:"london",name:"London (UK)",lat:51.5074,lon:-0.1278,tz:0},
                {id:"paris",name:"Paris (FR)",lat:48.8566,lon:2.3522,tz:1},
                {id:"moscow",name:"Moscow (RU)",lat:55.7558,lon:37.6173,tz:3}
            ],
            "americas": [
                {id:"ny",name:"New York (USA)",lat:40.7128,lon:-74.0060,tz:-5},
                {id:"la",name:"Los Angeles (USA)",lat:34.0522,lon:-118.2437,tz:-8},
                {id:"saopaulo",name:"Sao Paulo (BR)",lat:-23.5505,lon:-46.6333,tz:-3}
            ],
            "others": [
                {id:"sydney",name:"Sydney (AU)",lat:-33.8688,lon:151.2093,tz:10},
                {id:"cairo",name:"Cairo (EG)",lat:30.0444,lon:31.2357,tz:2}
            ]
        };

        const CYCLES=[{name:"æœ¨æ˜Ÿ (12y)",days:4333,color:"#D4AF37"},{name:"åœŸæ˜Ÿ (29.5y)",days:10759,color:"#A9A9A9"},{name:"ç«æ˜Ÿ (780d)",days:780,color:"#FF4500"},{name:"é‡‘æ˜Ÿ (584d)",days:584,color:"#FF69B4"},{name:"æœˆç›¸ (29.5d)",days:29.53,color:"#F0F8FF"},{name:"æ­³å·® (26ky)",days:9414075,color:"#8A2BE2"}];

        /* --- VISUAL ENGINE --- */
        class VisualEngine {
            constructor() {
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.FogExp2(0x020205, 0.001);
                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 4000);
                this.camera.position.set(0, 30, 50); this.camera.lookAt(0, 0, 0);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                document.getElementById('canvas-wrapper').appendChild(this.renderer.domElement);
                this.initScene(); this.animate();
            }
            initScene() {
                const g1 = new THREE.DodecahedronGeometry(2.2,0);
                const m1 = new THREE.MeshBasicMaterial({color:0x00ffff, wireframe:true, transparent:true, opacity:0.8});
                this.c1=new THREE.Mesh(g1,m1); this.scene.add(this.c1);
                const g2 = new THREE.IcosahedronGeometry(2.5,0);
                const m2 = new THREE.MeshBasicMaterial({color:0x0088ff, wireframe:true, transparent:true, opacity:0.4});
                this.c2=new THREE.Mesh(g2,m2); this.scene.add(this.c2);
                
                const sG = new THREE.BufferGeometry(); const sP = new Float32Array(15000*3);
                for(let i=0;i<15000*3;i++) sP[i]=(Math.random()-0.5)*2000;
                sG.setAttribute('position',new THREE.BufferAttribute(sP,3));
                this.stars1=new THREE.Points(sG,new THREE.PointsMaterial({color:0x8899aa,size:0.6,transparent:true,opacity:0.7}));
                this.scene.add(this.stars1);

                const bG = new THREE.BufferGeometry(); const bP = new Float32Array(500*3);
                for(let i=0;i<500*3;i++) bP[i]=(Math.random()-0.5)*1800;
                bG.setAttribute('position',new THREE.BufferAttribute(bP,3));
                this.stars2=new THREE.Points(bG,new THREE.PointsMaterial({color:0xffffff,size:1.8,transparent:true,opacity:0.9}));
                this.scene.add(this.stars2);

                this.planets=[];
                const d=[{r:8,s:0.5,sp:0.008},{r:12,s:0.6,sp:0.006},{r:16,s:0.4,sp:0.005},{r:24,s:0.8,sp:0.002},{r:32,s:0.7,sp:0.0015}];
                d.forEach(p=>{
                    const r=new THREE.Mesh(new THREE.RingGeometry(p.r,p.r+0.05,128),new THREE.MeshBasicMaterial({color:0x445566,side:THREE.DoubleSide,opacity:0.2,transparent:true}));
                    r.rotation.x=Math.PI/2; this.scene.add(r);
                    const piv=new THREE.Group();
                    const m=new THREE.Mesh(new THREE.IcosahedronGeometry(p.s,1),new THREE.MeshBasicMaterial({color:0x00f0ff,wireframe:true,transparent:true,opacity:0.7}));
                    m.position.x=p.r; piv.add(m); piv.rotation.y=Math.random()*6;
                    this.scene.add(piv); this.planets.push({p:piv,m:m,s:p.sp});
                });
            }
            animate() {
                requestAnimationFrame(this.animate.bind(this));
                if(!app.isTuning){
                    this.c1.rotation.y+=0.003; this.c2.rotation.y-=0.003;
                    this.stars1.rotation.y+=0.0002; this.stars2.rotation.y+=0.0004;
                } else {
                    this.c1.rotation.y+=0.1; this.c2.rotation.y-=0.1;
                    this.stars1.rotation.y+=0.002; this.stars2.rotation.y+=0.004;
                }
                this.planets.forEach(x=>{x.p.rotation.y+=x.s;x.m.rotation.y+=0.02;});
                this.renderer.render(this.scene,this.camera);
            }
        }

        /* --- LOGIC --- */
        const Astro = {
            getRisshun: function(year) {
                const y = year - 1900;
                const day = Math.floor(3.0 + 0.242194 * y - Math.floor(y / 4));
                return new Date(year, 1, day);
            },

            getKyusei: function(birthDate) {
                const year = birthDate.getFullYear();
                const risshun = this.getRisshun(year);
                const targetYear = birthDate < risshun ? year - 1 : year;
                
                let sum = 0;
                String(targetYear).split('').forEach(n => sum += parseInt(n));
                while(sum > 9) {
                    sum = String(sum).split('').reduce((a,b) => parseInt(a) + parseInt(b), 0);
                }
                let kyusei = 11 - sum;
                if(kyusei > 9) kyusei -= 9;
                if(kyusei <= 0) kyusei += 9;
                
                const names = ["ä¸€ç™½æ°´æ˜Ÿ","äºŒé»’åœŸæ˜Ÿ","ä¸‰ç¢§æœ¨æ˜Ÿ","å››ç·‘æœ¨æ˜Ÿ","äº”é»„åœŸæ˜Ÿ","å…­ç™½é‡‘æ˜Ÿ","ä¸ƒèµ¤é‡‘æ˜Ÿ","å…«ç™½åœŸæ˜Ÿ","ä¹ç´«ç«æ˜Ÿ"];
                return names[kyusei - 1];
            },

            getKanshi: function(birthDate) {
                const year = birthDate.getFullYear();
                const risshun = this.getRisshun(year);
                const targetYear = birthDate < risshun ? year - 1 : year;
                
                const kan = ["åºš","è¾›","å£¬","ç™¸","ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±"];
                const shi = ["ç”³","é…‰","æˆŒ","äº¥","å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª"];
                const kanIdx = targetYear % 10;
                const shiIdx = targetYear % 12;
                
                const gogyoMap = {"åºš":"é‡‘","è¾›":"é‡‘","å£¬":"æ°´","ç™¸":"æ°´","ç”²":"æœ¨","ä¹™":"æœ¨","ä¸™":"ç«","ä¸":"ç«","æˆŠ":"åœŸ","å·±":"åœŸ"};
                
                return {
                    full: kan[kanIdx] + shi[shiIdx],
                    kan: kan[kanIdx],
                    shi: shi[shiIdx],
                    gogyo: gogyoMap[kan[kanIdx]]
                };
            },

            getPlanetPosition: function(birthDate, planet) {
                try {
                    const observer = new Astronomy.Observer(35.6762, 139.6503, 0);
                    let body;
                    
                    switch(planet) {
                        case 'jupiter': body = Astronomy.Body.Jupiter; break;
                        case 'saturn': body = Astronomy.Body.Saturn; break;
                        case 'mars': body = Astronomy.Body.Mars; break;
                        case 'venus': body = Astronomy.Body.Venus; break;
                        case 'moon': body = Astronomy.Body.Moon; break;
                        default: return null;
                    }
                    
                    const equator = Astronomy.Equator(body, birthDate, observer, true, true);
                    const ecliptic = Astronomy.Ecliptic(equator);
                    
                    return this.getZodiacSign(ecliptic.elon);
                } catch(e) {
                    console.error('Planet calculation error:', e);
                    return null;
                }
            },

            getZodiacSign: function(longitude) {
                const signs = [
                    {name:"ç‰¡ç¾Šåº§",en:"Aries"}, {name:"ç‰¡ç‰›åº§",en:"Taurus"}, 
                    {name:"åŒå­åº§",en:"Gemini"}, {name:"èŸ¹åº§",en:"Cancer"},
                    {name:"ç…å­åº§",en:"Leo"}, {name:"ä¹™å¥³åº§",en:"Virgo"},
                    {name:"å¤©ç§¤åº§",en:"Libra"}, {name:"è åº§",en:"Scorpio"},
                    {name:"å°„æ‰‹åº§",en:"Sagittarius"}, {name:"å±±ç¾Šåº§",en:"Capricorn"},
                    {name:"æ°´ç“¶åº§",en:"Aquarius"}, {name:"é­šåº§",en:"Pisces"}
                ];
                
                let lon = longitude;
                while(lon < 0) lon += 360;
                while(lon >= 360) lon -= 360;
                
                const index = Math.floor(lon / 30);
                return signs[index];
            },

            getMoonPhase: function(birthDate) {
                try {
                    const phase = Astronomy.MoonPhase(birthDate);
                    if(phase < 45) return {name:"æ–°æœˆ", phase: phase};
                    if(phase < 135) return {name:"ä¸Šå¼¦", phase: phase};
                    if(phase < 225) return {name:"æº€æœˆ", phase: phase};
                    if(phase < 315) return {name:"ä¸‹å¼¦", phase: phase};
                    return {name:"æ–°æœˆ", phase: phase};
                } catch(e) {
                    return {name:"è¨ˆç®—ä¸­", phase: 0};
                }
            },

            getLionsGate: function(birthDate) {
                const month = birthDate.getMonth() + 1;
                const day = birthDate.getDate();
                
                if(month === 7 && day >= 26) return "Open";
                if(month === 8 && day <= 12) return "Peak";
                return "Closed";
            },

            getSangenKyuun: function(birthDate) {
                const year = birthDate.getFullYear();
                const baseYear = 1864;
                const cycle = Math.floor((year - baseYear) / 20) % 9 + 1;
                const eras = ["ç¬¬ä¸€é‹","ç¬¬äºŒé‹","ç¬¬ä¸‰é‹","ç¬¬å››é‹","ç¬¬äº”é‹","ç¬¬å…­é‹","ç¬¬ä¸ƒé‹","ç¬¬å…«é‹","ç¬¬ä¹é‹"];
                const elements = ["æ°´","åœŸ","æœ¨","æœ¨","åœŸ","é‡‘","é‡‘","åœŸ","ç«"];
                
                return {
                    era: eras[cycle - 1],
                    element: elements[cycle - 1],
                    year: baseYear + Math.floor((year - baseYear) / 20) * 20
                };
            },

            getGreatConjunction: function(birthDate) {
                const year = birthDate.getFullYear();
                const conjunctions = [1842, 1861, 1881, 1901, 1921, 1940, 1961, 1981, 2000, 2020, 2040, 2060];
                
                let lastConj = 1842;
                for(let c of conjunctions) {
                    if(year >= c) lastConj = c;
                    else break;
                }
                
                const element = lastConj >= 2000 ? "é¢¨" : "åœŸ";
                return {element: element, year: lastConj};
            },

            getXDay: y => { let d=new Date(); d.setDate(d.getDate()+(y%30)+5); return d.toLocaleDateString(); },
            getPartner: y => ["Strategist","Innovator","Guardian"][y%3],
            getVoid: y => 2024 + (y%2)*2,
            getStats: (b,d) => { const f=(new Date()-b)/(1000*60*60*24); return{p:Math.floor((f%d)/d*100),c:Math.floor(f/d)+1} }
        };

        /* --- APP CONTROLLER --- */
        const app = {
            lang: 'ja', visual: null, isTuning: false, date: null,
            init: function() {
                try {
                    document.getElementById('start-screen').style.opacity=0;
                    setTimeout(()=>document.getElementById('start-screen').style.display='none',800);
                    this.visual=new VisualEngine(); app.audio.init();
                    const s=document.getElementById('inp-city');
                    Object.keys(CITY_DB).forEach(r=>{
                        const g=document.createElement('optgroup'); g.label=r.toUpperCase();
                        CITY_DB[r].forEach(c=>{let o=document.createElement('option');o.text=c.name;o.value=JSON.stringify(c);g.appendChild(o)});
                        s.appendChild(g);
                    });
                    this.updateText();
                } catch(e) { alert("Init Error: "+e); }
            },
            setLang: function(l, evt) {
                this.lang = l;
                document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
                if(evt && evt.target) evt.target.classList.add('active');
                this.updateText();
                document.body.style.fontFamily = (l==='zh')?'var(--f-zh)':(l==='hi')?'var(--f-hi)':(l==='ja')?'var(--f-jp)':'var(--f-en)';
            },
            updateText: function() {
                const t = LANG[this.lang];
                document.getElementById('t-header').innerText = t.title;
                document.getElementById('t-start-title').innerText = t.title;
                document.getElementById('t-start-btn').innerText = t.start;
                document.getElementById('b-analyze').innerText = t.analyze;
                document.getElementById('l-date').innerText = t.date;
                document.getElementById('l-time').innerText = t.time;
                document.getElementById('l-loc').innerText = t.loc;
                document.getElementById('t-dash').innerText = t.dash;
                document.getElementById('t-grid').innerText = t.grid;
                document.getElementById('t-prem-title').innerText = t.premT;
                document.getElementById('t-prem-desc').innerText = t.premD;
                document.getElementById('b-prem').innerText = t.premB;
                document.getElementById('b-save').innerText = t.save;
                document.getElementById('b-reset').innerText = t.reset;
                document.getElementById('t-sync').innerText = t.sync;
                document.getElementById('t-sync-sub').innerText = t.syncS;
                document.getElementById('l-coord').innerText = t.coord;
            },
            startSequence: function() {
                const d=document.getElementById('inp-date').value; if(!d){alert("Date required");return;}
                this.date=new Date(d);
                document.getElementById('input-container').style.opacity=0;
                document.getElementById('input-container').style.pointerEvents='none';
                app.audio.resume();
                this.isTuning=true; app.audio.ramp();
                document.getElementById('synchro-overlay').style.opacity=1;
                setTimeout(()=>this.analyze(),3000);
            },
            analyze: function() {
                const birthDate = this.date;
                const year = birthDate.getFullYear();
                
                const kyusei = Astro.getKyusei(birthDate);
                const kanshi = Astro.getKanshi(birthDate);
                const jupiter = Astro.getPlanetPosition(birthDate, 'jupiter');
                const saturn = Astro.getPlanetPosition(birthDate, 'saturn');
                const mars = Astro.getPlanetPosition(birthDate, 'mars');
                const venus = Astro.getPlanetPosition(birthDate, 'venus');
                const moonPhase = Astro.getMoonPhase(birthDate);
                const lionsGate = Astro.getLionsGate(birthDate);
                const sangenKyuun = Astro.getSangenKyuun(birthDate);
                const greatConj = Astro.getGreatConjunction(birthDate);
                
                const t = LANG[this.lang];
                
                document.getElementById('res-birthdate').innerText = birthDate.toLocaleDateString().replace(/\//g,'.');

                const typeIdx = year%3;
                document.getElementById('st-title').innerText = t.stT[typeIdx];
                document.getElementById('st-body').innerText = t.stB[typeIdx];
                document.querySelector('.strategy-container').style.borderLeftColor = ["#9D00FF","#ff3366","#D4AF37"][typeIdx];

                const dash = document.getElementById('param-grid'); dash.innerHTML="";
                CYCLES.forEach(c=>{ const s=Astro.getStats(this.date,c.days); dash.innerHTML+=`<div class="param-item"><div class="param-head"><span>${c.name}</span><span>${s.p}%</span></div><div class="param-bar-bg"><div class="param-bar-fill" style="width:${s.p}%;background:${c.color}"></div></div></div>`; });

                const grid = document.getElementById('grid-container'); grid.innerHTML="";
                let items = [];
                
                if(this.lang === 'ja') {
                    const kDesc = DICT_JA_DETAIL.kyusei[kyusei] || "åˆ†æä¸­...";
                    const jDesc = DICT_JA_DETAIL.jukkan[kanshi.kan + "(" + kanshi.gogyo + ")"] || "åˆ†æä¸­...";
                    
                    items = [
                        {t:"ä¹æ˜Ÿæ°—å­¦",v:kyusei,d:kDesc,a:"è©³ç´°ã¯æ·±å±¤åˆ†æã¸"},
                        {t:"åå¹²åäºŒæ”¯",v:kanshi.full + " (" + kanshi.gogyo + ")",d:jDesc,a:"ãƒã‚¤ã‚ªãƒªã‚ºãƒ ã‚’ç¢ºèª"},
                        {t:"æœ¨æ˜Ÿä½ç½®",v:jupiter ? jupiter.name : "è¨ˆç®—ä¸­",d:"æ‹¡å¤§ã¨æˆé•·ã®æ–¹å‘æ€§",a:jupiter ? "ã“ã®åˆ†é‡ã«æ³¨ç›®" : "è¨ˆç®—ä¸­"},
                        {t:"åœŸæ˜Ÿä½ç½®",v:saturn ? saturn.name : "è¨ˆç®—ä¸­",d:"è©¦ç·´ã¨åŸºç›¤ã®å ´æ‰€",a:saturn ? "ã“ã“ã‚’é›ãˆã‚‹" : "è¨ˆç®—ä¸­"},
                        {t:"ç«æ˜Ÿ",v:mars ? mars.name : "è¨ˆç®—ä¸­",d:"æƒ…ç†±ã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®æ³¨ãå…ˆ",a:mars ? "è¡Œå‹•ã®æ–¹å‘" : "è¨ˆç®—ä¸­"},
                        {t:"é‡‘æ˜Ÿ",v:venus ? venus.name : "è¨ˆç®—ä¸­",d:"æ„›ã¨ä¾¡å€¤è¦³ã®å‚¾å‘",a:venus ? "ç¾ã‚’è¦‹å‡ºã™å ´æ‰€" : "è¨ˆç®—ä¸­"},
                        {t:"æœˆç›¸",v:moonPhase.name,d:`ä½ç›¸è§’: ${Math.floor(moonPhase.phase)}åº¦`,a:"æ„Ÿæƒ…ã®ãƒªã‚ºãƒ "},
                        {t:"ãƒ©ã‚¤ã‚ªãƒ³ã‚ºã‚²ãƒ¼ãƒˆ",v:lionsGate,d:"å®‡å®™ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®æµå…¥çŠ¶æ…‹",a:lionsGate==="Open"||lionsGate==="Peak"?"å¤‰å®¹ã®ãƒãƒ£ãƒ³ã‚¹":"é€šå¸¸æœŸ"},
                        {t:"æ­³å·®é‹å‹•",v:"æ°´ç“¶åº§æ™‚ä»£",d:"ç´„2150å¹´ç¶šãæ–‡æ˜ã®å¤§æ ",a:"å€‹ã®ç¢ºç«‹ã¨å…±æœ‰ã®æ™‚ä»£"},
                        {t:"åº§æ¨™",v:`${birthDate.getFullYear()}.${String(birthDate.getMonth()+1).padStart(2,'0')}.${String(birthDate.getDate()).padStart(2,'0')}`,d:"ã‚ãªãŸã®å®‡å®™æ™‚é–“ID",a:"ã“ã®ç¬é–“ã¯äºŒåº¦ã¨æ¥ãªã„"},
                        {t:"ä¸‰å…ƒä¹é‹",v:sangenKyuun.era,d:`${sangenKyuun.element}ã®æ™‚ä»£ï¼ˆ${sangenKyuun.year}å¹´ï½ï¼‰`,a:sangenKyuun.element==="ç«"?"å¯è¦–åŒ–ãŒéµ":"æ™‚ä»£ã®ç‰¹æ€§ã‚’æ´»ç”¨"},
                        {t:"å…«å¦",v:"éœ‡ï¼ˆé›·ï¼‰",d:"å‹•ãã¨ç¬ç™ºåŠ›ã®è±¡å¾´",a:"å³æ–­å³æ±ºãŒå‰"},
                        {t:"Gã‚³ãƒ³ã‚¸ãƒ£ãƒ³ã‚¯ã‚·ãƒ§ãƒ³",v:greatConj.element + "ã®æ™‚ä»£",d:`${greatConj.year}å¹´ã®ä¼šåˆã‹ã‚‰`,a:greatConj.element==="é¢¨"?"æƒ…å ±ã¨å…±æœ‰":"ç‰©è³ªã¨æ‰€æœ‰"}
                    ];
                } else {
                    const it = t.items;
                    items = [
                        {t:it.k,v:kyusei,d:"Character Analysis",a:"Check details"},
                        {t:it.j,v:kanshi.full,d:"Bio-rhythm",a:"Check flow"},
                        {t:it.jup,v:jupiter ? jupiter.en : "Calculating",d:"Expansion",a:"Focus here"},
                        {t:it.sat,v:saturn ? saturn.en : "Calculating",d:"Foundation",a:"Build this"},
                        {t:it.mars,v:mars ? mars.en : "Calculating",d:"Passion",a:"Take action"},
                        {t:it.ven,v:venus ? venus.en : "Calculating",d:"Value",a:"Find beauty"},
                        {t:it.moon,v:moonPhase.name,d:`Phase: ${Math.floor(moonPhase.phase)}Â°`,a:"Emotional rhythm"},
                        {t:it.gate,v:lionsGate,d:"Cosmic energy influx",a:lionsGate==="Open"||lionsGate==="Peak"?"Transformation time":"Normal period"},
                        {t:it.pre,v:"Aquarius Age",d:"Civilization shift",a:"Individuality"},
                        {t:it.co,v:`${birthDate.getFullYear()}.${String(birthDate.getMonth()+1).padStart(2,'0')}.${String(birthDate.getDate()).padStart(2,'0')}`,d:"Time ID",a:"Unique moment"},
                        {t:it.era,v:sangenKyuun.element,d:`Era from ${sangenKyuun.year}`,a:"Use era energy"},
                        {t:it.bag,v:"Thunder",d:"Speed & Action",a:"Quick decision"},
                        {t:it.gc,v:greatConj.element + " Era",d:`From ${greatConj.year}`,a:greatConj.element==="é¢¨"?"Information":"Material"}
                    ];
                }

                items.forEach(i => {
                    grid.innerHTML += `<div class="info-card"><div class="card-head"><span class="card-name">${i.t}</span><span class="card-val">${i.v}</span></div><div class="card-desc">${i.d}</div><div class="card-adv">ğŸ’¡ ${i.a}</div></div>`;
                });

                this.isTuning=false; app.audio.reset();
                document.getElementById('synchro-overlay').style.opacity=0;
                document.getElementById('result-overlay').classList.add('active');
            },
            reset: function() {
                document.getElementById('result-overlay').classList.remove('active'); document.getElementById('mvp-screen').classList.remove('active');
                document.getElementById('input-container').style.opacity=1; document.getElementById('input-container').style.pointerEvents='auto';
            },
            ui: {
                showMVP: function() {},
                hideMVP: function() { document.getElementById('mvp-screen').classList.remove('active'); document.getElementById('result-overlay').classList.add('active'); }
            },
            audio: {
                ctx: null, mute: false, filter: null, g: null,
                init: function() {
                    const AC = window.AudioContext||window.webkitAudioContext; this.ctx=new AC();
                    const b=this.ctx.createBuffer(1,this.ctx.sampleRate*2,this.ctx.sampleRate);
                    const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*0.5;
                    const n=this.ctx.createBufferSource(); n.buffer=b; n.loop=true;
                    this.filter=this.ctx.createBiquadFilter(); this.filter.type='lowpass'; this.filter.frequency.value=100;
                    this.g=this.ctx.createGain(); this.g.gain.value=0.1;
                    n.connect(this.filter); this.filter.connect(this.g); this.g.connect(this.ctx.destination);
                    n.start();
                },
                resume: function() { if(this.ctx && this.ctx.state === 'suspended') this.ctx.resume(); },
                toggle: function() { this.mute=!this.mute; if(this.ctx)this.g.gain.setTargetAtTime(this.mute?0:0.1,this.ctx.currentTime,0.1); },
                ramp: function() { if(this.ctx&&!this.mute)this.filter.frequency.exponentialRampToValueAtTime(800,this.ctx.currentTime+3); },
                reset: function() { if(this.ctx&&!this.mute)this.filter.frequency.exponentialRampToValueAtTime(100,this.ctx.currentTime+1); }
            },
            export: function() { html2canvas(document.getElementById('capture-target'),{backgroundColor:'#020305'}).then(c=>{const a=document.createElement('a');a.href=c.toDataURL();a.download='chart.png';a.click()}).catch(e=>alert("Save Error")) }
        };
    </script>
</body>
</html>
