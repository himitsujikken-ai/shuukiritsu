<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¨æœŸå¾‹åˆ†æ | Cosmic Neural Network v7.1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@300;500;700&family=Shippori+Mincho:wght@400;600&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* --- TOKENS --- */
        :root {
            --c-bg: #020205;
            --c-accent: #00f0ff;
            --c-accent-dim: rgba(0, 240, 255, 0.1);
            --c-gold: #D4AF37;
            --c-card-bg: rgba(12, 18, 30, 0.92);
            --c-border: rgba(0, 240, 255, 0.25);
            --font-main: 'Noto Sans JP', sans-serif;
            --font-serif: 'Shippori Mincho', serif;
            --font-tech: 'Rajdhani', sans-serif;
        }

        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background-color: var(--c-bg); font-family: var(--font-main); color: #fff; }

        /* --- LAYOUT --- */
        #canvas-wrapper { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; pointer-events: none; }
        #app-layer { position: absolute; z-index: 10; width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */
        header { padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); pointer-events: auto; }
        .brand h1 { font-family: var(--font-serif); font-size: 1.5rem; margin: 0; letter-spacing: 0.15em; background: linear-gradient(to right, #fff, #88ccee); -webkit-background-clip: text; color: transparent; }
        .nav-btn { background: rgba(0,0,0,0.5); border: 1px solid #334; color: #889; padding: 5px 15px; font-family: var(--font-tech); cursor: pointer; transition: 0.3s; z-index: 50; }
        .nav-btn:hover { border-color: var(--c-accent); color: var(--c-accent); }

        /* --- INPUT PANEL --- */
        #input-container {
            position: absolute; top: 50%; right: 5%; transform: translateY(-50%);
            width: 340px; background: rgba(10, 15, 25, 0.9); backdrop-filter: blur(20px);
            border: 1px solid var(--c-accent-dim); border-left: 2px solid var(--c-accent);
            padding: 40px 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            transition: opacity 0.5s; pointer-events: auto; z-index: 20;
        }
        .form-label { display: block; font-family: var(--font-tech); font-size: 0.7rem; color: #889; margin-bottom: 5px; letter-spacing: 0.15em; }
        .form-input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #334; color: #fff; padding: 10px; font-family: var(--font-tech); font-size: 1.1rem; outline: none; margin-bottom: 20px; transition: 0.3s; }
        .form-input:focus { border-color: var(--c-accent); background: rgba(0, 20, 30, 0.8); }
        .submit-btn { width: 100%; padding: 15px; background: linear-gradient(90deg, transparent, var(--c-accent-dim), transparent); border: 1px solid var(--c-accent); color: var(--c-accent); font-family: 'Cinzel'; font-weight: 700; cursor: pointer; transition: 0.3s; letter-spacing: 0.2em; }
        .submit-btn:hover { background: var(--c-accent); color: #000; box-shadow: 0 0 30px var(--c-accent); }

        /* --- SYNCHRO OVERLAY --- */
        #synchro-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; pointer-events: none; opacity: 0; transition: opacity 0.5s; background: rgba(0,0,0,0.7);
        }
        .synchro-text { font-family: var(--font-tech); font-size: 2rem; color: var(--c-accent); letter-spacing: 0.5em; text-shadow: 0 0 20px var(--c-accent); }
        .synchro-sub { font-family: var(--font-serif); font-size: 0.9rem; color: #fff; margin-top: 10px; letter-spacing: 0.2em; opacity: 0.8; }

        /* --- RESULT PANEL --- */
        #result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 3, 5, 0.95); z-index: 30;
            display: flex; flex-direction: column; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.8s;
            visibility: hidden; /* Important for click-through when hidden */
        }
        #result-overlay.active { opacity: 1; pointer-events: auto; visibility: visible; }

        .result-scroll { width: 100%; max-width: 1200px; height: 100%; overflow-y: auto; padding: 40px 20px 120px 20px; }
        .result-scroll::-webkit-scrollbar { width: 6px; }
        .result-scroll::-webkit-scrollbar-thumb { background: #334; border-radius: 3px; }

        /* DASHBOARD */
        .dashboard-box { border: 1px solid #334455; background: rgba(5, 10, 20, 0.6); border-radius: 8px; padding: 30px; margin-bottom: 40px; }
        .dash-title { font-size: 0.9rem; color: #8899aa; border-bottom: 1px solid #334; padding-bottom: 10px; margin-bottom: 20px; }
        .param-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; }
        .param-item { margin-bottom: 5px; }
        .param-head { display: flex; justify-content: space-between; font-size: 0.85rem; color: #fff; margin-bottom: 5px; }
        .param-bar-bg { width: 100%; height: 4px; background: #223; border-radius: 2px; overflow: hidden; }
        .param-bar-fill { height: 100%; background: var(--c-accent); width: 0%; transition: width 1.5s ease-out; box-shadow: 0 0 8px var(--c-accent); }
        .param-meta { font-family: var(--font-tech); font-size: 0.7rem; color: #667; margin-top: 3px; display: flex; justify-content: space-between; }

        .strategy-container { max-width: 900px; margin: 0 auto 50px auto; border-left: 4px solid var(--c-accent); background: linear-gradient(90deg, rgba(0,240,255,0.05), transparent); padding: 30px; }
        .strategy-title { font-family: var(--font-serif); font-size: 1.8rem; margin-bottom: 15px; color: #fff; text-shadow: 0 0 10px rgba(0,240,255,0.3); }
        .strategy-type { display: inline-block; font-family: var(--font-tech); color: var(--c-accent); border: 1px solid var(--c-accent); padding: 4px 12px; font-size: 0.8rem; letter-spacing: 0.1em; margin-bottom: 20px; }
        .strategy-body { font-size: 1.05rem; line-height: 1.9; color: #ddd; text-align: justify; white-space: pre-wrap; }

        /* GRID */
        .grid-header { font-family: 'Cinzel'; text-align: center; color: #667; letter-spacing: 0.3em; margin: 40px 0 20px 0; border-top: 1px dashed #334; padding-top: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .info-card { background: var(--c-card-bg); border: 1px solid var(--c-border); border-radius: 4px; padding: 25px; display: flex; flex-direction: column; gap: 12px; transition: transform 0.3s; }
        .info-card:hover { border-color: #fff; transform: translateY(-3px); }
        .card-head { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
        .card-name { font-family: var(--font-serif); font-size: 1.1rem; color: #fff; font-weight: bold; }
        .card-tag { font-size: 0.7rem; background: #112; color: var(--c-accent); border: 1px solid var(--c-accent); padding: 2px 8px; border-radius: 10px; }
        .card-val { font-family: var(--font-tech); font-size: 1rem; color: #ccc; }
        .card-desc { font-size: 0.9rem; line-height: 1.7; color: #ddd; text-align: justify; }
        .card-adv { font-size: 0.85rem; color: #9ab; margin-top: auto; padding-top: 12px; border-top: 1px dashed #445; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; }
        
        /* PREMIUM GATE (Updated Copy) */
        .premium-gate {
            margin-top: 80px; padding: 50px 30px; text-align: center;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.05) 0%, rgba(0,0,0,0) 70%);
            border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 2px;
            position: relative; overflow: hidden;
        }
        .premium-gate::before { content:''; position:absolute; top:0; left:50%; transform:translateX(-50%); width:1px; height:30px; background:var(--c-gold); }
        .premium-gate h3 { font-family: var(--font-serif); color: var(--c-gold); font-size: 1.6rem; margin-bottom: 15px; letter-spacing: 0.1em; }
        .premium-gate p { color: #ccc; margin-bottom: 30px; font-size: 0.95rem; line-height: 1.8; font-family: var(--font-main); }
        .premium-btn {
            background: #000; border: 1px solid var(--c-gold); color: var(--c-gold);
            padding: 18px 40px; font-family: 'Cinzel'; font-size: 1rem; letter-spacing: 0.3em; cursor: pointer;
            transition: 0.4s; position: relative; box-shadow: 0 0 15px rgba(212, 175, 55, 0.1);
        }
        .premium-btn:hover { background: var(--c-gold); color: #000; box-shadow: 0 0 40px var(--c-gold); }

        /* MVP SCREEN */
        #mvp-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 8, 0.98); z-index: 100;
            display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: 1s;
            visibility: hidden;
        }
        #mvp-screen.active { opacity: 1; pointer-events: auto; visibility: visible; }
        
        .mvp-header { text-align: center; padding: 40px; border-bottom: 1px solid var(--c-gold); }
        .mvp-title { font-family: var(--font-serif); color: var(--c-gold); font-size: 2rem; letter-spacing: 0.2em; }
        .mvp-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; padding: 40px; max-width: 1200px; margin: 0 auto; width: 100%; overflow-y: auto; }
        .mvp-card { background: rgba(20, 15, 5, 0.8); border: 1px solid var(--c-gold); padding: 30px; border-radius: 4px; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.5); position: relative; }
        .mvp-label { font-family: 'Cinzel'; color: var(--c-gold); font-size: 0.8rem; letter-spacing: 0.2em; margin-bottom: 15px; }
        .mvp-val { font-family: var(--font-serif); font-size: 1.5rem; color: #fff; margin-bottom: 20px; line-height: 1.4; }
        .mvp-desc { font-size: 0.9rem; color: #ccc; line-height: 1.8; text-align: justify; }
        .back-btn { position: absolute; top: 20px; right: 20px; color: #666; cursor: pointer; font-size: 2rem; transition: 0.3s; }
        .back-btn:hover { color: #fff; }

        /* FOOTER */
        .action-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #05080c; border-top: 1px solid #334; padding: 15px; display: flex; justify-content: center; gap: 15px; z-index: 30; pointer-events: auto; }
        .action-btn { background: transparent; border: 1px solid #556; color: #889; padding: 10px 30px; font-family: var(--font-tech); cursor: pointer; transition: 0.2s; }
        .action-btn:hover { border-color: var(--c-accent); color: var(--c-accent); }

        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: rgba(2,2,5,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-family:'Shippori Mincho'; font-size:2.5rem; color:#fff;">å‘¨æœŸå¾‹åˆ†æ</h1>
        <p style="font-family:'Rajdhani'; letter-spacing:0.3em; color:var(--c-accent); margin-bottom:40px;">COSMIC NEURAL NETWORK v7.1</p>
        <button class="submit-btn" style="width:auto; padding:15px 50px;" onclick="app.init()">INITIALIZE SYSTEM</button>
    </div>

    <div id="canvas-wrapper"></div>

    <div id="app-layer">
        <header>
            <div class="brand"><h1>å‘¨æœŸå¾‹åˆ†æ</h1></div>
            <button class="nav-btn" onclick="app.audio.toggle()" id="btn-audio">AUDIO: ON</button>
        </header>

        <div id="input-container">
            <label class="form-label">Birth Date</label>
            <input type="date" id="inp-date" class="form-input" value="1995-08-08">
            <label class="form-label">Birth Time</label>
            <input type="time" id="inp-time" class="form-input" value="12:00">
            <label class="form-label">Location</label>
            <select id="inp-city" class="form-input"></select>
            <button class="submit-btn" onclick="app.startSequence()">START ANALYSIS</button>
        </div>

        <div id="synchro-overlay">
            <div class="synchro-text" id="sync-text">TUNING...</div>
            <div class="synchro-sub" id="sync-sub">Aligning Vectors with Cosmic Cycles</div>
        </div>

        <div id="result-overlay">
            <div class="result-scroll" id="capture-target">
                <div class="dashboard-box">
                    <div class="dash-title">ã‚ãªãŸã®ç¾åœ¨ä½ç½® (ã‚µã‚¤ã‚¯ãƒ«é€²è¡Œåº¦)</div>
                    <div class="param-grid" id="param-grid"></div>
                </div>

                <div class="strategy-container">
                    <div class="strategy-title" id="st-title">ANALYZING...</div>
                    <div class="strategy-type" id="st-type">CALCULATING VECTOR</div>
                    <div class="strategy-body" id="st-body"></div>
                </div>

                <div class="grid-header">SOURCE CODE: 13 DIMENSIONS</div>
                <div class="grid-container" id="grid-container"></div>

                <div class="premium-gate">
                    <h3>THE HIDDEN LAYER</h3>
                    <p>ã“ã®ç¾å®Ÿã¯ã€ã‚ãªãŸãŒç”Ÿã¾ã‚Œã‚‹å‰ã«äº¤ã‚ã—ãŸã€Œå¥‘ç´„ã€ã®çµæœã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚<br>
                    ãªãœã€ã“ã®æ™‚ä»£ã‚’é¸ã‚“ã ã®ã‹ï¼Ÿ èª°ã¨å‡ºä¼šã†é‹å‘½ãªã®ã‹ï¼Ÿ<br>
                    13æ¬¡å…ƒã®ã•ã‚‰ã«å¥¥ã€é­‚ã®é’å†™çœŸï¼ˆãƒ–ãƒ«ãƒ¼ãƒ—ãƒªãƒ³ãƒˆï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã‹ï¼Ÿ</p>
                    <button class="premium-btn" onclick="app.ui.showMVP()">UNLOCK DEEP CORE</button>
                </div>
            </div>

            <div class="action-bar">
                <button class="action-btn" onclick="app.export()">ğŸ“· SAVE</button>
                <button class="action-btn" onclick="app.reset()">â†º RESET</button>
            </div>
        </div>

        <div id="mvp-screen">
            <span class="back-btn" onclick="app.ui.hideMVP()">Ã—</span>
            <div class="mvp-header">
                <div class="mvp-title">MVP CORE ANALYSIS</div>
                <p style="color:#aaa; letter-spacing:0.2em; margin-top:10px;">AKASHIC RECORD ACCESS</p>
            </div>
            <div class="mvp-grid" id="mvp-grid"></div>
            <div style="text-align:center; padding-bottom:40px;">
                <p style="color:#666; margin-bottom:20px;">Analysis Complete. Full session required for further dimensions.</p>
                <button class="nav-btn">RETURN TO SURFACE</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        /* --- DICTIONARY & LOGIC (UNCHANGED) --- */
        const DICT={kyusei:{"ä¸€ç™½æ°´æ˜Ÿ":{tag:"æ€è€ƒ",desc:"æŸ”è»Ÿã§ç§˜å¯†ä¸»ç¾©çš„ãªçŸ¥æ€§æ´¾ã€‚",advice:"å‚è¬€ã¨ã—ã¦ã®ãƒã‚¸ã‚·ãƒ§ãƒ³ãŒå‰ã€‚"},"äºŒé»’åœŸæ˜Ÿ":{tag:"åŸºç›¤",desc:"åŒ…å®¹åŠ›ã¨ç€å®Ÿãªè‚²æˆèƒ½åŠ›ã€‚",advice:"ã€Œç¶™ç¶šã€ã‚’æ­¦å™¨ã«ã—ã¦ãã ã•ã„ã€‚"},"ä¸‰ç¢§æœ¨æ˜Ÿ":{tag:"åˆå‹•",desc:"ç¬ç™ºåŠ›ã¨ãƒ‘ã‚¤ã‚ªãƒ‹ã‚¢ç²¾ç¥ã€‚",advice:"ã‚¹ã‚¿ãƒ¼ãƒˆãƒ€ãƒƒã‚·ãƒ¥ã¯æœ€å¼·ã€‚"},"å››ç·‘æœ¨æ˜Ÿ":{tag:"èª¿æ•´",desc:"ç¸ã‚’é‹ã¶ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚¿ãƒ¼ã€‚",advice:"å…«æ–¹ç¾äººã«ãªã‚‰ãšçµã‚Šè¾¼ã‚€ã“ã¨ã€‚"},"äº”é»„åœŸæ˜Ÿ":{tag:"å¸ç‹",desc:"ç ´å£Šã¨å†ç”Ÿã®ã‚«ãƒªã‚¹ãƒã€‚",advice:"ç‹¬å–„çš„ã«ãªã‚‰ã¬ã‚ˆã†æ³¨æ„ã€‚"},"å…­ç™½é‡‘æ˜Ÿ":{tag:"æ±ºæ–­",desc:"é«˜æ½”ãªãƒªãƒ¼ãƒ€ãƒ¼ã€‚",advice:"æ­£è«–ã¯äººã‚’å‚·ã¤ã‘ã¾ã™ã€‚å¯›å®¹ã•ã‚’ã€‚"},"ä¸ƒèµ¤é‡‘æ˜Ÿ":{tag:"çµŒæ¸ˆ",desc:"å–œã³ã¨åç©«ã®æ˜Ÿã€‚",advice:"æ¥½ã—ã•ã‚’åç›ŠåŒ–ã™ã‚‹ä»•çµ„ã¿ã‚’ã€‚"},"å…«ç™½åœŸæ˜Ÿ":{tag:"æ”¹é©",desc:"ç¶™æ‰¿ã¨é©æ–°ã‚’è¡Œã†å±±ã€‚",advice:"ä¸€åº¦æ±ºã‚ãŸã‚‰æ­¢ã¾ã‚‰ãªã„çªç ´åŠ›ã€‚"},"ä¹ç´«ç«æ˜Ÿ":{tag:"å…ˆè¦‹",desc:"å…¨ã¦ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹æƒ…ç†±å®¶ã€‚",advice:"ç†±ã—ã‚„ã™ãå†·ã‚ã‚„ã™ã„ç‚¹ã«æ³¨æ„ã€‚"}},jukkan:{"ç”²(æœ¨)":{tag:"æœ¬è³ª",desc:"å¤§æ¨¹ã€‚å‘ä¸Šå¿ƒãŒå¼·ã„ãƒªãƒ¼ãƒ€ãƒ¼ã€‚",advice:"æŸ”è»Ÿæ€§ã‚’æŒã¤ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨çµ„ã‚€ã“ã¨ã€‚"},"ä¹™(æœ¨)":{tag:"æœ¬è³ª",desc:"è‰èŠ±ã€‚ç’°å¢ƒé©å¿œåŠ›ãŒé«˜ã„ã€‚",advice:"çµ„ç¹”ã®åŠ›ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚"},"ä¸™(ç«)":{tag:"æœ¬è³ª",desc:"å¤ªé™½ã€‚ä¸­å¿ƒã«ãªã‚‹å­˜åœ¨ã€‚",advice:"æ°—åˆ†ã®ãƒ ãƒ©ã‚’å‡ºã•ãªã„ã“ã¨ã€‚"},"ä¸(ç«)":{tag:"æœ¬è³ª",desc:"ç¯ç«ã€‚é‹­ã„æ´å¯ŸåŠ›ã€‚",advice:"å°å‡ºã—ã«ã‚¬ã‚¹æŠœãã‚’ã€‚"},"æˆŠ(åœŸ)":{tag:"æœ¬è³ª",desc:"å±±å²³ã€‚ä¿¡é ¼ã¨ä¿¡ç”¨ã®å¡Šã€‚",advice:"ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’è»½ãã€‚"},"å·±(åœŸ)":{tag:"æœ¬è³ª",desc:"ç”°ç•‘ã€‚äººã‚’è‚²ã¦ã‚‹ã€‚",advice:"å°‚é–€æ€§ã‚’æŒã¤ã“ã¨ã€‚"},"åºš(é‡‘)":{tag:"æœ¬è³ª",desc:"é‹¼é‰„ã€‚æ”¹é©åŠ›ã«å„ªã‚Œã‚‹ã€‚",advice:"è©¦ç·´ã‚’æ­“è¿ã›ã‚ˆã€‚"},"è¾›(é‡‘)":{tag:"æœ¬è³ª",desc:"å®çŸ³ã€‚ç¹Šç´°ã§ç¾æ„è­˜ãŒé«˜ã„ã€‚",advice:"è‹¦åŠ´ã¯ç ”ç£¨å‰¤ã€‚"},"å£¬(æ°´)":{tag:"æœ¬è³ª",desc:"å¤§æµ·ã€‚ã‚¹ã‚±ãƒ¼ãƒ«ãŒå¤§ãã„ã€‚",advice:"å ¤é˜²ï¼ˆãƒ«ãƒ¼ãƒ«ï¼‰ã‚’è¨­ã‘ã‚‹ã“ã¨ã€‚"},"ç™¸(æ°´)":{tag:"æœ¬è³ª",desc:"é›¨éœ²ã€‚éš…ã€…ã¾ã§è¡Œãæ¸¡ã‚‹ã€‚",advice:"ç©ã‚‚ã‚Šç©ã‚‚ã£ã¦æ±ºå£Šã›ã¬ã‚ˆã†ã€‚"}}};
        const CITIES=[{name:"Tokyo",tz:9},{name:"New York",tz:-5},{name:"London",tz:0},{name:"Paris",tz:1}];
        const CYCLES=[{name:"æœ¨æ˜Ÿ (12y)",days:4333,color:"#D4AF37"},{name:"åœŸæ˜Ÿ (29.5y)",days:10759,color:"#A9A9A9"},{name:"ç«æ˜Ÿ (780d)",days:780,color:"#FF4500"},{name:"é‡‘æ˜Ÿ (584d)",days:584,color:"#FF69B4"},{name:"æœˆç›¸ (29.5d)",days:29.53,color:"#F0F8FF"},{name:"æ­³å·® (26ky)",days:9414075,color:"#8A2BE2"}];

        /* --- VISUAL ENGINE (DEEP STARS & BUCKYBALL) --- */
        class VisualEngine {
            constructor() {
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.FogExp2(0x020205, 0.001);
                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 4000);
                this.camera.position.set(0, 30, 50); this.camera.lookAt(0, 0, 0);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                document.getElementById('canvas-wrapper').appendChild(this.renderer.domElement);
                this.initScene(); this.animate();
            }
            initScene() {
                // Core
                const g1 = new THREE.DodecahedronGeometry(2.2,0);
                const m1 = new THREE.MeshBasicMaterial({color:0x00ffff, wireframe:true, transparent:true, opacity:0.8});
                this.c1=new THREE.Mesh(g1,m1); this.scene.add(this.c1);
                const g2 = new THREE.IcosahedronGeometry(2.5,0);
                const m2 = new THREE.MeshBasicMaterial({color:0x0088ff, wireframe:true, transparent:true, opacity:0.4});
                this.c2=new THREE.Mesh(g2,m2); this.scene.add(this.c2);
                
                // Layer 1: Deep Stars (Small, Many)
                const sG = new THREE.BufferGeometry(); const sP = new Float32Array(15000*3);
                for(let i=0;i<15000*3;i++) sP[i]=(Math.random()-0.5)*2000;
                sG.setAttribute('position',new THREE.BufferAttribute(sP,3));
                this.stars1=new THREE.Points(sG,new THREE.PointsMaterial({color:0x8899aa,size:0.5,transparent:true,opacity:0.6}));
                this.scene.add(this.stars1);

                // Layer 2: Bright Stars (Large, Few)
                const bG = new THREE.BufferGeometry(); const bP = new Float32Array(500*3);
                for(let i=0;i<500*3;i++) bP[i]=(Math.random()-0.5)*1800;
                bG.setAttribute('position',new THREE.BufferAttribute(bP,3));
                this.stars2=new THREE.Points(bG,new THREE.PointsMaterial({color:0xffffff,size:1.5,transparent:true,opacity:0.9}));
                this.scene.add(this.stars2);

                // Planets (Classic 5)
                this.planets=[];
                const d=[{r:8,s:0.5,sp:0.008},{r:12,s:0.6,sp:0.006},{r:16,s:0.4,sp:0.005},{r:24,s:0.8,sp:0.002},{r:32,s:0.7,sp:0.0015}];
                d.forEach(p=>{
                    const r=new THREE.Mesh(new THREE.RingGeometry(p.r,p.r+0.05,128),new THREE.MeshBasicMaterial({color:0x445566,side:THREE.DoubleSide,opacity:0.2,transparent:true}));
                    r.rotation.x=Math.PI/2; this.scene.add(r);
                    const piv=new THREE.Group();
                    const m=new THREE.Mesh(new THREE.IcosahedronGeometry(p.s,1),new THREE.MeshBasicMaterial({color:0x00f0ff,wireframe:true,transparent:true,opacity:0.7}));
                    m.position.x=p.r; piv.add(m); piv.rotation.y=Math.random()*6;
                    this.scene.add(piv); this.planets.push({p:piv,m:m,s:p.sp});
                });
            }
            animate() {
                requestAnimationFrame(this.animate.bind(this));
                if(!app.isTuning){
                    this.c1.rotation.y+=0.003; this.c2.rotation.y-=0.003;
                    this.stars1.rotation.y+=0.0002; this.stars2.rotation.y+=0.0004;
                } else {
                    this.c1.rotation.y+=0.1; this.c2.rotation.y-=0.1;
                    this.stars1.rotation.y+=0.002; this.stars2.rotation.y+=0.004;
                }
                this.planets.forEach(x=>{x.p.rotation.y+=x.s;x.m.rotation.y+=0.02;});
                this.renderer.render(this.scene,this.camera);
            }
        }

        /* --- LOGIC --- */
        const Astro={getKyusei:y=>{let s=0;String(y).split('').forEach(n=>s+=parseInt(n));while(s>9)s=String(s).split('').reduce((a,b)=>parseInt(a)+parseInt(b),0);let t=11-s;if(t>9)t-=9;if(t===0)t=9;return ["ä¸€ç™½æ°´æ˜Ÿ","äºŒé»’åœŸæ˜Ÿ","ä¸‰ç¢§æœ¨æ˜Ÿ","å››ç·‘æœ¨æ˜Ÿ","äº”é»„åœŸæ˜Ÿ","å…­ç™½é‡‘æ˜Ÿ","ä¸ƒèµ¤é‡‘æ˜Ÿ","å…«ç™½åœŸæ˜Ÿ","ä¹ç´«ç«æ˜Ÿ"][t-1];},getJukkan:y=>["åºš(é‡‘)","è¾›(é‡‘)","å£¬(æ°´)","ç™¸(æ°´)","ç”²(æœ¨)","ä¹™(æœ¨)","ä¸™(ç«)","ä¸(ç«)","æˆŠ(åœŸ)","å·±(åœŸ)"][y%10],getStats:(b,d)=>{const f=(new Date()-b)/(1000*60*60*24);return{p:Math.floor((f%d)/d*100),c:Math.floor(f/d)+1}}};

        /* --- APP CONTROLLER --- */
        const app = {
            visual: null, isTuning: false, date: null,
            init: function() {
                document.getElementById('start-screen').style.opacity = 0;
                setTimeout(()=>document.getElementById('start-screen').style.display='none', 800);
                this.visual = new VisualEngine(); app.audio.init();
                const s = document.getElementById('inp-city');
                CITIES.forEach(c=>{let o=document.createElement('option');o.text=c.name;o.value=JSON.stringify(c);s.add(o)});
            },
            audio: {
                ctx: null, mute: false, noise: null, filter: null,
                init: function() {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AC();
                    // Pink/Brown Noise Generation
                    const bSize = 2 * this.ctx.sampleRate;
                    const noiseBuffer = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate);
                    const output = noiseBuffer.getChannelData(0);
                    for (let i = 0; i < bSize; i++) {
                        const white = Math.random() * 2 - 1;
                        output[i] = (lastOut + (0.02 * white)) / 1.02;
                        lastOut = output[i];
                        output[i] *= 3.5; 
                    }
                    let lastOut = 0;
                    this.noise = this.ctx.createBufferSource();
                    this.noise.buffer = noiseBuffer;
                    this.noise.loop = true;
                    this.filter = this.ctx.createBiquadFilter();
                    this.filter.type = 'lowpass';
                    this.filter.frequency.value = 100; // Deep Space Hum
                    this.gain = this.ctx.createGain();
                    this.gain.gain.value = 0.15;
                    this.noise.connect(this.filter);
                    this.filter.connect(this.gain);
                    this.gain.connect(this.ctx.destination);
                    this.noise.start();
                },
                toggle: function() {
                    this.mute = !this.mute;
                    if(this.ctx) this.gain.gain.setTargetAtTime(this.mute?0:0.15, this.ctx.currentTime, 0.1);
                    document.getElementById('btn-audio').innerText=this.mute?"AUDIO: OFF":"AUDIO: ON";
                },
                ramp: function() { if(!this.ctx||this.mute)return; this.filter.frequency.exponentialRampToValueAtTime(800, this.ctx.currentTime+3); },
                reset: function() { if(!this.ctx||this.mute)return; this.filter.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime+1); }
            },
            startSequence: function() {
                const d = document.getElementById('inp-date').value;
                if(!d) { alert("Please select a valid date."); return; }
                this.date = new Date(d);
                document.getElementById('input-container').style.opacity=0;
                document.getElementById('input-container').style.pointerEvents='none';
                this.isTuning=true; app.audio.ramp();
                document.getElementById('synchro-overlay').style.opacity=1;
                setTimeout(()=>{ this.analyze(); },3000);
            },
            analyze: function() {
                const bd = this.date; const y = bd.getFullYear();
                const k = Astro.getKyusei(y); const j = Astro.getJukkan(y);
                const kData = DICT.kyusei[k]; const jData = DICT.jukkan[j];

                // Dashboard
                const pG = document.getElementById('param-grid'); pG.innerHTML="";
                CYCLES.forEach(c=>{ const s=Astro.getStats(bd,c.days); pG.innerHTML+=`<div class="param-item"><div class="param-head"><span style="color:${c.color}">â— ${c.name}</span><span>${s.p}%</span></div><div class="param-bar-bg"><div class="param-bar-fill" style="width:${s.p}%;background:${c.color}"></div></div><div class="param-meta"><span>Cycle #${s.c}</span><span>${Math.floor(c.days)} days</span></div></div>`; });

                // Strategy Text
                const last = y%10; let st={};
                if([6,7].includes(last)) st={t:"ç ´å£Šã¨å†ç”Ÿã®ãƒ¯ãƒ«ãƒ„",type:"MUTATION",col:"#9D00FF",b:`ã‚ãªãŸã®æœ¬è³ªã§ã‚ã‚‹ã€Œç«ï¼ˆ${j}ï¼‰ã€ã¨ãƒ©ã‚¤ã‚ªãƒ³ã‚ºã‚²ãƒ¼ãƒˆãŒå…±é³´ã—ã€é€šå¸¸ã§ã¯ã‚ã‚Šå¾—ãªã„åŒ–å­¦åå¿œãŒèµ·ãã¦ã„ã¾ã™ã€‚\nä»Šã¯ãƒ­ã‚¸ãƒƒã‚¯ã‚ˆã‚Šã€Œé•å’Œæ„Ÿã€ã‚’ä¿¡ã˜ã¦ãã ã•ã„ã€‚æ—¢å­˜ã®ãƒ¬ãƒ¼ãƒ«ã‚’ç ´å£Šã—ã€æ–°ã—ã„è»Œé“ã‚’æ•·ãã¹ãã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚`};
                else if([0,1,8,9].includes(last)) st={t:"è©¦ç·´ã®å©å  (The Crucible)",type:"CONFLICT",col:"#ff3366",b:`æ‹¡å¤§ã—ã‚ˆã†ã¨ã™ã‚‹æœ¨æ˜Ÿã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨ã€å›ºã‚ã‚ˆã†ã¨ã™ã‚‹ã‚ãªãŸã®æ€§è³ªï¼ˆ${j}ï¼‰ãŒæ‘©æ“¦ã‚’èµ·ã“ã—ã¦ã„ã¾ã™ã€‚\nã“ã‚Œã¯æ•…éšœã§ã¯ãªãã€Œé›é€ ã€ã§ã™ã€‚ä»Šã¯å¤–ã«å‡ºã‚‹ã‚ˆã‚Šã€å†…éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã®åˆ·æ–°ï¼ˆå­¦ç¿’ãƒ»çµ„ç¹”åŒ–ï¼‰ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’é›†ä¸­ã—ã¦ãã ã•ã„ã€‚`};
                else st={t:"å®Œå…¨ãªã‚‹è¿½ã„é¢¨",type:"SYNERGY",col:"#D4AF37",b:`å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå™›ã¿åˆã£ã¦ã„ã¾ã™ã€‚æ°´ï¼ˆçŸ¥æ€§ï¼‰ãŒæœ¨ï¼ˆã‚ãªãŸï¼‰ã‚’è‚²ã¦ã€é¢¨ï¼ˆæ™‚ä»£ï¼‰ãŒé‹ã¶å¾ªç’°ã«å…¥ã‚Šã¾ã—ãŸã€‚\nã‚ãªãŸãŒæ”¾ã¤çŸ¢ã¯ã€é¢¨ã«ä¹—ã£ã¦æƒ³å®šä»¥ä¸Šã®è·é›¢ã¸å±Šãã¾ã™ã€‚é æ…®ã¯ç½ªã§ã™ã€‚ä»Šã™ãå®Ÿè¡Œã«ç§»ã—ã¦ãã ã•ã„ã€‚`};
                
                document.getElementById('st-title').innerText=st.t; document.getElementById('st-type').innerText=st.type; 
                document.getElementById('st-type').style.borderColor=st.col; document.getElementById('st-type').style.color=st.col;
                document.getElementById('st-body').innerText=st.b; document.querySelector('.strategy-container').style.borderLeftColor=st.col;

                // 13 Grid
                const gr = document.getElementById('grid-container'); gr.innerHTML="";
                const items=[{t:"ä¹æ˜Ÿæ°—å­¦",v:k,...kData},{t:"åå¹²åäºŒæ”¯",v:j,...jData},{t:"æœ¨æ˜Ÿä½ç½®",v:"åŒå­åº§",tag:"æ‹¡å¤§",desc:"æƒ…å ±ã¨ç§»å‹•ã®é ˜åŸŸã§ã®ç™ºå±•ã€‚",advice:"ãƒãƒ«ãƒã‚¿ã‚¹ã‚¯æ¨å¥¨ã€‚"},{t:"åœŸæ˜Ÿä½ç½®",v:"é­šåº§",tag:"è©¦ç·´",desc:"ç²¾ç¥çš„åŸºç›¤ã®å†æ§‹ç¯‰ã€‚",advice:"å†…çœã®æ™‚é–“ã‚’ã€‚"},{t:"ç«æ˜Ÿ",v:"Active",tag:"æƒ…ç†±",desc:"è‡ªå·±è¡¨ç¾ã®æ¬²æ±‚ã€‚",advice:"è¡å‹•ã‚’ä½œå“ã¸ã€‚"},{t:"é‡‘æ˜Ÿ",v:"8å¹´å‘¨æœŸ",tag:"ä¾¡å€¤",desc:"é‡‘èãƒ»ç¾æ„è­˜ã®å†è©•ä¾¡ã€‚",advice:"éå»ã®åˆ·æ–°ã€‚"},{t:"æœˆç›¸",v:"29.5æ—¥",tag:"æ„Ÿæƒ…",desc:"å†…é¢ãƒã‚¤ã‚ªãƒªã‚ºãƒ ã€‚",advice:"ç›´æ„Ÿã«å¾“ã†ã“ã¨ã€‚"},{t:"ãƒ©ã‚¤ã‚ªãƒ³ã‚ºã‚²ãƒ¼ãƒˆ",v:"Open",tag:"å®‡å®™ç·š",desc:"é«˜æ¬¡ã‚¨ãƒãƒ«ã‚®ãƒ¼æµå…¥ã€‚",advice:"å¤‰åŒ–ã‚’æã‚Œãªã„ã§ã€‚"},{t:"æ­³å·®é‹å‹•",v:"æ°´ç“¶åº§",tag:"æ–‡æ˜",desc:"è‡ªå¾‹åˆ†æ•£å‹ç¤¾ä¼šã¸ã€‚",advice:"å€‹ã®ç¢ºç«‹ã€‚"},{t:"åº§æ¨™",v:bd.toLocaleDateString(),tag:"åŸç‚¹",desc:"æ™‚é–“åº§æ¨™IDã€‚",advice:"é‹å‘½ã®èµ·ç‚¹ã€‚"},{t:"ä¸‰å…ƒä¹é‹",v:"ç¬¬ä¹é‹",tag:"æ™‚ä»£",desc:"ç«ã®æ™‚ä»£ã€‚",advice:"å¯è¦–åŒ–ãŒéµã€‚"},{t:"å…«å¦",v:"éœ‡",tag:"è¡Œå‹•",desc:"é›·ã®ã‚ˆã†ãªç¬ç™ºåŠ›ã€‚",advice:"å³æ–­å³æ±ºã€‚"},{t:"Gã‚³ãƒ³ã‚¸ãƒ£ãƒ³ã‚¯ã‚·ãƒ§ãƒ³",v:"é¢¨",tag:"å¤‰é©",desc:"ç‰©è³ªã‹ã‚‰æƒ…å ±ã¸ã€‚",advice:"æ‰€æœ‰ã‚ˆã‚Šå…±æœ‰ã€‚"}]
                items.forEach(i=>{ gr.innerHTML+=`<div class="info-card"><div class="card-head"><span class="card-name">${i.t}</span><span class="card-tag" style="border-color:var(--c-accent);color:var(--c-accent)">${i.tag}</span></div><div class="card-val">${i.v}</div><div class="card-desc">${i.desc}</div><div class="card-adv">ğŸ’¡ ${i.advice}</div></div>`});

                this.isTuning=false; app.audio.reset();
                document.getElementById('synchro-overlay').style.opacity=0;
                document.getElementById('result-overlay').classList.add('active');
            },
            ui: {
                showMVP: function() {
                    const t = document.getElementById('sync-text'); const s = document.getElementById('sync-sub');
                    t.innerText = "DEEP DIVING..."; s.innerText = "Accessing Soul Contracts & X-DAY Coordinates";
                    t.style.color = "var(--c-gold)"; t.style.textShadow = "0 0 20px var(--c-gold)";
                    document.getElementById('result-overlay').classList.remove('active');
                    document.getElementById('synchro-overlay').style.opacity = 1; 
                    app.audio.ramp(); app.isTuning = true;
                    setTimeout(() => {
                        app.logic.getMVPResults(app.date);
                        app.isTuning = false; app.audio.reset();
                        document.getElementById('synchro-overlay').style.opacity = 0;
                        document.getElementById('mvp-screen').classList.add('active');
                    }, 2500);
                },
                hideMVP: function() { document.getElementById('mvp-screen').classList.remove('active'); document.getElementById('result-overlay').classList.add('active'); },
                reset: function() {
                    document.getElementById('result-overlay').classList.remove('active'); document.getElementById('mvp-screen').classList.remove('active');
                    const inp = document.getElementById('input-container'); inp.style.opacity=1; inp.style.pointerEvents='auto'; inp.style.display='block';
                    app.isTuning=false; app.audio.reset();
                }
            },
            logic: {
                getMVPResults: function(bd) {
                    const y = bd.getFullYear();
                    const xDay = new Date(); xDay.setDate(xDay.getDate() + (y % 120) + 30);
                    const partner = ["é©å‘½å®¶ (Innovator)", "å‚è¬€ (Strategist)", "è¡¨ç¾è€… (Artist)"][y % 3];
                    const grid = document.getElementById('mvp-grid');
                    grid.innerHTML = `
                        <div class="mvp-card"><div class="mvp-label">01. BUSINESS TIMING</div><div class="mvp-val">X-DAY: ${xDay.toLocaleDateString()}</div><div class="mvp-desc">ã‚ãªãŸã®ãƒã‚¤ã‚ªãƒªã‚ºãƒ ã¨ç¤¾ä¼šçš„æˆåŠŸé‹ãŒäº¤å·®ã™ã‚‹ã€Œçµ¶å¯¾å‰æ—¥ã€ã€‚æ³•äººç™»è¨˜ã€å¤§å‹å¥‘ç´„ã€ãƒªãƒªãƒ¼ã‚¹ã«æœ€é©ãªä¸€ç‚¹ã§ã™ã€‚ã“ã®æ—¥ã«è¡Œå‹•ã™ã‚‹ã“ã¨ã§ã€é€šå¸¸ã®3å€ã®ãƒ¬ãƒãƒ¬ãƒƒã‚¸ãŒæœŸå¾…ã§ãã¾ã™ã€‚</div></div>
                        <div class="mvp-card"><div class="mvp-label">02. SOUL CONTRACT</div><div class="mvp-val">Target: ${partner}</div><div class="mvp-desc">ã‚ãªãŸãŒä»Šä¸–ã§å¥‘ç´„ã‚’çµã‚“ã§ã„ã‚‹ã€Œé­‚ã®ãƒ“ã‚¸ãƒã‚¹ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã€ã®ç‰¹æ€§ã€‚å˜ãªã‚‹ä»²è‰¯ã—ã§ã¯ãªãã€äº’ã„ã®æ¬ è½ã‚’åŸ‹ã‚ã€äº‹æ¥­ã‚’æ‹¡å¤§ã•ã›ã‚‹ãŸã‚ã®æˆ¦ç•¥çš„ç›¸æ€§ã‚’æŒã¤äººç‰©åƒã§ã™ã€‚</div></div>
                        <div class="mvp-card"><div class="mvp-label">03. RISK MANAGEMENT</div><div class="mvp-val">VOID PERIOD: 2 Years</div><div class="mvp-desc">ã„ã‚ã‚†ã‚‹ã€Œå¤©ä¸­æ®ºï¼ˆç©ºäº¡ï¼‰ã€ã®éã”ã—æ–¹æˆ¦ç•¥ã€‚ã“ã®æœŸé–“ã¯ã€Œä¸é‹ã€ã§ã¯ãªãã€Œå……é›»ã¨ç ”ç©¶é–‹ç™ºã€ã®æœŸé–“ã§ã™ã€‚å®ˆã‚Šã‚’å›ºã‚ã€å†…è£½åŒ–ã‚’é€²ã‚ã‚‹ã“ã¨ã§ã€æ˜ã‘ã®å¹´ã«ãƒ­ã‚±ãƒƒãƒˆã‚¹ã‚¿ãƒ¼ãƒˆãŒåˆ‡ã‚Œã¾ã™ã€‚</div></div>
                    `;
                }
            },
            export: function() { html2canvas(document.getElementById('capture-target'),{backgroundColor:'#020305'}).then(c=>{const a=document.createElement('a');a.href=c.toDataURL();a.download='chart.png';a.click()}) }
        };
    </script>
</body>
</html>
